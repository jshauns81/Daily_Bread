@using Daily_Bread.Components.Shared

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#2E3440" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Daily Bread" />
    <meta name="application-name" content="Daily Bread" />
    <meta name="description" content="A family chore tracker that helps kids earn their daily bread" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="msapplication-TileColor" content="#2E3440" />
    <meta name="msapplication-tap-highlight" content="no" />
    <base href="/" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Critical CSS to prevent flash - must be inline and comprehensive -->
    <style>
        html, body {
            background-color: #2E3440;
            color: #ECEFF4;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior-y: contain;
        }
        /* Prevent layout shift during hydration */
        .page {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #2E3440;
        }
        .sidebar {
            background-color: #3B4252;
        }
        main {
            background-color: #2E3440;
            flex: 1;
        }
        /* Safe area insets for notched devices */
        .page {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
    </style>
    
    <!-- Google Fonts - Inter for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons - must use root-relative path for Safari compatibility -->
    <link rel="stylesheet" href="/lib/bootstrap-icons/font/bootstrap-icons.min.css" />
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="@Assets["lib/bootstrap/dist/css/bootstrap.min.css"]" />
    <link rel="stylesheet" href="@Assets["app.css"]" />
    <link rel="stylesheet" href="@Assets["Daily_Bread.styles.css"]" />
    <ImportMap />
    
    <!-- Favicons and Apple Touch Icons -->
    <!-- SVG favicon is preferred for modern browsers (scalable, crisp at any size) -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <!-- Fallback for browsers that don't support SVG favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/web-app-manifest-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/web-app-manifest-512x512.png" />
    
    <!-- Splash screens for iOS -->
    <meta name="apple-mobile-web-app-title" content="Daily Bread">
    <link rel="apple-touch-startup-image" href="/apple-touch-icon.png">
    
    <HeadOutlet />
</head>

<body>
    <CascadingAuthenticationState>
        <Routes />
    </CascadingAuthenticationState>
    <ReconnectModal />
    <script src="@Assets["_framework/blazor.web.js"]"></script>
    
    <!-- Emoji Picker Element - lightweight web component -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registered with scope:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(function() {
                            registration.update();
                        }, 60 * 60 * 1000); // Every hour
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
            
            // Handle service worker updates
            navigator.serviceWorker.addEventListener('controllerchange', function() {
                // New service worker activated, reload for fresh content
                window.location.reload();
            });
        }
        
        // Detect standalone mode (installed PWA)
        window.isRunningStandalone = function() {
            return (window.matchMedia('(display-mode: standalone)').matches) ||
                   (window.navigator.standalone) ||
                   document.referrer.includes('android-app://');
        };
        
        // Add class to body if running as PWA
        if (window.isRunningStandalone()) {
            document.body.classList.add('pwa-standalone');
        }
        
        // Handle iOS status bar
        if (navigator.userAgent.match(/iPhone|iPad|iPod/)) {
            document.body.classList.add('ios-device');
        }
    </script>
</body>

</html>
