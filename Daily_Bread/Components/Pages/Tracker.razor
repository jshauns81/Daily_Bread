@page "/tracker"
@page "/tracker/{DateParam}"
@attribute [Authorize]
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@implements IDisposable

@using System.Security.Claims
@using Daily_Bread.Components.Shared
@using Daily_Bread.Data.Models

@inject IAppStateService AppState
@inject ITrackerService TrackerService
@inject IChildProfileService ProfileService
@inject IDateProvider DateProvider
@inject ILedgerService LedgerService
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Book of Deeds</PageTitle>

@* Confetti celebration when all labors complete *@
<Confetti IsActive="_showConfetti" OnComplete="() => _showConfetti = false" ParticleCount="60" />

<div class="tracker-container">
    <div class="tracker-header">
        <h1>Book of Deeds</h1>

        <div class="tracker-controls">
            <DateNavigator SelectedDate="SelectedDate"
                           SelectedDateChanged="OnDateChanged"
                           Today="Today"
                           AllowPastNavigation="IsParent"
                           AllowFutureNavigation="IsParent" />

            @if (IsParent && _childProfiles.Count > 0)
            {
                <div class="child-filter">
                    <select class="child-filter-select" @bind="_selectedChildUserId" @bind:after="OnChildFilterChanged">
                        <option value="">All Children</option>
                        @foreach (var child in _childProfiles)
                        {
                            <option value="@child.UserId" class="user-name">@child.DisplayName</option>
                        }
                    </select>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(UserId))
        {
            <div class="balance-display">
                <span class="balance-label">Balance:</span>
                <span class="balance-amount @(Balance >= 0 ? "positive" : "")">
                    $@Balance.ToString("F2")
                </span>
            </div>
        }
    </div>

    @if (IsLoading)
    {
        @* Skeleton loader - only for initial load/date changes *@
        <div class="loading-placeholder">
            <div class="skeleton-row"></div>
            <div class="skeleton-row"></div>
            <div class="skeleton-row"></div>
        </div>
    }
    else if (FilteredChoreItems.Count == 0)
    {
        @if (IsParent)
        {
            <EmptyState Type="EmptyStateType.NoChores"
                        Icon="📜"
                        Title="No Labors Scheduled"
                        Message="@GetEmptyMessage()">
                <ActionButton>
                    <a href="/manage-chores" class="btn btn-primary">Create Labors</a>
                </ActionButton>
            </EmptyState>
        }
        else
        {
            <EmptyState Type="EmptyStateType.NoChores"
                        Icon="📜"
                        Title="No Labors Scheduled"
                        Message="@GetEmptyMessage()" />
        }
    }
    else
    {
        @* Mobile Card View *@
        <div class="chore-cards d-md-none">
            @if (IsParent && string.IsNullOrEmpty(_selectedChildUserId) && _childProfiles.Count > 1)
            {
                @* Grouped by child view *@
                @foreach (var group in GroupedChoreItems)
                {
                    <div class="child-group">
                        <button class="child-group-header" @onclick="() => ToggleChildGroup(group.Key)">
                            <span class="child-group-name">@GetChildDisplayName(group.Key)</span>
                            <span class="child-group-count">@group.Value.Count labors</span>
                            <span class="bi @(_collapsedChildren.Contains(group.Key) ? "bi-chevron-down" : "bi-chevron-up")"></span>
                        </button>
                        @if (!_collapsedChildren.Contains(group.Key))
                        {
                            <div class="child-group-items">
                                @foreach (var item in group.Value)
                                {
                                    <TrackerChoreCard Item="item"
                                                      IsDisabled="@(IsCheckboxDisabled(item) || _processingItemId == item.ChoreDefinitionId)"
                                                      ShowAssignee="false"
                                                      ShowActions="IsParent"
                                                      OnToggle="ToggleChore"
                                                      OnApprove="ApproveChore"
                                                      OnSkip="ShowSkipConfirmation"
                                                      OnReset="ResetToPending"
                                                      OnRespondToHelp="ShowHelpResponseModal" />
                                }
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                @foreach (var item in FilteredChoreItems)
                {
                    <TrackerChoreCard Item="item"
                                      IsDisabled="@(IsCheckboxDisabled(item) || _processingItemId == item.ChoreDefinitionId)"
                                      ShowAssignee="@(IsParent && _childProfiles.Count > 1)"
                                      ShowActions="IsParent"
                                      OnToggle="ToggleChore"
                                      OnApprove="ApproveChore"
                                      OnSkip="ShowSkipConfirmation"
                                      OnReset="ResetToPending"
                                      OnRespondToHelp="ShowHelpResponseModal" />
                }
            }
        </div>

        @* Desktop Table View - Redesigned Ledger *@
        <div class="d-none d-md-block">
            @if (IsParent && string.IsNullOrEmpty(_selectedChildUserId) && _childProfiles.Count > 1)
            {
                @* Grouped by child view *@
                @foreach (var group in GroupedChoreItems)
                {
                    <div class="child-group-section">
                        <button class="child-group-header-desktop" @onclick="() => ToggleChildGroup(group.Key)">
                            <span class="child-group-name">@GetChildDisplayName(group.Key)</span>
                            <span class="child-group-stats">
                                <span class="stat-completed">@group.Value.Count(i => i.IsCompleted || i.IsApproved) done</span>
                                <span class="stat-separator">•</span>
                                <span class="stat-pending">@group.Value.Count(i => i.IsPending) pending</span>
                                @if (group.Value.Any(i => i.IsHelp))
                                {
                                    <span class="stat-separator">•</span>
                                    <span class="stat-help">@group.Value.Count(i => i.IsHelp) needs help</span>
                                }
                            </span>
                            <span class="bi @(_collapsedChildren.Contains(group.Key) ? "bi-chevron-down" : "bi-chevron-up") collapse-icon"></span>
                        </button>
                        @if (!_collapsedChildren.Contains(group.Key))
                        {
                            <table class="chore-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Chore</th>
                                        <th>Status</th>
                                        <th>Value</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in group.Value)
                                    {
                                        <TrackerChoreRow Item="item"
                                                         IsDisabled="@(IsCheckboxDisabled(item) || _processingItemId == item.ChoreDefinitionId)"
                                                         ShowAssignee="false"
                                                         ShowActions="IsParent"
                                                         OnToggle="ToggleChore"
                                                         OnApprove="ApproveChore"
                                                         OnMiss="ShowMissConfirmation"
                                                         OnSkip="ShowSkipConfirmation"
                                                         OnReset="ResetToPending"
                                                         OnRespondToHelp="ShowHelpResponseModal" />
                                    }
                                </tbody>
                            </table>
                        }
                    </div>
                }
            }
            else
            {
                <table class="chore-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Chore</th>
                            @if (IsParent && _childProfiles.Count > 1)
                            {
                                <th>Assigned</th>
                            }
                            <th>Status</th>
                            <th>Value</th>
                            @if (IsParent)
                            {
                                <th></th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in FilteredChoreItems)
                        {
                            <TrackerChoreRow Item="item"
                                             IsDisabled="@(IsCheckboxDisabled(item) || _processingItemId == item.ChoreDefinitionId)"
                                             ShowAssignee="@(IsParent && _childProfiles.Count > 1)"
                                             ShowActions="IsParent"
                                             OnToggle="ToggleChore"
                                             OnApprove="ApproveChore"
                                             OnMiss="ShowMissConfirmation"
                                             OnSkip="ShowSkipConfirmation"
                                             OnReset="ResetToPending"
                                             OnRespondToHelp="ShowHelpResponseModal" />
                        }
                    </tbody>
                </table>
            }
        </div>

        <TrackerSummary Items="FilteredChoreItems" />
    }
</div>

@* Confirmation Modal for "Mark Undone" *@
@if (_showMissConfirmation && _confirmingItem != null)
{
    <ConfirmationModal 
        Title="Mark Labor as Not Completed"
        Icon="❌"
        Message="@($"Mark '{_confirmingItem.ChoreName}' as not completed?")"
        Consequences="@GetMissConsequences()"
        ConfirmText="Mark Undone"
        Variant="warning"
        IsProcessing="_isProcessingAction"
        OnConfirm="ConfirmMarkMissed"
        OnCancel="CloseConfirmationModals" />
}

@* Confirmation Modal for "Excuse/Skip" *@
@if (_showSkipConfirmation && _confirmingItem != null)
{
    <ConfirmationModal 
        Title="Excuse Labor for Today"
        Icon="🙏"
        Message="@($"Grant dispensation for '{_confirmingItem.ChoreName}'?")"
        Consequences="@(["No penalty will be applied", "No earning for this chore today", "This can be undone later"])"
        ConfirmText="Grant Dispensation"
        Variant="default"
        IsProcessing="_isProcessingAction"
        OnConfirm="ConfirmMarkSkipped"
        OnCancel="CloseConfirmationModals" />
}

@* Help Response Modal *@
@if (_showHelpResponseModal && _helpRequestItem != null)
{
    <HelpResponseModal 
        ChildName="@(_helpRequestItem.AssignedUserName ?? "Child")"
        ChoreName="@_helpRequestItem.ChoreName"
        Reason="@_helpRequestItem.HelpReason"
        RequestedAt="@_helpRequestItem.HelpRequestedAt"
        EarnValue="@_helpRequestItem.EarnValue"
        IsProcessing="_isProcessingAction"
        OnSubmit="HandleHelpResponse"
        OnCancel="CloseConfirmationModals" />
}

@code {
    [Parameter]
    public string? DateParam { get; set; }

    private List<TrackerChoreItem> ChoreItems { get; set; } = [];
    private DateOnly SelectedDate { get; set; }
    private DateOnly Today => DateProvider.Today;
    private bool IsToday => SelectedDate == Today;
    private bool IsLoading { get; set; } = true;

    private string? UserId { get; set; }
    private bool IsParent { get; set; }
    private decimal Balance { get; set; }

    private List<ChildProfileSummary> _childProfiles = [];
    private string? _selectedChildUserId;
    private HashSet<string> _collapsedChildren = [];

    private List<TrackerChoreItem> FilteredChoreItems => string.IsNullOrEmpty(_selectedChildUserId)
        ? ChoreItems
        : ChoreItems.Where(c => c.AssignedUserId == _selectedChildUserId).ToList();

    private Dictionary<string, List<TrackerChoreItem>> GroupedChoreItems => ChoreItems
        .Where(c => !string.IsNullOrEmpty(c.AssignedUserId))
        .GroupBy(c => c.AssignedUserId!)
        .ToDictionary(g => g.Key, g => g.ToList());

    private bool _showConfetti;
    private int _previousCompletedCount;
    private int? _processingItemId;
    
    private bool _showMissConfirmation;
    private bool _showSkipConfirmation;
    private bool _showHelpResponseModal;
    private TrackerChoreItem? _confirmingItem;
    private TrackerChoreItem? _helpRequestItem;
    private bool _isProcessingAction;

    private CancellationTokenSource? _loadCts;
    private readonly object _loadLock = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        UserId = user.FindFirstValue(ClaimTypes.NameIdentifier);
        IsParent = user.IsInRole("Parent");

        if (!string.IsNullOrEmpty(DateParam) && DateOnly.TryParse(DateParam, out var parsedDate))
        {
            SelectedDate = parsedDate;
        }
        else
        {
            SelectedDate = Today;
        }

        if (IsParent)
        {
            _childProfiles = await ProfileService.GetAllChildProfilesAsync();
        }

        AppState.OnTrackerChanged += OnTrackerStateChanged;
        AppState.OnChildDashboardChanged += OnChildDashboardStateChanged;
        if (IsParent)
        {
            AppState.OnParentDashboardChanged += OnParentDashboardStateChanged;
        }

        await LoadDataAsync();
    }

    private string GetChildDisplayName(string userId)
    {
        return _childProfiles.FirstOrDefault(c => c.UserId == userId)?.DisplayName ?? "Unknown";
    }

    private void ToggleChildGroup(string userId)
    {
        if (_collapsedChildren.Contains(userId))
            _collapsedChildren.Remove(userId);
        else
            _collapsedChildren.Add(userId);
    }

    private async Task OnChildFilterChanged()
    {
        await Task.CompletedTask;
        StateHasChanged();
    }

    private async void OnTrackerStateChanged()
    {
        await InvokeAsync(async () =>
        {
            await RefreshDataAsync();
            StateHasChanged();
        });
    }

    private async void OnChildDashboardStateChanged()
    {
        if (!IsParent)
        {
            await InvokeAsync(async () =>
            {
                await RefreshDataAsync();
                StateHasChanged();
            });
        }
    }

    private async void OnParentDashboardStateChanged()
    {
        if (IsParent)
        {
            await InvokeAsync(async () =>
            {
                await RefreshDataAsync();
                StateHasChanged();
            });
        }
    }

    private async Task OnDateChanged(DateOnly newDate)
    {
        SelectedDate = newDate;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        CancellationToken ct;
        lock (_loadLock)
        {
            _loadCts?.Cancel();
            _loadCts?.Dispose();
            _loadCts = new CancellationTokenSource();
            ct = _loadCts.Token;
        }

        var loadingForDate = SelectedDate;
        IsLoading = true;
        StateHasChanged();

        var previousCount = ChoreItems.Count(c => c.IsCompleted);

        try
        {
            ct.ThrowIfCancellationRequested();

            List<TrackerChoreItem> items;
            decimal balance = 0;

            if (IsParent)
            {
                items = await TrackerService.GetTrackerItemsForDateAsync(loadingForDate);
            }
            else if (!string.IsNullOrEmpty(UserId))
            {
                items = await TrackerService.GetTrackerItemsForUserOnDateAsync(UserId, loadingForDate);
            }
            else
            {
                items = [];
            }

            ct.ThrowIfCancellationRequested();

            if (loadingForDate != SelectedDate)
            {
                return;
            }

            if (!string.IsNullOrEmpty(UserId))
            {
                balance = await LedgerService.GetUserBalanceAsync(UserId);
            }

            ct.ThrowIfCancellationRequested();

            ChoreItems = items;
            Balance = balance;

            var currentCompleted = ChoreItems.Count(c => c.IsCompleted);
            var totalChores = ChoreItems.Count;

            if (totalChores > 0 && currentCompleted == totalChores && previousCount < totalChores && _previousCompletedCount < totalChores)
            {
                _showConfetti = true;
            }

            _previousCompletedCount = currentCompleted;
        }
        catch (OperationCanceledException)
        {
            return;
        }
        catch (Exception ex)
        {
            if (!ct.IsCancellationRequested)
            {
                ToastService.ShowError("Error", $"Failed to load chores: {ex.Message}");
            }
        }
        finally
        {
            if (!ct.IsCancellationRequested)
            {
                IsLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task RefreshDataAsync()
    {
        try
        {
            List<TrackerChoreItem> items;
            decimal balance = 0;

            if (IsParent)
            {
                items = await TrackerService.GetTrackerItemsForDateAsync(SelectedDate);
            }
            else if (!string.IsNullOrEmpty(UserId))
            {
                items = await TrackerService.GetTrackerItemsForUserOnDateAsync(UserId, SelectedDate);
            }
            else
            {
                items = [];
            }

            if (!string.IsNullOrEmpty(UserId))
            {
                balance = await LedgerService.GetUserBalanceAsync(UserId);
            }

            var previousCount = _previousCompletedCount;
            ChoreItems = items;
            Balance = balance;

            var currentCompleted = ChoreItems.Count(c => c.IsCompleted);
            var totalChores = ChoreItems.Count;

            if (totalChores > 0 && currentCompleted == totalChores && previousCount < totalChores)
            {
                _showConfetti = true;
            }

            _previousCompletedCount = currentCompleted;
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", $"Failed to refresh: {ex.Message}");
        }
    }

    private string GetEmptyMessage()
    {
        if (IsToday)
            return "There are no labors scheduled for today.";
        return $"There are no labors scheduled for {SelectedDate:MMMM d}.";
    }

    private async Task ToggleChore(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId)) return;
        if (_processingItemId.HasValue) return;

        _processingItemId = item.ChoreDefinitionId;
        StateHasChanged();

        try
        {
            var result = await TrackerService.ToggleChoreCompletionAsync(item.ChoreDefinitionId, SelectedDate, UserId, IsParent);

            if (result.Success)
            {
                var newStatus = result.Data;
                
                if (newStatus == ChoreStatus.Approved || newStatus == ChoreStatus.Completed)
                {
                    var message = item.EarnValue > 0 
                        ? $"'{item.ChoreName}' +${item.EarnValue:F2}" 
                        : $"'{item.ChoreName}' marked as complete.";
                    ToastService.ShowSuccess("Done!", message);
                }
                else if (newStatus == ChoreStatus.Pending)
                {
                    ToastService.ShowInfo("Undone", $"'{item.ChoreName}' has been reset.");
                }
                else
                {
                    ToastService.ShowInfo("Updated", $"'{item.ChoreName}' status changed.");
                }
                
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
            }
        }
        finally
        {
            _processingItemId = null;
            StateHasChanged();
        }
    }

    private async Task ApproveChore(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;
        if (_processingItemId.HasValue) return;

        _processingItemId = item.ChoreDefinitionId;
        StateHasChanged();

        try
        {
            var result = await TrackerService.SetChoreStatusAsync(item.ChoreDefinitionId, SelectedDate, ChoreStatus.Approved, UserId);

            if (result.Success)
            {
                ToastService.ShowSuccess("Approved!", $"'{item.ChoreName}' approved - ${item.Value:F2} wages earned!");
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to approve labor.");
            }
        }
        finally
        {
            _processingItemId = null;
            StateHasChanged();
        }
    }

    private void ShowMissConfirmation(TrackerChoreItem item)
    {
        _confirmingItem = item;
        _showMissConfirmation = true;
    }
    
    private List<string> GetMissConsequences()
    {
        var consequences = new List<string> { "Labor will be recorded as not completed" };
        
        if (_confirmingItem?.PenaltyValue > 0)
        {
            consequences.Add($"A ${_confirmingItem.PenaltyValue:F2} penalty may apply");
        }
        
        consequences.Add("This can be undone later");
        return consequences;
    }

    private async Task ConfirmMarkMissed()
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent || _confirmingItem == null) return;

        _isProcessingAction = true;
        
        try
        {
            var result = await TrackerService.MarkChoreMissedAsync(_confirmingItem.ChoreDefinitionId, SelectedDate, UserId);

            if (result.Success)
            {
                ToastService.ShowWarning("Marked Undone", $"'{_confirmingItem.ChoreName}' marked as not completed.");
                CloseConfirmationModals();
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
            }
        }
        finally
        {
            _isProcessingAction = false;
        }
    }

    private void ShowSkipConfirmation(TrackerChoreItem item)
    {
        _confirmingItem = item;
        _showSkipConfirmation = true;
    }

    private async Task ConfirmMarkSkipped()
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent || _confirmingItem == null) return;

        _isProcessingAction = true;
        
        try
        {
            var result = await TrackerService.MarkChoreSkippedAsync(_confirmingItem.ChoreDefinitionId, SelectedDate, UserId);

            if (result.Success)
            {
                ToastService.ShowInfo("Excused", $"'{_confirmingItem.ChoreName}' excused for today.");
                CloseConfirmationModals();
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
            }
        }
        finally
        {
            _isProcessingAction = false;
        }
    }

    private void ShowHelpResponseModal(TrackerChoreItem item)
    {
        _helpRequestItem = item;
        _showHelpResponseModal = true;
    }

    private async Task HandleHelpResponse((HelpResponse Response, string? Note) args)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent || _helpRequestItem?.ChoreLogId == null) return;

        _isProcessingAction = true;
        
        try
        {
            var result = await TrackerService.RespondToHelpRequestAsync(_helpRequestItem.ChoreLogId.Value, UserId, args.Response, args.Note);

            if (result.Success)
            {
                var choreName = _helpRequestItem.ChoreName;
                var message = args.Response switch
                {
                    HelpResponse.CompletedByParent => $"'{choreName}' fulfilled and approved!",
                    HelpResponse.Excused => $"'{choreName}' excused for today.",
                    HelpResponse.Denied => $"'{choreName}' reset - they'll need to try again.",
                    _ => "Help request resolved."
                };
                
                if (args.Response == HelpResponse.CompletedByParent)
                    ToastService.ShowSuccess("Resolved!", message);
                else
                    ToastService.ShowInfo("Resolved", message);
                    
                CloseConfirmationModals();
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to respond to help request.");
            }
        }
        finally
        {
            _isProcessingAction = false;
        }
    }

    private async Task ResetToPending(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;
        if (_processingItemId.HasValue) return;

        _processingItemId = item.ChoreDefinitionId;
        StateHasChanged();

        try
        {
            var result = await TrackerService.ResetChoreToPendingAsync(item.ChoreDefinitionId, SelectedDate, UserId);

            if (result.Success)
            {
                ToastService.ShowInfo("Restored", $"'{item.ChoreName}' restored to pending.");
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to reset chore.");
            }
        }
        finally
        {
            _processingItemId = null;
            StateHasChanged();
        }
    }
    
    private void CloseConfirmationModals()
    {
        _showMissConfirmation = false;
        _showSkipConfirmation = false;
        _showHelpResponseModal = false;
        _confirmingItem = null;
        _helpRequestItem = null;
    }

    private bool IsCheckboxDisabled(TrackerChoreItem item)
    {
        if (IsParent) return false;
        if (!IsToday) return true;
        if (item.Status == ChoreStatus.Approved) return true;
        if (item.Status == ChoreStatus.Missed) return true;
        if (item.Status == ChoreStatus.Skipped) return true;
        return false;
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        
        AppState.OnTrackerChanged -= OnTrackerStateChanged;
        AppState.OnChildDashboardChanged -= OnChildDashboardStateChanged;
        if (IsParent)
        {
            AppState.OnParentDashboardChanged -= OnParentDashboardStateChanged;
        }
    }
}
