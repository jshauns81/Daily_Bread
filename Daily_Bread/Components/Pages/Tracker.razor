@page "/tracker"
@page "/tracker/{DateParam}"
@attribute [Authorize]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@using System.Security.Claims

@inject ITrackerService TrackerService
@inject IDateProvider DateProvider
@inject ILedgerService LedgerService
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Chore Tracker</PageTitle>

<div class="tracker-container">
    <div class="tracker-header">
        <h1>Chore Tracker</h1>
        
        <div class="date-navigation">
            <button class="btn btn-outline-secondary" @onclick="GoToPreviousDay" disabled="@(!IsParent && !IsToday)">
                <span class="bi bi-chevron-left"></span> Previous
            </button>
            
            <div class="current-date">
                <span class="date-display">@SelectedDate.ToString("dddd, MMMM d, yyyy")</span>
                @if (IsToday)
                {
                    <span class="badge bg-primary ms-2">Today</span>
                }
            </div>
            
            <button class="btn btn-outline-secondary" @onclick="GoToNextDay" disabled="@(!IsParent && SelectedDate >= Today)">
                Next <span class="bi bi-chevron-right"></span>
            </button>
            
            @if (!IsToday)
            {
                <button class="btn btn-outline-primary ms-2" @onclick="GoToToday">
                    Go to Today
                </button>
            }
        </div>

        @if (!string.IsNullOrEmpty(UserId))
        {
            <div class="balance-display mt-2">
                <span class="fw-bold">Balance:</span>
                <span class="@(Balance >= 0 ? "text-success" : "text-danger") fs-5">
                    $@Balance.ToString("F2")
                </span>
            </div>
        }
    </div>

    @if (IsLoading)
    {
        @* Skeleton loader for table *@
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th><Skeleton Type="SkeletonType.Text" Width="40px" /></th>
                        <th><Skeleton Type="SkeletonType.Text" Width="120px" /></th>
                        @if (IsParent)
                        {
                            <th><Skeleton Type="SkeletonType.Text" Width="100px" /></th>
                        }
                        <th><Skeleton Type="SkeletonType.Text" Width="60px" /></th>
                        <th><Skeleton Type="SkeletonType.Text" Width="80px" /></th>
                        @if (IsParent)
                        {
                            <th><Skeleton Type="SkeletonType.Text" Width="120px" /></th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < 5; i++)
                    {
                        <Skeleton Type="SkeletonType.TableRow" Columns="@(IsParent ? 6 : 4)" />
                    }
                </tbody>
            </table>
        </div>
    }
    else if (ChoreItems.Count == 0)
    {
        @if (IsParent)
        {
            <EmptyState Type="EmptyStateType.NoChores" 
                        Icon="??"
                        Title="No Chores Scheduled"
                        Message="@GetEmptyMessage()">
                <ActionButton>
                    <a href="/manage-chores" class="btn btn-primary">Create Chores</a>
                </ActionButton>
            </EmptyState>
        }
        else
        {
            <EmptyState Type="EmptyStateType.NoChores" 
                        Icon="??"
                        Title="No Chores Scheduled"
                        Message="@GetEmptyMessage()" />
        }
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover chore-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50px;">Done</th>
                        <th>Chore</th>
                        @if (IsParent)
                        {
                            <th>Assigned To</th>
                        }
                        <th style="width: 100px;" class="text-center">Value</th>
                        <th style="width: 180px;" class="text-center">Status</th>
                        @if (IsParent)
                        {
                            <th style="width: 200px;" class="text-center">Actions</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ChoreItems)
                    {
                        <tr class="@GetRowClass(item)">
                            <td class="text-center">
                                <input type="checkbox"
                                       class="form-check-input chore-checkbox"
                                       checked="@item.IsCompleted"
                                       disabled="@IsCheckboxDisabled(item)"
                                       @onchange="() => ToggleChore(item)" />
                            </td>
                            <td>
                                <span class="chore-name @(item.IsCompleted ? "completed" : "")">
                                    @item.ChoreName
                                </span>
                                @if (!string.IsNullOrEmpty(item.Description))
                                {
                                    <br />
                                    <small class="text-muted">@item.Description</small>
                                }
                            </td>
                            @if (IsParent)
                            {
                                <td>
                                    @(item.AssignedUserName ?? "Unassigned")
                                </td>
                            }
                            <td class="text-center">
                                <span class="value-badge @(item.IsMissed ? "text-danger" : "")">
                                    @(item.IsMissed ? "-" : "")$@item.Value.ToString("F2")
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge @GetStatusBadgeClass(item.Status)">
                                    @GetStatusDisplay(item.Status)
                                </span>
                                @if (item.IsApproved && !string.IsNullOrEmpty(item.ApprovedByUserName))
                                {
                                    <br />
                                    <small class="text-muted">
                                        by @item.ApprovedByUserName
                                        @if (item.ApprovedAt.HasValue)
                                        {
                                            <span> - @GetTimeAgo(item.ApprovedAt.Value)</span>
                                        }
                                    </small>
                                }
                            </td>
                            @if (IsParent)
                            {
                                <td class="text-center">
                                    <div class="action-buttons">
                                        @if (item.Status == ChoreStatus.Completed)
                                        {
                                            <button class="btn btn-success btn-sm" 
                                                    @onclick="() => ApproveChore(item)"
                                                    title="Approve">
                                                Approve
                                            </button>
                                        }
                                        @if (item.Status == ChoreStatus.Pending)
                                        {
                                            <button class="btn btn-outline-danger btn-sm"
                                                    @onclick="() => MarkMissed(item)"
                                                    title="Mark as Missed">
                                                Miss
                                            </button>
                                            <button class="btn btn-outline-info btn-sm"
                                                    @onclick="() => MarkSkipped(item)"
                                                    title="Mark as Skipped">
                                                Skip
                                            </button>
                                        }
                                        @if (item.Status == ChoreStatus.Completed || item.Status == ChoreStatus.Approved)
                                        {
                                            <button class="btn btn-outline-danger btn-sm"
                                                    @onclick="() => MarkMissed(item)"
                                                    title="Mark as Missed">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        }
                                        @if (item.Status == ChoreStatus.Missed || item.Status == ChoreStatus.Skipped)
                                        {
                                            <button class="btn btn-outline-info btn-sm"
                                                    @onclick="() => ResetToPending(item)"
                                                    title="Reset to Pending">
                                                Reset
                                            </button>
                                        }
                                    </div>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="tracker-summary mt-3">
            <div class="row g-3">
                <div class="col-md-3 col-6">
                    <div class="summary-card">
                        <span class="summary-value">@ChoreItems.Count</span>
                        <span class="summary-label">Total Chores</span>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="summary-card">
                        <span class="summary-value text-success">@ChoreItems.Count(c => c.IsCompleted)</span>
                        <span class="summary-label">Completed</span>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="summary-card">
                        <span class="summary-value text-warning">@ChoreItems.Count(c => c.IsPending)</span>
                        <span class="summary-label">Pending</span>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="summary-card">
                        <span class="summary-value text-success">$@ChoreItems.Where(c => c.IsCompleted).Sum(c => c.Value).ToString("F2")</span>
                        <span class="summary-label">Earned Today</span>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string? DateParam { get; set; }

    private List<TrackerChoreItem> ChoreItems { get; set; } = [];
    private DateOnly SelectedDate { get; set; }
    private DateOnly Today => DateProvider.Today;
    private bool IsToday => SelectedDate == Today;
    private bool IsLoading { get; set; } = true;

    private string? UserId { get; set; }
    private bool IsParent { get; set; }
    private decimal Balance { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        UserId = user.FindFirstValue(ClaimTypes.NameIdentifier);
        IsParent = user.IsInRole("Parent");

        // Parse date from route or use today
        if (!string.IsNullOrEmpty(DateParam) && DateOnly.TryParse(DateParam, out var parsedDate))
        {
            SelectedDate = parsedDate;
        }
        else
        {
            SelectedDate = Today;
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        IsLoading = true;

        try
        {
            // Parents see all chores, children see only their own
            if (IsParent)
            {
                ChoreItems = await TrackerService.GetTrackerItemsForDateAsync(SelectedDate);
            }
            else if (!string.IsNullOrEmpty(UserId))
            {
                ChoreItems = await TrackerService.GetTrackerItemsForUserOnDateAsync(UserId, SelectedDate);
            }

            // Load balance for current user
            if (!string.IsNullOrEmpty(UserId))
            {
                Balance = await LedgerService.GetUserBalanceAsync(UserId);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", $"Failed to load chores: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string GetEmptyMessage()
    {
        if (IsToday)
            return "There are no chores scheduled for today.";
        return $"There are no chores scheduled for {SelectedDate:MMMM d}.";
    }

    private async Task ToggleChore(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId)) return;

        var result = await TrackerService.ToggleChoreCompletionAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            UserId,
            IsParent);

        if (result.Success)
        {
            ToastService.ShowSuccess("Done!", $"'{item.ChoreName}' marked as complete.");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
        }
    }

    private async Task ApproveChore(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;

        var result = await TrackerService.SetChoreStatusAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            ChoreStatus.Approved,
            UserId);

        if (result.Success)
        {
            ToastService.ShowSuccess("Approved!", $"'{item.ChoreName}' approved - ${item.Value:F2} earned!");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to approve chore.");
        }
    }

    private async Task MarkMissed(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;

        var result = await TrackerService.MarkChoreMissedAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            UserId);

        if (result.Success)
        {
            ToastService.ShowWarning("Missed", $"'{item.ChoreName}' marked as missed.");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
        }
    }

    private async Task MarkSkipped(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;

        var result = await TrackerService.MarkChoreSkippedAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            UserId);

        if (result.Success)
        {
            ToastService.ShowInfo("Skipped", $"'{item.ChoreName}' skipped for today.");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
        }
    }

    private async Task ResetToPending(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;

        var result = await TrackerService.ResetChoreToPendingAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            UserId);

        if (result.Success)
        {
            ToastService.ShowInfo("Reset", $"'{item.ChoreName}' reset to pending.");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to reset chore.");
        }
    }

    private void GoToPreviousDay()
    {
        SelectedDate = SelectedDate.AddDays(-1);
        _ = LoadDataAsync();
    }

    private void GoToNextDay()
    {
        SelectedDate = SelectedDate.AddDays(1);
        _ = LoadDataAsync();
    }

    private void GoToToday()
    {
        SelectedDate = Today;
        _ = LoadDataAsync();
    }

    private bool IsCheckboxDisabled(TrackerChoreItem item)
    {
        // Parents can always toggle
        if (IsParent) return false;

        // Children can only toggle today's pending or completed chores
        if (!IsToday) return true;
        if (item.Status == ChoreStatus.Approved) return true;
        if (item.Status == ChoreStatus.Missed) return true;
        if (item.Status == ChoreStatus.Skipped) return true;

        return false;
    }

    private static string GetTimeAgo(DateTime timestamp)
    {
        var span = DateTime.UtcNow - timestamp;

        if (span.TotalMinutes < 1)
            return "just now";
        if (span.TotalMinutes < 60)
            return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24)
            return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7)
            return $"{(int)span.TotalDays}d ago";

        return timestamp.ToString("MMM d");
    }

    private string GetRowClass(TrackerChoreItem item) => item.Status switch
    {
        ChoreStatus.Approved => "table-success",
        ChoreStatus.Completed => "table-info",
        ChoreStatus.Missed => "table-danger",
        ChoreStatus.Skipped => "table-secondary",
        _ => ""
    };

    private string GetStatusBadgeClass(ChoreStatus status) => status switch
    {
        ChoreStatus.Pending => "bg-warning text-dark",
        ChoreStatus.Completed => "bg-info",
        ChoreStatus.Approved => "bg-success",
        ChoreStatus.Missed => "bg-danger",
        ChoreStatus.Skipped => "bg-secondary",
        _ => "bg-secondary"
    };

    private string GetStatusDisplay(ChoreStatus status) => status switch
    {
        ChoreStatus.Pending => "Pending",
        ChoreStatus.Completed => "Completed",
        ChoreStatus.Approved => "Approved",
        ChoreStatus.Missed => "Missed",
        ChoreStatus.Skipped => "Skipped",
        _ => status.ToString()
    };
}
