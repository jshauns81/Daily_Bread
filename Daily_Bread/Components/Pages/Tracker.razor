@page "/tracker"
@page "/tracker/{DateParam}"
@attribute [Authorize]
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@implements IDisposable

@using System.Security.Claims
@using Daily_Bread.Components.Shared
@using Daily_Bread.Data.Models

@inject IAppStateService AppState
@inject ITrackerService TrackerService
@inject IDateProvider DateProvider
@inject ILedgerService LedgerService
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Book of Deeds</PageTitle>

@* Confetti celebration when all labors complete *@
<Confetti IsActive="_showConfetti" OnComplete="() => _showConfetti = false" ParticleCount="60" />

<div class="tracker-container">
    <div class="tracker-header">
        <h1>Book of Deeds</h1>

        <DateNavigator SelectedDate="SelectedDate"
                       SelectedDateChanged="OnDateChanged"
                       Today="Today"
                       AllowPastNavigation="IsParent"
                       AllowFutureNavigation="IsParent" />

        @if (!string.IsNullOrEmpty(UserId))
        {
            <div class="balance-display">
                <span class="balance-label">Balance:</span>
                <span class="balance-amount @(Balance >= 0 ? "positive" : "")">
                    $@Balance.ToString("F2")
                </span>
            </div>
        }
    </div>

    @if (IsLoading)
    {
        @* Skeleton loader - only for initial load/date changes *@
        <div class="loading-placeholder">
            <div class="skeleton-row"></div>
            <div class="skeleton-row"></div>
            <div class="skeleton-row"></div>
        </div>
    }
    else if (ChoreItems.Count == 0)
    {
        @if (IsParent)
        {
            <EmptyState Type="EmptyStateType.NoChores"
                        Icon="📜"
                        Title="No Labors Scheduled"
                        Message="@GetEmptyMessage()">
                <ActionButton>
                    <a href="/manage-chores" class="btn btn-primary">Create Labors</a>
                </ActionButton>
            </EmptyState>
        }
        else
        {
            <EmptyState Type="EmptyStateType.NoChores"
                        Icon="📜"
                        Title="No Labors Scheduled"
                        Message="@GetEmptyMessage()" />
        }
    }
    else
    {
        @* Mobile Card View *@
        <div class="chore-cards d-md-none">
            @foreach (var item in ChoreItems)
            {
                <TrackerChoreCard Item="item"
                                  IsDisabled="@(IsCheckboxDisabled(item) || _processingItemId == item.ChoreDefinitionId)"
                                  ShowAssignee="IsParent"
                                  ShowActions="IsParent"
                                  OnToggle="ToggleChore"
                                  OnApprove="ApproveChore"
                                  OnSkip="ShowSkipConfirmation"
                                  OnReset="ResetToPending"
                                  OnRespondToHelp="ShowHelpResponseModal" />
            }
        </div>

        @* Desktop Table View - Redesigned Ledger *@
        <div class="d-none d-md-block">
            <table class="chore-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Chore</th>
                        @if (IsParent)
                        {
                            <th>Assigned</th>
                        }
                        <th>Value</th>
                        @if (IsParent)
                        {
                            <th></th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ChoreItems)
                    {
                        <TrackerChoreRow Item="item"
                                         IsDisabled="@(IsCheckboxDisabled(item) || _processingItemId == item.ChoreDefinitionId)"
                                         ShowAssignee="IsParent"
                                         ShowActions="IsParent"
                                         OnToggle="ToggleChore"
                                         OnApprove="ApproveChore"
                                         OnMiss="ShowMissConfirmation"
                                         OnSkip="ShowSkipConfirmation"
                                         OnReset="ResetToPending"
                                         OnRespondToHelp="ShowHelpResponseModal" />
                    }
                </tbody>
            </table>
        </div>

        <TrackerSummary Items="ChoreItems" />
    }
</div>

@* Confirmation Modal for "Mark Undone" *@
@if (_showMissConfirmation && _confirmingItem != null)
{
    <ConfirmationModal 
        Title="Mark Labor as Not Completed"
        Icon="❌"
        Message="@($"Mark '{_confirmingItem.ChoreName}' as not completed?")"
        Consequences="@GetMissConsequences()"
        ConfirmText="Mark Undone"
        Variant="warning"
        IsProcessing="_isProcessingAction"
        OnConfirm="ConfirmMarkMissed"
        OnCancel="CloseConfirmationModals" />
}

@* Confirmation Modal for "Excuse/Skip" *@
@if (_showSkipConfirmation && _confirmingItem != null)
{
    <ConfirmationModal 
        Title="Excuse Labor for Today"
        Icon="🙏"
        Message="@($"Grant dispensation for '{_confirmingItem.ChoreName}'?")"
        Consequences="@(["No penalty will be applied", "No earning for this chore today", "This can be undone later"])"
        ConfirmText="Grant Dispensation"
        Variant="default"
        IsProcessing="_isProcessingAction"
        OnConfirm="ConfirmMarkSkipped"
        OnCancel="CloseConfirmationModals" />
}

@* Help Response Modal *@
@if (_showHelpResponseModal && _helpRequestItem != null)
{
    <HelpResponseModal 
        ChildName="@(_helpRequestItem.AssignedUserName ?? "Child")"
        ChoreName="@_helpRequestItem.ChoreName"
        Reason="@_helpRequestItem.HelpReason"
        RequestedAt="@_helpRequestItem.HelpRequestedAt"
        EarnValue="@_helpRequestItem.EarnValue"
        IsProcessing="_isProcessingAction"
        OnSubmit="HandleHelpResponse"
        OnCancel="CloseConfirmationModals" />
}

@code {
    [Parameter]
    public string? DateParam { get; set; }

    private List<TrackerChoreItem> ChoreItems { get; set; } = [];
    private DateOnly SelectedDate { get; set; }
    private DateOnly Today => DateProvider.Today;
    private bool IsToday => SelectedDate == Today;
    private bool IsLoading { get; set; } = true;

    private string? UserId { get; set; }
    private bool IsParent { get; set; }
    private decimal Balance { get; set; }

    private bool _showConfetti;
    private int _previousCompletedCount;
    
    // Track which item is being processed (for individual loading states)
    private int? _processingItemId;
    
    // Confirmation modal state
    private bool _showMissConfirmation;
    private bool _showSkipConfirmation;
    private bool _showHelpResponseModal;
    private TrackerChoreItem? _confirmingItem;
    private TrackerChoreItem? _helpRequestItem;
    private bool _isProcessingAction;

    // Cancellation support for async date navigation
    private CancellationTokenSource? _loadCts;
    private readonly object _loadLock = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        UserId = user.FindFirstValue(ClaimTypes.NameIdentifier);
        IsParent = user.IsInRole("Parent");

        // Parse date from route or use today
        if (!string.IsNullOrEmpty(DateParam) && DateOnly.TryParse(DateParam, out var parsedDate))
        {
            SelectedDate = parsedDate;
        }
        else
        {
            SelectedDate = Today;
        }

        // Subscribe to state changes from SignalR notifications
        AppState.OnTrackerChanged += OnTrackerStateChanged;
        AppState.OnChildDashboardChanged += OnChildDashboardStateChanged;
        if (IsParent)
        {
            AppState.OnParentDashboardChanged += OnParentDashboardStateChanged;
        }

        await LoadDataAsync();
    }

    private async void OnTrackerStateChanged()
    {
        // Refresh data when tracker cache is invalidated (e.g., from SignalR)
        await InvokeAsync(async () =>
        {
            await RefreshDataAsync();
            StateHasChanged();
        });
    }

    private async void OnChildDashboardStateChanged()
    {
        // Refresh data when child dashboard changes (e.g., blessing received)
        if (!IsParent)
        {
            await InvokeAsync(async () =>
            {
                await RefreshDataAsync();
                StateHasChanged();
            });
        }
    }

    private async void OnParentDashboardStateChanged()
    {
        // Refresh data when parent dashboard changes (e.g., help requests)
        if (IsParent)
        {
            await InvokeAsync(async () =>
            {
                await RefreshDataAsync();
                StateHasChanged();
            });
        }
    }

    private async Task OnDateChanged(DateOnly newDate)
    {
        SelectedDate = newDate;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        // Cancel any in-flight load and create new token
        CancellationToken ct;
        lock (_loadLock)
        {
            _loadCts?.Cancel();
            _loadCts?.Dispose();
            _loadCts = new CancellationTokenSource();
            ct = _loadCts.Token;
        }

        // Capture the date we're loading for (to verify response matches)
        var loadingForDate = SelectedDate;

        IsLoading = true;
        StateHasChanged();

        var previousCount = ChoreItems.Count(c => c.IsCompleted);

        try
        {
            // Check cancellation before expensive DB calls
            ct.ThrowIfCancellationRequested();

            List<TrackerChoreItem> items;
            decimal balance = 0;

            // Parents see all chores, children see only their own
            if (IsParent)
            {
                items = await TrackerService.GetTrackerItemsForDateAsync(loadingForDate);
            }
            else if (!string.IsNullOrEmpty(UserId))
            {
                items = await TrackerService.GetTrackerItemsForUserOnDateAsync(UserId, loadingForDate);
            }
            else
            {
                items = [];
            }

            // Check cancellation after DB call - don't apply stale data
            ct.ThrowIfCancellationRequested();

            // Verify we're still showing the same date (double-check against races)
            if (loadingForDate != SelectedDate)
            {
                return; // Discard stale response
            }

            // Load balance for current user
            if (!string.IsNullOrEmpty(UserId))
            {
                balance = await LedgerService.GetUserBalanceAsync(UserId);
            }

            // Final cancellation check before updating UI
            ct.ThrowIfCancellationRequested();

            // Apply results
            ChoreItems = items;
            Balance = balance;

            // Check if all chores just became completed (trigger confetti)
            var currentCompleted = ChoreItems.Count(c => c.IsCompleted);
            var totalChores = ChoreItems.Count;

            if (totalChores > 0 &&
                currentCompleted == totalChores &&
                previousCount < totalChores &&
                _previousCompletedCount < totalChores)
            {
                _showConfetti = true;
            }

            _previousCompletedCount = currentCompleted;
        }
        catch (OperationCanceledException)
        {
            // Expected when user navigates quickly - don't show error
            return;
        }
        catch (Exception ex)
        {
            // Only show error if not cancelled
            if (!ct.IsCancellationRequested)
            {
                ToastService.ShowError("Error", $"Failed to load chores: {ex.Message}");
            }
        }
        finally
        {
            // Only update loading state if this is still the current request
            if (!ct.IsCancellationRequested)
            {
                IsLoading = false;
                StateHasChanged();
            }
        }
    }

    /// <summary>
    /// Refresh data without showing the loading skeleton (for after item updates)
    /// </summary>
    private async Task RefreshDataAsync()
    {
        try
        {
            List<TrackerChoreItem> items;
            decimal balance = 0;

            if (IsParent)
            {
                items = await TrackerService.GetTrackerItemsForDateAsync(SelectedDate);
            }
            else if (!string.IsNullOrEmpty(UserId))
            {
                items = await TrackerService.GetTrackerItemsForUserOnDateAsync(UserId, SelectedDate);
            }
            else
            {
                items = [];
            }

            if (!string.IsNullOrEmpty(UserId))
            {
                balance = await LedgerService.GetUserBalanceAsync(UserId);
            }

            var previousCount = _previousCompletedCount;
            ChoreItems = items;
            Balance = balance;

            // Check if all chores just became completed (trigger confetti)
            var currentCompleted = ChoreItems.Count(c => c.IsCompleted);
            var totalChores = ChoreItems.Count;

            if (totalChores > 0 &&
                currentCompleted == totalChores &&
                previousCount < totalChores)
            {
                _showConfetti = true;
            }

            _previousCompletedCount = currentCompleted;
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", $"Failed to refresh: {ex.Message}");
        }
    }

    private string GetEmptyMessage()
    {
        if (IsToday)
            return "There are no labors scheduled for today.";
        return $"There are no labors scheduled for {SelectedDate:MMMM d}.";
    }

    private async Task ToggleChore(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId)) return;
        if (_processingItemId.HasValue) return; // Prevent double-clicks

        _processingItemId = item.ChoreDefinitionId;
        StateHasChanged();

        // Capture the original status to determine if this was a completion or undo
        var originalStatus = item.Status;

        try
        {
            var result = await TrackerService.ToggleChoreCompletionAsync(
                item.ChoreDefinitionId,
                SelectedDate,
                UserId,
                IsParent);

            if (result.Success)
            {
                var newStatus = result.Data;
                
                // Determine appropriate toast based on status transition
                if (newStatus == ChoreStatus.Approved || newStatus == ChoreStatus.Completed)
                {
                    // Completion - show "Done!" with amount if applicable
                    var message = item.EarnValue > 0 
                        ? $"'{item.ChoreName}' +${item.EarnValue:F2}" 
                        : $"'{item.ChoreName}' marked as complete.";
                    ToastService.ShowSuccess("Done!", message);
                }
                else if (newStatus == ChoreStatus.Pending)
                {
                    // Undo - show "Undone" message
                    ToastService.ShowInfo("Undone", $"'{item.ChoreName}' has been reset.");
                }
                else
                {
                    // Fallback for any other status change
                    ToastService.ShowInfo("Updated", $"'{item.ChoreName}' status changed.");
                }
                
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
            }
        }
        finally
        {
            _processingItemId = null;
            StateHasChanged();
        }
    }

    private async Task ApproveChore(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;
        if (_processingItemId.HasValue) return;

        _processingItemId = item.ChoreDefinitionId;
        StateHasChanged();

        try
        {
            var result = await TrackerService.SetChoreStatusAsync(
                item.ChoreDefinitionId,
                SelectedDate,
                ChoreStatus.Approved,
                UserId);

            if (result.Success)
            {
                ToastService.ShowSuccess("Blessed!", $"'{item.ChoreName}' blessed - ${item.Value:F2} wages earned!");
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to bless labor.");
            }
        }
        finally
        {
            _processingItemId = null;
            StateHasChanged();
        }
    }

    // Show confirmation before marking as missed
    private void ShowMissConfirmation(TrackerChoreItem item)
    {
        _confirmingItem = item;
        _showMissConfirmation = true;
    }
    
    private List<string> GetMissConsequences()
    {
        var consequences = new List<string>
        {
            "Labor will be recorded as not completed"
        };
        
        if (_confirmingItem?.PenaltyValue > 0)
        {
            consequences.Add($"A ${_confirmingItem.PenaltyValue:F2} penalty may apply");
        }
        
        consequences.Add("This can be undone later");
        
        return consequences;
    }

    private async Task ConfirmMarkMissed()
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent || _confirmingItem == null) return;

        _isProcessingAction = true;
        
        try
        {
            var result = await TrackerService.MarkChoreMissedAsync(
                _confirmingItem.ChoreDefinitionId,
                SelectedDate,
                UserId);

            if (result.Success)
            {
                ToastService.ShowWarning("Marked Undone", $"'{_confirmingItem.ChoreName}' marked as not completed.");
                CloseConfirmationModals();
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
            }
        }
        finally
        {
            _isProcessingAction = false;
        }
    }

    // Show confirmation before skipping
    private void ShowSkipConfirmation(TrackerChoreItem item)
    {
        _confirmingItem = item;
        _showSkipConfirmation = true;
    }

    private async Task ConfirmMarkSkipped()
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent || _confirmingItem == null) return;

        _isProcessingAction = true;
        
        try
        {
            var result = await TrackerService.MarkChoreSkippedAsync(
                _confirmingItem.ChoreDefinitionId,
                SelectedDate,
                UserId);

            if (result.Success)
            {
                ToastService.ShowInfo("Excused", $"'{_confirmingItem.ChoreName}' excused for today.");
                CloseConfirmationModals();
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
            }
        }
        finally
        {
            _isProcessingAction = false;
        }
    }

    // Show help response modal
    private void ShowHelpResponseModal(TrackerChoreItem item)
    {
        _helpRequestItem = item;
        _showHelpResponseModal = true;
    }

    private async Task HandleHelpResponse((HelpResponse Response, string? Note) args)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent || _helpRequestItem?.ChoreLogId == null) return;

        _isProcessingAction = true;
        
        try
        {
            var result = await TrackerService.RespondToHelpRequestAsync(
                _helpRequestItem.ChoreLogId.Value,
                UserId,
                args.Response,
                args.Note);

            if (result.Success)
            {
                var message = args.Response switch
                {
                    HelpResponse.CompletedByParent => $"'{_helpRequestItem.ChoreName}' fulfilled and blessed!",
                    HelpResponse.Excused => $"'{_helpRequestItem.ChoreName}' excused for today.",
                    HelpResponse.Denied => $"'{_helpRequestItem.ChoreName}' reset - they'll need to try again.",
                    _ => "Help request resolved."
                };
                
                var toastType = args.Response switch
                {
                    HelpResponse.CompletedByParent => "success",
                    HelpResponse.Excused => "info",
                    _ => "info"
                };
                
                if (toastType == "success")
                    ToastService.ShowSuccess("Resolved!", message);
                else
                    ToastService.ShowInfo("Resolved", message);
                    
                CloseConfirmationModals();
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to respond to help request.");
            }
        }
        finally
        {
            _isProcessingAction = false;
        }
    }

    private async Task ResetToPending(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;
        if (_processingItemId.HasValue) return;

        _processingItemId = item.ChoreDefinitionId;
        StateHasChanged();

        try
        {
            var result = await TrackerService.ResetChoreToPendingAsync(
                item.ChoreDefinitionId,
                SelectedDate,
                UserId);

            if (result.Success)
            {
                ToastService.ShowInfo("Restored", $"'{item.ChoreName}' restored to pending.");
                await RefreshDataAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to reset chore.");
            }
        }
        finally
        {
            _processingItemId = null;
            StateHasChanged();
        }
    }
    
    private void CloseConfirmationModals()
    {
        _showMissConfirmation = false;
        _showSkipConfirmation = false;
        _showHelpResponseModal = false;
        _confirmingItem = null;
        _helpRequestItem = null;
    }

    private bool IsCheckboxDisabled(TrackerChoreItem item)
    {
        // Parents can always toggle
        if (IsParent) return false;

        // Children can only toggle today's pending or completed chores
        if (!IsToday) return true;
        if (item.Status == ChoreStatus.Approved) return true;
        if (item.Status == ChoreStatus.Missed) return true;
        if (item.Status == ChoreStatus.Skipped) return true;

        return false;
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        
        // Unsubscribe from state change events
        AppState.OnTrackerChanged -= OnTrackerStateChanged;
        AppState.OnChildDashboardChanged -= OnChildDashboardStateChanged;
        if (IsParent)
        {
            AppState.OnParentDashboardChanged -= OnParentDashboardStateChanged;
        }
    }
}
