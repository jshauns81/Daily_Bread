@page "/tracker"
@page "/tracker/{DateParam}"
@attribute [Authorize]
@rendermode InteractiveServer
@implements IDisposable

@using System.Security.Claims
@using Daily_Bread.Components.Shared
@using Daily_Bread.Data.Models

@inject IAppStateService AppState
@inject ITrackerService TrackerService
@inject IDateProvider DateProvider
@inject ILedgerService LedgerService
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Book of Deeds</PageTitle>

@* Confetti celebration when all labors complete *@
<Confetti IsActive="_showConfetti" OnComplete="() => _showConfetti = false" ParticleCount="60" />

<div class="tracker-container">
    <div class="tracker-header">
        <h1>Book of Deeds</h1>

        <DateNavigator SelectedDate="SelectedDate"
                       SelectedDateChanged="OnDateChanged"
                       Today="Today"
                       AllowPastNavigation="IsParent"
                       AllowFutureNavigation="IsParent" />

        @if (!string.IsNullOrEmpty(UserId))
        {
            <div class="balance-display mt-2">
                <span class="fw-bold">Balance:</span>
                <span class="@(Balance >= 0 ? "text-success" : "text-danger") fs-5">
                    $@Balance.ToString("F2")
                </span>
            </div>
        }
    </div>

    @if (IsLoading)
    {
        @* Skeleton loader for table *@
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th><Skeleton Type="SkeletonType.Text" Width="40px" /></th>
                        <th><Skeleton Type="SkeletonType.Text" Width="120px" /></th>
                        @if (IsParent)
                        {
                            <th><Skeleton Type="SkeletonType.Text" Width="100px" /></th>
                        }
                        <th><Skeleton Type="SkeletonType.Text" Width="60px" /></th>
                        <th><Skeleton Type="SkeletonType.Text" Width="80px" /></th>
                        @if (IsParent)
                        {
                            <th><Skeleton Type="SkeletonType.Text" Width="120px" /></th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < 5; i++)
                    {
                        <Skeleton Type="SkeletonType.TableRow" Columns="@(IsParent ? 6 : 4)" />
                    }
                </tbody>
            </table>
        </div>
    }
    else if (ChoreItems.Count == 0)
    {
        @if (IsParent)
        {
            <EmptyState Type="EmptyStateType.NoChores"
                        Icon="📜"
                        Title="No Labors Scheduled"
                        Message="@GetEmptyMessage()">
                <ActionButton>
                    <a href="/manage-chores" class="btn btn-primary">Create Labors</a>
                </ActionButton>
            </EmptyState>
        }
        else
        {
            <EmptyState Type="EmptyStateType.NoChores"
                        Icon="📜"
                        Title="No Labors Scheduled"
                        Message="@GetEmptyMessage()" />
        }
    }
    else
    {
        @* Mobile Card View *@
        <div class="chore-cards d-md-none">
            @foreach (var item in ChoreItems)
            {
                <TrackerChoreCard Item="item"
                                  IsDisabled="IsCheckboxDisabled(item)"
                                  ShowAssignee="IsParent"
                                  ShowActions="IsParent"
                                  OnToggle="ToggleChore"
                                  OnApprove="ApproveChore"
                                  OnSkip="MarkSkipped" />
            }
        </div>

        @* Desktop Table View *@
        <div class="table-responsive d-none d-md-block">
            <table class="table table-hover chore-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 60px;">Done</th>
                        <th>Chore</th>
                        @if (IsParent)
                        {
                            <th>Assigned To</th>
                        }
                        <th style="width: 100px;" class="text-center">Value</th>
                        <th style="width: 180px;" class="text-center">Status</th>
                        @if (IsParent)
                        {
                            <th style="width: 200px;" class="text-center">Actions</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ChoreItems)
                    {
                        <TrackerChoreRow Item="item"
                                         IsDisabled="IsCheckboxDisabled(item)"
                                         ShowAssignee="IsParent"
                                         ShowActions="IsParent"
                                         OnToggle="ToggleChore"
                                         OnApprove="ApproveChore"
                                         OnMiss="MarkMissed"
                                         OnSkip="MarkSkipped"
                                         OnReset="ResetToPending" />
                    }
                </tbody>
            </table>
        </div>

        <TrackerSummary Items="ChoreItems" />
    }
</div>

@code {
    [Parameter]
    public string? DateParam { get; set; }

    private List<TrackerChoreItem> ChoreItems { get; set; } = [];
    private DateOnly SelectedDate { get; set; }
    private DateOnly Today => DateProvider.Today;
    private bool IsToday => SelectedDate == Today;
    private bool IsLoading { get; set; } = true;

    private string? UserId { get; set; }
    private bool IsParent { get; set; }
    private decimal Balance { get; set; }

    private bool _showConfetti;
    private int _previousCompletedCount;

    // Cancellation support for async date navigation
    private CancellationTokenSource? _loadCts;
    private readonly object _loadLock = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        UserId = user.FindFirstValue(ClaimTypes.NameIdentifier);
        IsParent = user.IsInRole("Parent");

        // Parse date from route or use today
        if (!string.IsNullOrEmpty(DateParam) && DateOnly.TryParse(DateParam, out var parsedDate))
        {
            SelectedDate = parsedDate;
        }
        else
        {
            SelectedDate = Today;
        }

        await LoadDataAsync();
    }

    private async Task OnDateChanged(DateOnly newDate)
    {
        SelectedDate = newDate;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        // Cancel any in-flight load and create new token
        CancellationToken ct;
        lock (_loadLock)
        {
            _loadCts?.Cancel();
            _loadCts?.Dispose();
            _loadCts = new CancellationTokenSource();
            ct = _loadCts.Token;
        }

        // Capture the date we're loading for (to verify response matches)
        var loadingForDate = SelectedDate;

        IsLoading = true;
        StateHasChanged();

        var previousCount = ChoreItems.Count(c => c.IsCompleted);

        try
        {
            // Check cancellation before expensive DB calls
            ct.ThrowIfCancellationRequested();

            List<TrackerChoreItem> items;
            decimal balance = 0;

            // Parents see all chores, children see only their own
            if (IsParent)
            {
                items = await TrackerService.GetTrackerItemsForDateAsync(loadingForDate);
            }
            else if (!string.IsNullOrEmpty(UserId))
            {
                items = await TrackerService.GetTrackerItemsForUserOnDateAsync(UserId, loadingForDate);
            }
            else
            {
                items = [];
            }

            // Check cancellation after DB call - don't apply stale data
            ct.ThrowIfCancellationRequested();

            // Verify we're still showing the same date (double-check against races)
            if (loadingForDate != SelectedDate)
            {
                return; // Discard stale response
            }

            // Load balance for current user
            if (!string.IsNullOrEmpty(UserId))
            {
                balance = await LedgerService.GetUserBalanceAsync(UserId);
            }

            // Final cancellation check before updating UI
            ct.ThrowIfCancellationRequested();

            // Apply results
            ChoreItems = items;
            Balance = balance;

            // Check if all chores just became completed (trigger confetti)
            var currentCompleted = ChoreItems.Count(c => c.IsCompleted);
            var totalChores = ChoreItems.Count;

            if (totalChores > 0 &&
                currentCompleted == totalChores &&
                previousCount < totalChores &&
                _previousCompletedCount < totalChores)
            {
                _showConfetti = true;
            }

            _previousCompletedCount = currentCompleted;
        }
        catch (OperationCanceledException)
        {
            // Expected when user navigates quickly - don't show error
            return;
        }
        catch (Exception ex)
        {
            // Only show error if not cancelled
            if (!ct.IsCancellationRequested)
            {
                ToastService.ShowError("Error", $"Failed to load chores: {ex.Message}");
            }
        }
        finally
        {
            // Only update loading state if this is still the current request
            if (!ct.IsCancellationRequested)
            {
                IsLoading = false;
                StateHasChanged();
            }
        }
    }

    private string GetEmptyMessage()
    {
        if (IsToday)
            return "There are no labors scheduled for today.";
        return $"There are no labors scheduled for {SelectedDate:MMMM d}.";
    }

    private async Task ToggleChore(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId)) return;

        var result = await TrackerService.ToggleChoreCompletionAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            UserId,
            IsParent);

        if (result.Success)
        {
            ToastService.ShowSuccess("Done!", $"'{item.ChoreName}' marked as complete.");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
        }
    }

    private async Task ApproveChore(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;

        var result = await TrackerService.SetChoreStatusAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            ChoreStatus.Approved,
            UserId);

        if (result.Success)
        {
            ToastService.ShowSuccess("Blessed!", $"'{item.ChoreName}' blessed - ${item.Value:F2} wages earned!");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to bless labor.");
        }
    }

    private async Task MarkMissed(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;

        var result = await TrackerService.MarkChoreMissedAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            UserId);

        if (result.Success)
        {
            ToastService.ShowWarning("Missed", $"'{item.ChoreName}' marked as missed.");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
        }
    }

    private async Task MarkSkipped(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;

        var result = await TrackerService.MarkChoreSkippedAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            UserId);

        if (result.Success)
        {
            ToastService.ShowInfo("Skipped", $"'{item.ChoreName}' skipped for today.");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to update chore.");
        }
    }

    private async Task ResetToPending(TrackerChoreItem item)
    {
        if (string.IsNullOrEmpty(UserId) || !IsParent) return;

        var result = await TrackerService.ResetChoreToPendingAsync(
            item.ChoreDefinitionId,
            SelectedDate,
            UserId);

        if (result.Success)
        {
            ToastService.ShowInfo("Reset", $"'{item.ChoreName}' reset to pending.");
            await LoadDataAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to reset chore.");
        }
    }

    private bool IsCheckboxDisabled(TrackerChoreItem item)
    {
        // Parents can always toggle
        if (IsParent) return false;

        // Children can only toggle today's pending or completed chores
        if (!IsToday) return true;
        if (item.Status == ChoreStatus.Approved) return true;
        if (item.Status == ChoreStatus.Missed) return true;
        if (item.Status == ChoreStatus.Skipped) return true;

        return false;
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
    }
}
