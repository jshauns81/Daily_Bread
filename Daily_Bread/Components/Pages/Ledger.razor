@page "/ledger"
@page "/ledger/{ProfileIdParam:int?}"
@attribute [Authorize]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@using System.Security.Claims

@inject ILedgerService LedgerService
@inject IPayoutService PayoutService
@inject IChildProfileService ProfileService
@inject IDateProvider DateProvider
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Treasury</PageTitle>

<div class="ledger-container">
    <h1>Treasury</h1>

    <!-- Filters Card -->
    @if (IsParent)
    {
        <div class="card mb-4">
            <div class="card-body">
                <div class="filters-row">
                    @if (ChildProfiles.Count > 1)
                    {
                        <div class="filter-item">
                            <label class="form-label">Select Child</label>
                            <select class="form-select" @bind="SelectedProfileId" @bind:after="OnProfileChanged">
                                <option value="0">-- Select a Child --</option>
                                @foreach (var profile in ChildProfiles)
                                {
                                    <option value="@profile.ProfileId" class="user-name">@profile.DisplayName ($@profile.TotalBalance.ToString("F2"))</option>
                                }
                            </select>
                        </div>
                    }
                    @if (SelectedProfileId > 0 && Accounts.Count > 1)
                    {
                        <div class="filter-item filter-item-sm">
                            <label class="form-label">Account</label>
                            <select class="form-select" @bind="SelectedAccountId" @bind:after="OnAccountChanged">
                                @foreach (var account in Accounts)
                                {
                                    <option value="@account.Id">@account.Name</option>
                                }
                            </select>
                        </div>
                    }
                    <div class="filter-item filter-item-sm">
                        <label class="form-label">From</label>
                        <input type="date" class="form-control" @bind="FromDate" @bind:after="LoadTransactionsAsync" />
                    </div>
                    <div class="filter-item filter-item-sm">
                        <label class="form-label">To</label>
                        <input type="date" class="form-control" @bind="ToDate" @bind:after="LoadTransactionsAsync" />
                    </div>
                    <div class="filter-item filter-item-btn">
                        <label class="form-label d-none d-md-block">&nbsp;</label>
                        <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                            <span class="bi bi-x-lg"></span> Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (IsLoading && SelectedAccountId == 0)
    {
        @* Initial loading state *@
        <div class="skeleton-dashboard">
            <div class="skeleton-dashboard-stats mb-4">
                <Skeleton Type="SkeletonType.StatCard" />
                <Skeleton Type="SkeletonType.StatCard" />
                <Skeleton Type="SkeletonType.StatCard" />
            </div>
            <Skeleton Type="SkeletonType.Card" />
        </div>
    }
    else if (SelectedAccountId > 0 && SelectedBalance != null)
    {
        <!-- Balance Card -->
        <BalanceCard Balance="@CreateLegacyBalance()" 
                     OnCashOut="ShowCashOutModal" 
                     OnBonus="ShowBonusModal"
                     OnPenalty="ShowPenaltyModal" />

        <!-- Quick Stats -->
        @if (Stats != null)
        {
            <div class="stats-grid">
                <div class="stat-card bg-success-subtle">
                    <span class="stat-value text-success">$@Stats.TotalEarnings.ToString("F2")</span>
                    <span class="stat-label">Wages</span>
                </div>
                <div class="stat-card bg-danger-subtle">
                    <span class="stat-value text-danger">$@Stats.TotalDeductions.ToString("F2")</span>
                    <span class="stat-label">Deductions</span>
                </div>
                <div class="stat-card bg-info-subtle">
                    <span class="stat-value text-info">$@Stats.TotalBonuses.ToString("F2")</span>
                    <span class="stat-label">Bonuses</span>
                </div>
                <div class="stat-card bg-warning-subtle">
                    <span class="stat-value text-warning">$@Stats.TotalPenalties.ToString("F2")</span>
                    <span class="stat-label">Penance</span>
                </div>
                <div class="stat-card bg-secondary-subtle">
                    <span class="stat-value">$@Stats.TotalPayouts.ToString("F2")</span>
                    <span class="stat-label">Paid Out</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">@Stats.TransactionCount</span>
                    <span class="stat-label">Transactions</span>
                </div>
            </div>
        }
    }
    else if (!IsParent && SelectedAccountId == 0)
    {
        <EmptyState Type="EmptyStateType.Error" 
                    Icon="🏛️"
                    Title="No Treasury Found"
                    Message="Please contact a parent to set up your treasury account." />
    }
    else if (IsParent && SelectedProfileId == 0)
    {
        @if (ChildProfiles.Count == 0)
        {
            <EmptyState Type="EmptyStateType.NoChildren" 
                        Icon="👨‍👩‍👧‍👦"
                        Title="No Children Added"
                        Message="Add children to view their treasury.">
                <ActionButton>
                    <a href="/admin/users" class="btn btn-primary">Add Children</a>
                </ActionButton>
            </EmptyState>
        }
        else
        {
            <EmptyState Type="EmptyStateType.NoChildren" 
                        Icon="🏛️"
                        Title="Select a Child"
                        Message="Choose a child from the dropdown above to view their treasury." />
        }
    }

    @if (SelectedAccountId > 0)
    {
        <!-- Transactions Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Transaction History</h5>
                @if (IsParent)
                {
                    <button class="btn btn-outline-primary btn-sm" @onclick="ShowAdjustmentModal">
                        + Add Adjustment
                    </button>
                }
            </div>
            <div class="card-body">
                @if (IsLoading)
                {
                    <table class="table">
                        <thead>
                            <tr>
                                <th><Skeleton Type="SkeletonType.Text" Width="80px" /></th>
                                <th><Skeleton Type="SkeletonType.Text" Width="60px" /></th>
                                <th><Skeleton Type="SkeletonType.Text" Width="150px" /></th>
                                <th><Skeleton Type="SkeletonType.Text" Width="70px" /></th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < 5; i++)
                            {
                                <Skeleton Type="SkeletonType.TableRow" Columns="4" />
                            }
                        </tbody>
                    </table>
                }
                else if (Transactions.Count == 0)
                {
                    <EmptyState Type="EmptyStateType.NoTransactions" 
                                CssClass="empty-state-compact" />
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var txn in Transactions)
                                {
                                    <tr>
                                        <td>@txn.TransactionDate.ToString("MMM d, yyyy")</td>
                                        <td>
                                            <span class="badge @GetTypeBadgeClass(txn.Type)">
                                                @GetTypeDisplay(txn.Type)
                                            </span>
                                        </td>
                                        <td>@txn.Description</td>
                                        <td class="text-end">
                                            <span class="@(txn.Amount >= 0 ? "text-success" : "text-danger") fw-bold">
                                                @(txn.Amount >= 0 ? "+" : "")$@Math.Abs(txn.Amount).ToString("F2")
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Cash Out Modal -->
@if (ShowCashOut && SelectedBalance != null)
{
    <CashOutModal Balance="@CreateLegacyBalance()"
                  OnConfirm="ProcessCashOut"
                  OnCancel="() => ShowCashOut = false" />
}

<!-- Bonus Modal -->
@if (ShowBonus && SelectedBalance != null)
{
    <TransactionModal Title="Add Bonus"
                      AmountLabel="Bonus Amount"
                      IsPositive="true"
                      CurrentBalance="@SelectedBalance.CurrentBalance"
                      OnConfirm="ProcessBonus"
                      OnCancel="() => ShowBonus = false" />
}

<!-- Penance Modal -->
@if (ShowPenalty && SelectedBalance != null)
{
    <TransactionModal Title="Add Penance"
                      AmountLabel="Penance Amount"
                      IsPositive="false"
                      CurrentBalance="@SelectedBalance.CurrentBalance"
                      OnConfirm="ProcessPenalty"
                      OnCancel="() => ShowPenalty = false" />
}

<!-- Adjustment Modal -->
@if (ShowAdjustment && SelectedBalance != null)
{
    <TransactionModal Title="Add Adjustment"
                      AmountLabel="Adjustment Amount"
                      AllowNegative="true"
                      CurrentBalance="@SelectedBalance.CurrentBalance"
                      OnConfirm="ProcessAdjustment"
                      OnCancel="() => ShowAdjustment = false" />
}

@code {
    [Parameter]
    public int? ProfileIdParam { get; set; }

    private List<ChildProfileSummary> ChildProfiles { get; set; } = [];
    private List<LedgerAccount> Accounts { get; set; } = [];
    private List<LedgerTransaction> Transactions { get; set; } = [];
    private AccountBalanceSummary? SelectedBalance { get; set; }
    private TransactionStats? Stats { get; set; }
    
    private int SelectedProfileId { get; set; }
    private int SelectedAccountId { get; set; }
    private DateOnly? FromDate { get; set; }
    private DateOnly? ToDate { get; set; }
    
    private bool IsLoading { get; set; } = true;
    private bool IsParent { get; set; }
    private string? CurrentUserId { get; set; }

    private bool ShowCashOut { get; set; }
    private bool ShowBonus { get; set; }
    private bool ShowPenalty { get; set; }
    private bool ShowAdjustment { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        CurrentUserId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
        IsParent = authState.User.IsInRole("Parent");

        try
        {
            if (IsParent)
            {
                // Load all child profiles for selection
                ChildProfiles = await ProfileService.GetAllChildProfilesAsync();
                
                // Use route parameter if provided
                if (ProfileIdParam.HasValue && ProfileIdParam.Value > 0)
                {
                    SelectedProfileId = ProfileIdParam.Value;
                    await OnProfileChanged();
                }
                // Auto-select if there's only one child
                else if (ChildProfiles.Count == 1)
                {
                    SelectedProfileId = ChildProfiles[0].ProfileId;
                    await OnProfileChanged();
                }
            }
            else
            {
                // Child user - load their own profile and account
                if (!string.IsNullOrEmpty(CurrentUserId))
                {
                    var profile = await ProfileService.GetProfileByUserIdAsync(CurrentUserId);
                    if (profile != null)
                    {
                        SelectedProfileId = profile.Id;
                        Accounts = await ProfileService.GetAccountsAsync(profile.Id);
                        var defaultAccount = Accounts.FirstOrDefault(a => a.IsDefault) ?? Accounts.FirstOrDefault();
                        if (defaultAccount != null)
                        {
                            SelectedAccountId = defaultAccount.Id;
                            await LoadTransactionsAsync();
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", $"Failed to load ledger: {ex.Message}");
        }

        IsLoading = false;
    }

    private async Task OnProfileChanged()
    {
        SelectedAccountId = 0;
        SelectedBalance = null;
        Stats = null;
        Transactions = [];

        if (SelectedProfileId > 0)
        {
            // Authorization check
            if (!IsParent && !await ProfileService.CanAccessProfileAsync(CurrentUserId!, IsParent, SelectedProfileId))
            {
                ToastService.ShowError("Access Denied", "You don't have permission to view this profile.");
                return;
            }

            Accounts = await ProfileService.GetAccountsAsync(SelectedProfileId);
            var defaultAccount = Accounts.FirstOrDefault(a => a.IsDefault) ?? Accounts.FirstOrDefault();
            if (defaultAccount != null)
            {
                SelectedAccountId = defaultAccount.Id;
                await LoadTransactionsAsync();
            }
        }
    }

    private async Task OnAccountChanged()
    {
        if (SelectedAccountId > 0)
        {
            // Authorization check
            if (!IsParent && !await ProfileService.CanAccessAccountAsync(CurrentUserId!, IsParent, SelectedAccountId))
            {
                ToastService.ShowError("Access Denied", "You don't have permission to view this account.");
                return;
            }

            await LoadTransactionsAsync();
        }
    }

    private async Task LoadTransactionsAsync()
    {
        if (SelectedAccountId == 0) return;

        IsLoading = true;

        try
        {
            Transactions = await LedgerService.GetAccountTransactionsAsync(SelectedAccountId, FromDate, ToDate);
            SelectedBalance = await PayoutService.GetAccountBalanceSummaryAsync(SelectedAccountId);
            Stats = await LedgerService.GetAccountTransactionStatsAsync(SelectedAccountId, FromDate, ToDate);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", $"Failed to load transactions: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task ClearFilters()
    {
        FromDate = null;
        ToDate = null;
        await LoadTransactionsAsync();
    }

    private BalanceSummary CreateLegacyBalance()
    {
        if (SelectedBalance == null)
        {
            return new BalanceSummary
            {
                UserId = "",
                UserName = "Unknown",
                CurrentBalance = 0,
                TotalEarned = 0,
                TotalDeducted = 0,
                TotalPaidOut = 0,
                CashOutThreshold = 10
            };
        }

        return new BalanceSummary
        {
            UserId = SelectedBalance.UserId,
            UserName = SelectedBalance.ChildDisplayName,
            CurrentBalance = SelectedBalance.CurrentBalance,
            TotalEarned = SelectedBalance.TotalEarned,
            TotalDeducted = SelectedBalance.TotalDeducted,
            TotalPaidOut = SelectedBalance.TotalPaidOut,
            CashOutThreshold = SelectedBalance.CashOutThreshold
        };
    }

    private void ShowCashOutModal() => ShowCashOut = true;
    private void ShowBonusModal() => ShowBonus = true;
    private void ShowPenaltyModal() => ShowPenalty = true;
    private void ShowAdjustmentModal() => ShowAdjustment = true;

    private async Task ProcessCashOut(decimal amount)
    {
        if (SelectedAccountId == 0) return;

        var result = await PayoutService.ProcessAccountCashOutAsync(SelectedAccountId, amount, CurrentUserId!);
        
        if (result.Success)
        {
            ToastService.ShowSuccess("Cash Out Complete!", $"${amount:F2} has been paid out.");
            ShowCashOut = false;
            ChildProfiles = await ProfileService.GetAllChildProfilesAsync();
            await LoadTransactionsAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to process cash out.");
        }
    }

    private async Task ProcessBonus((decimal Amount, string Description) bonus)
    {
        if (SelectedAccountId == 0) return;

        var result = await PayoutService.AddAccountBonusAsync(SelectedAccountId, bonus.Amount, CurrentUserId!, bonus.Description);
        
        if (result.Success)
        {
            ToastService.ShowSuccess("Bonus Added!", $"${bonus.Amount:F2} bonus applied.");
            ShowBonus = false;
            ChildProfiles = await ProfileService.GetAllChildProfilesAsync();
            await LoadTransactionsAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to add bonus.");
        }
    }

    private async Task ProcessPenalty((decimal Amount, string Description) penalty)
    {
        if (SelectedAccountId == 0) return;

        var result = await PayoutService.AddAccountPenaltyAsync(SelectedAccountId, penalty.Amount, CurrentUserId!, penalty.Description);
        
        if (result.Success)
        {
            ToastService.ShowWarning("Penance Applied", $"${penalty.Amount:F2} penance deducted.");
            ShowPenalty = false;
            ChildProfiles = await ProfileService.GetAllChildProfilesAsync();
            await LoadTransactionsAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to apply penance.");
        }
    }

    private async Task ProcessAdjustment((decimal Amount, string Description) adjustment)
    {
        if (SelectedAccountId == 0) return;

        var result = await PayoutService.AddAccountAdjustmentAsync(SelectedAccountId, adjustment.Amount, CurrentUserId!, adjustment.Description);
        
        if (result.Success)
        {
            var sign = adjustment.Amount >= 0 ? "+" : "";
            ToastService.ShowInfo("Adjustment Applied", $"{sign}${adjustment.Amount:F2} adjustment recorded.");
            ShowAdjustment = false;
            ChildProfiles = await ProfileService.GetAllChildProfilesAsync();
            await LoadTransactionsAsync();
        }
        else
        {
            ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to apply adjustment.");
        }
    }

    private string GetTypeBadgeClass(TransactionType type) => type switch
    {
        TransactionType.ChoreEarning => "bg-success",
        TransactionType.ChoreDeduction => "bg-danger",
        TransactionType.Bonus => "bg-info",
        TransactionType.Penalty => "bg-warning text-dark",
        TransactionType.Adjustment => "bg-secondary",
        TransactionType.Payout => "bg-primary",
        TransactionType.Transfer => "bg-purple",
        _ => "bg-secondary"
    };

    private string GetTypeDisplay(TransactionType type) => type switch
    {
        TransactionType.ChoreEarning => "Labor",
        TransactionType.ChoreDeduction => "Missed",
        TransactionType.Bonus => "Bonus",
        TransactionType.Penalty => "Penance",
        TransactionType.Adjustment => "Adjustment",
        TransactionType.Payout => "Payout",
        TransactionType.Transfer => "Transfer",
        _ => type.ToString()
    };
}
