@page "/"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@implements IDisposable

@using System.Security.Claims
@using Daily_Bread.Components.Shared

@inject IDashboardService DashboardService
@inject IAchievementService AchievementService
@inject ITrackerService TrackerService
@inject IDateProvider DateProvider
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Daily Bread - Home</PageTitle>

@* Confetti celebration when all chores complete *@
<Confetti IsActive="_showConfetti" OnComplete="() => _showConfetti = false" ParticleCount="60" />

@if (_isLoading)
{
    @* Loading skeleton for dashboard *@
    <div class="skeleton-dashboard">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <Skeleton Type="SkeletonType.Text" Width="200px" Height="32px" />
            <Skeleton Type="SkeletonType.Text" Width="180px" Height="20px" />
        </div>
        
        <div class="skeleton-dashboard-stats mb-4">
            <Skeleton Type="SkeletonType.StatCard" />
            <Skeleton Type="SkeletonType.StatCard" />
            <Skeleton Type="SkeletonType.StatCard" />
            <Skeleton Type="SkeletonType.StatCard" />
        </div>
        
        <div class="skeleton-dashboard-main">
            <Skeleton Type="SkeletonType.Card" />
            <Skeleton Type="SkeletonType.Card" />
        </div>
    </div>
}
else if (_isAdminOnly)
{
    <EmptyState Type="EmptyStateType.NoData" 
                Icon="👨‍💼" 
                Title="Admin Account"
                Message="This account is for user management only.">
        <ActionButton>
            <a href="/admin/users" class="btn btn-primary btn-lg">
                Go to User Management
            </a>
        </ActionButton>
    </EmptyState>
}
else if (_isParent && _parentData != null)
{
    <!-- Parent Dashboard -->
    <div class="dashboard-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Welcome back!</h1>
            <span class="text-muted">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</span>
        </div>

        <div class="row mb-4 g-3">
            <div class="col-md-3 col-6">
                <div class="summary-card h-100">
                    <span class="summary-value text-warning">@_parentData.PendingApprovals.Count</span>
                    <span class="summary-label">Pending Blessings</span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="summary-card h-100">
                    <span class="summary-value text-info">@_parentData.TodayCompletedCount</span>
                    <span class="summary-label">Completed Today</span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="summary-card h-100">
                    <span class="summary-value text-success">@_parentData.TodayApprovedCount</span>
                    <span class="summary-label">Blessed Today</span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="summary-card h-100">
                    <span class="summary-value">@_parentData.TodayPendingCount</span>
                    <span class="summary-label">Still Pending</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">✓ Pending Blessings</h5>
                        @if (_parentData.PendingApprovals.Count > 0)
                        {
                            <span class="badge bg-warning text-dark">@_parentData.PendingApprovals.Count</span>
                        }
                    </div>
                    <div class="card-body">
                        @if (_parentData.PendingApprovals.Count == 0)
                        {
                            <EmptyState Type="EmptyStateType.NoChores" 
                                        Title="All Caught Up!"
                                        Message="No labors waiting for blessing."
                                        CssClass="empty-state-compact" />
                        }
                        else
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var item in _parentData.PendingApprovals.Take(5))
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>@item.ChoreName</strong><br />
                                            <small>@item.ChildName • @item.Date.ToString("MMM d")</small>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="text-success fw-bold">$@item.Value.ToString("F2")</span>
                                            <button class="btn btn-success btn-sm" @onclick="() => QuickApprove(item.ChoreLogId)" disabled="@_isApproving" title="Bless">
                                                @if (_approvingId == item.ChoreLogId) 
                                                { 
                                                    <span class="spinner-border spinner-border-sm"></span> 
                                                } 
                                                else 
                                                { 
                                                    <text>✝</text> 
                                                }
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header"><h5 class="mb-0">🏛️ Treasury</h5></div>
                    <div class="card-body">
                        @if (_parentData.ChildrenBalances.Count == 0)
                        {
                            <EmptyState Type="EmptyStateType.NoChildren" 
                                        CssClass="empty-state-compact">
                                <ActionButton>
                                    <a href="/admin/users" class="btn btn-primary btn-sm">Add Children</a>
                                </ActionButton>
                            </EmptyState>
                        }
                        else
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var child in _parentData.ChildrenBalances)
                                {
                                    <a href="/ledger/@child.ProfileId" class="list-group-item list-group-item-action d-flex justify-content-between">
                                        <div>
                                            <strong>@child.DisplayName</strong>
                                            @if (child.CanCashOut) { <span class="badge bg-success ms-2">Cash out ready!</span> }
                                        </div>
                                        <span class="@(child.Balance >= 0 ? "text-success" : "text-danger") fw-bold fs-5">$@child.Balance.ToString("F2")</span>
                                    </a>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else if (_childData != null)
{
    <!-- Child Dashboard - Streamlined Action-First View -->
    <div class="child-dashboard">
        @if (_childData.NewAchievements.Count > 0)
        {
            <div class="achievement-celebration">
                @foreach (var achievement in _childData.NewAchievements)
                {
                    <div class="achievement-toast animate-bounce">
                        <span class="achievement-icon">@achievement.Icon</span>
                        <div>
                            <strong>Unlocked!</strong><br />
                            <span>@achievement.Name</span>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Compact Header: Name, Streak, Balance -->
        <div class="child-header">
            <div class="header-left">
                <span class="child-name">@_childData.DisplayName</span>
                @if (_childData.CurrentStreak > 0)
                {
                    <span class="streak-badge" title="@_childData.CurrentStreak day streak">
                        🔥@_childData.CurrentStreak
                    </span>
                }
            </div>
            <a href="/my-balance" class="balance-display">
                <span class="balance-amount">$@_childData.Balance.ToString("F2")</span>
            </a>
        </div>

        <!-- TO DO Section - Swipeable Cards -->
        @if (_childData.PendingChores.Count > 0)
        {
            <div class="chores-section">
                <div class="section-header">
                    <span class="section-title">To Do</span>
                    <span class="section-count">@_childData.PendingChores.Count left</span>
                </div>
                
                <div class="swipeable-list">
                    @foreach (var chore in _childData.PendingChores)
                    {
                        <SwipeableChoreCard 
                            Chore="@chore"
                            OnComplete="HandleChoreComplete"
                            OnRequestHelp="HandleHelpRequest"
                            IsProcessing="@(_processingChoreId == chore.ChoreDefinitionId)" />
                    }
                </div>
                
                <div class="swipe-hint">
                    <span class="bi bi-arrow-left-right"></span>
                    Swipe right to complete • Swipe left for help
                </div>
            </div>
        }
        else if (_childData.TodayTotalCount > 0)
        {
            <!-- All Done State -->
            <div class="all-done-banner">
                <span class="done-icon">⭐</span>
                <div class="done-text">
                    <strong>All Done!</strong>
                    <span>Great work today</span>
                </div>
            </div>
        }
        else
        {
            <!-- No Chores Today -->
            <div class="no-chores-banner">
                <span class="done-icon">😎</span>
                <div class="done-text">
                    <strong>Day Off</strong>
                    <span>No chores scheduled</span>
                </div>
            </div>
        }

        <!-- DONE Section - Collapsed -->
        @if (_childData.CompletedChores.Count > 0)
        {
            <div class="done-section">
                <button class="done-section-toggle" @onclick="ToggleDoneSection">
                    <span class="section-title">Done</span>
                    <span class="section-count">@_childData.CompletedChores.Count</span>
                    <span class="bi @(_doneExpanded ? "bi-chevron-up" : "bi-chevron-down")"></span>
                </button>
                
                @if (_doneExpanded)
                {
                    <div class="done-list">
                        @foreach (var chore in _childData.CompletedChores)
                        {
                            <div class="done-item @(chore.IsApproved ? "approved" : "pending")">
                                <span class="done-check">
                                    @if (chore.IsApproved)
                                    {
                                        <span class="bi bi-check-circle-fill"></span>
                                    }
                                    else
                                    {
                                        <span class="bi bi-hourglass-split"></span>
                                    }
                                </span>
                                <span class="done-name">@chore.ChoreName</span>
                                @if (chore.EarnValue > 0)
                                {
                                    <span class="done-value @(chore.IsApproved ? "earned" : "")">
                                        @(chore.IsApproved ? "+" : "")$@chore.EarnValue.ToString("F2")
                                    </span>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <!-- Quick Links Footer -->
        <div class="quick-links">
            <a href="/my-balance" class="quick-link">
                <span class="bi bi-wallet2"></span>
                <span>Balance</span>
            </a>
            <a href="/tracker" class="quick-link">
                <span class="bi bi-list-check"></span>
                <span>All Chores</span>
            </a>
            <a href="/goals" class="quick-link">
                <span class="bi bi-bullseye"></span>
                <span>Goals</span>
            </a>
        </div>
    </div>
}
else if (!_isAuthenticated)
{
    @* This shouldn't render - user will be redirected *@
}
else
{
    <EmptyState Type="EmptyStateType.Error" 
                Title="Unable to Load Dashboard"
                Message="We couldn't load your dashboard data. Please try refreshing the page.">
        <ActionButton>
            <button class="btn btn-primary" @onclick="LoadDashboardAsync">Try Again</button>
        </ActionButton>
    </EmptyState>
}

@code {
    private bool _isLoading = true;
    private bool _isAuthenticated;
    private bool _isParent;
    private bool _isAdmin;
    private bool _isAdminOnly;
    private string? _userId;
    private bool _showConfetti;
    private bool _hasTriggeredConfetti;
    private int? _togglingChoreId;
    
    // Child dashboard state
    private bool _doneExpanded = false;
    private int? _processingChoreId;
    
    // Collapsible section state (legacy - keeping for parent view)
    private bool _earningsExpanded = true;
    private bool _expectationsExpanded = false;

    private ParentDashboardData? _parentData;
    private ChildDashboardData? _childData;

    private bool _isApproving;
    private int? _approvingId;
    
    private CancellationTokenSource? _achievementCts;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isAuthenticated = user.Identity?.IsAuthenticated == true;

        if (!_isAuthenticated)
        {
            return;
        }

        _userId = user.FindFirstValue(ClaimTypes.NameIdentifier);
        _isParent = user.IsInRole("Parent");
        _isAdmin = user.IsInRole("Admin");
        _isAdminOnly = user.IsInRole("Admin") && !user.IsInRole("Parent");

        await LoadDashboardAsync();

        if (_childData?.NewAchievements.Count > 0 && !string.IsNullOrEmpty(_userId))
        {
            ScheduleAchievementMarking(_userId);
        }
        
        if (_childData != null && 
            _childData.TodayTotalCount > 0 && 
            _childData.TodayCompletedCount == _childData.TodayTotalCount &&
            !_hasTriggeredConfetti)
        {
            _hasTriggeredConfetti = true;
            _ = Task.Delay(500).ContinueWith(_ => 
            {
                InvokeAsync(() =>
                {
                    _showConfetti = true;
                    StateHasChanged();
                });
            });
        }

        _isLoading = false;
    }
    
    private void CheckAndTriggerConfetti()
    {
        if (_childData != null && 
            _childData.TodayTotalCount > 0 && 
            _childData.TodayCompletedCount == _childData.TodayTotalCount &&
            !_hasTriggeredConfetti)
        {
            _hasTriggeredConfetti = true;
            _ = Task.Delay(500).ContinueWith(_ => 
            {
                InvokeAsync(() =>
                {
                    _showConfetti = true;
                    StateHasChanged();
                });
            });
        }
    }
    
    private void ScheduleAchievementMarking(string userId)
    {
        _achievementCts = new CancellationTokenSource();
        var token = _achievementCts.Token;
        
        _ = Task.Run(async () =>
        {
            try
            {
                await Task.Delay(5000, token);
                if (!token.IsCancellationRequested)
                {
                    await AchievementService.MarkAchievementsAsSeenAsync(userId);
                }
            }
            catch (TaskCanceledException)
            {
            }
        }, token);
    }

    private async Task LoadDashboardAsync()
    {
        try
        {
            if (_isParent || _isAdmin)
            {
                _parentData = await DashboardService.GetParentDashboardAsync();
            }
            else if (!string.IsNullOrEmpty(_userId))
            {
                _childData = await DashboardService.GetChildDashboardAsync(_userId);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", $"Failed to load dashboard: {ex.Message}");
        }
    }

    private void ToggleDoneSection()
    {
        _doneExpanded = !_doneExpanded;
    }
    
    private async Task HandleChoreComplete(TrackerChoreItem chore)
    {
        if (string.IsNullOrEmpty(_userId) || _childData == null) return;
        if (_processingChoreId.HasValue) return;
        
        _processingChoreId = chore.ChoreDefinitionId;
        StateHasChanged();
        
        try
        {
            var today = DateProvider.Today;
            var result = await DashboardService.ToggleChoreFromDashboardAsync(
                chore.ChoreDefinitionId,
                today,
                _userId);

            if (result.Success && result.Data != null)
            {
                if (result.Data.IsApproved)
                {
                    ToastService.ShowSuccess("Done!", $"+${chore.EarnValue:F2}");
                }
                else if (result.Data.IsCompleted)
                {
                    ToastService.ShowInfo("Marked!", "Waiting for approval");
                }
                
                await LoadDashboardAsync();
                
                if (!_hasTriggeredConfetti)
                {
                    CheckAndTriggerConfetti();
                }
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to complete chore");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", ex.Message);
        }
        finally
        {
            _processingChoreId = null;
        }
    }
    
    private async Task HandleHelpRequest(TrackerChoreItem chore)
    {
        if (string.IsNullOrEmpty(_userId) || _childData == null) return;
        if (_processingChoreId.HasValue) return;
        
        _processingChoreId = chore.ChoreDefinitionId;
        StateHasChanged();
        
        try
        {
            var today = DateProvider.Today;
            var result = await TrackerService.RequestHelpAsync(
                chore.ChoreDefinitionId,
                today,
                _userId,
                "Need help with this");

            if (result.Success)
            {
                ToastService.ShowInfo("Help Requested", "Your parents have been notified");
                await LoadDashboardAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to request help");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", ex.Message);
        }
        finally
        {
            _processingChoreId = null;
        }
    }

    private async Task QuickApprove(int choreLogId)
    {
        if (string.IsNullOrEmpty(_userId)) return;

        _isApproving = true;
        _approvingId = choreLogId;

        try
        {
            var result = await DashboardService.QuickApproveAsync(choreLogId, _userId);
            if (result.Success)
            {
                ToastService.ShowSuccess("Blessed!", "Labor has been blessed and wages processed.");
                await LoadDashboardAsync();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to bless labor.");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", ex.Message);
        }
        finally
        {
            _isApproving = false;
            _approvingId = null;
        }
    }

    public void Dispose()
    {
        _achievementCts?.Cancel();
        _achievementCts?.Dispose();
    }
}
