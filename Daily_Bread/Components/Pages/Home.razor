@page "/"
@rendermode InteractiveServer
@implements IDisposable

@using System.Security.Claims
@using Daily_Bread.Components.Shared
@using Daily_Bread.Components.Home
@using Daily_Bread.Data.Models

@inject IAppStateService AppState
@inject IDashboardService DashboardService
@inject IAchievementService AchievementService
@inject ITrackerService TrackerService
@inject IDateProvider DateProvider
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ILogger<Home> Logger

<PageTitle>Daily Bread - Home</PageTitle>

@* Confetti celebration when all chores complete *@
<Confetti IsActive="_showConfetti" OnComplete="() => _showConfetti = false" ParticleCount="60" />

@if (_isLoading)
{
    @* Loading skeleton for dashboard *@
    <div class="skeleton-dashboard">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <Skeleton Type="SkeletonType.Text" Width="200px" Height="32px" />
            <Skeleton Type="SkeletonType.Text" Width="180px" Height="20px" />
        </div>
        
        <div class="skeleton-dashboard-stats mb-4">
            <Skeleton Type="SkeletonType.StatCard" />
            <Skeleton Type="SkeletonType.StatCard" />
            <Skeleton Type="SkeletonType.StatCard" />
            <Skeleton Type="SkeletonType.StatCard" />
        </div>
        
        <div class="skeleton-dashboard-main">
            <Skeleton Type="SkeletonType.Card" />
            <Skeleton Type="SkeletonType.Card" />
        </div>
    </div>
}
else if (!_isAuthenticated)
{
    @* User is not authenticated - redirect will happen via auth system *@
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Redirecting to login...</p>
    </div>
}
else if (_isAdminOnly)
{
    <EmptyState Type="EmptyStateType.NoData" 
                Icon="👨‍💼" 
                Title="Admin Account"
                Message="This account is for user management only.">
        <ActionButton>
            <a href="/admin/users" class="btn btn-primary btn-lg">
                Go to User Management
            </a>
        </ActionButton>
    </EmptyState>
}
else if ((_isParent || _isAdmin) && _parentData != null)
{
    <!-- Parent Dashboard -->
    <div class="dashboard-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Welcome back!</h1>
            <span class="text-muted">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</span>
        </div>

        <div class="row mb-4 g-3">
            <div class="col-md-3 col-6">
                <StatCard Value="@_parentData.PendingApprovals.Count" Label="Pending Blessings" Color="StatColor.Warning" FullHeight="true" />
            </div>
            <div class="col-md-3 col-6">
                <StatCard Value="@_parentData.TodayCompletedCount" Label="Completed Today" Color="StatColor.Info" FullHeight="true" />
            </div>
            <div class="col-md-3 col-6">
                <StatCard Value="@_parentData.TodayApprovedCount" Label="Blessed Today" Color="StatColor.Success" FullHeight="true" />
            </div>
            <div class="col-md-3 col-6">
                <StatCard Value="@_parentData.TodayPendingCount" Label="Still Pending" FullHeight="true" />
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">✓ Pending Blessings</h5>
                        @if (_parentData.PendingApprovals.Count > 0)
                        {
                            <span class="badge bg-warning text-dark">@_parentData.PendingApprovals.Count</span>
                        }
                    </div>
                    <div class="card-body">
                        @if (_parentData.PendingApprovals.Count == 0)
                        {
                            <EmptyState Type="EmptyStateType.NoChores" 
                                        Title="All Caught Up!"
                                        Message="No labors waiting for blessing."
                                        CssClass="empty-state-compact" />
                        }
                        else
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var item in _parentData.PendingApprovals.Take(5))
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-start px-0">
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>@item.ChoreName</strong>
                                                <span class="text-success fw-bold">$@item.Value.ToString("F2")</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mt-1">
                                                <small class="text-muted">
                                                    <span class="user-name">@item.ChildName</span> • @item.Date.ToString("MMM d")
                                                    @if (item.CompletedAt.HasValue)
                                                    {
                                                        <span class="ms-1">• @GetTimeAgo(item.CompletedAt.Value)</span>
                                                    }
                                                </small>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-success btn-sm" @onclick="() => QuickApprove(item.ChoreLogId)" disabled="@_isApproving" title="Bless this labor">
                                                        @if (_approvingId == item.ChoreLogId) 
                                                        { 
                                                            <span class="spinner-border spinner-border-sm"></span> 
                                                        } 
                                                        else 
                                                        { 
                                                            <text>✓ Bless</text> 
                                                        }
                                                    </button>
                                                    <a href="/tracker/@item.Date.ToString("yyyy-MM-dd")" class="btn btn-outline-secondary btn-sm" title="Review in Book of Deeds">
                                                        <span class="bi bi-eye"></span>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            @if (_parentData.PendingApprovals.Count > 5)
                            {
                                <div class="text-center mt-3">
                                    <a href="/tracker" class="btn btn-outline-primary btn-sm">
                                        View All (@_parentData.PendingApprovals.Count)
                                    </a>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header"><h5 class="mb-0">🏛️ Treasury</h5></div>
                    <div class="card-body">
                        @if (_parentData.ChildrenBalances.Count == 0)
                        {
                            <EmptyState Type="EmptyStateType.NoChildren" 
                                        CssClass="empty-state-compact">
                                <ActionButton>
                                    <a href="/admin/users" class="btn btn-primary btn-sm">Add Children</a>
                                </ActionButton>
                            </EmptyState>
                        }
                        else
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var child in _parentData.ChildrenBalances)
                                {
                                    <a href="/ledger/@child.ProfileId" class="list-group-item list-group-item-action d-flex justify-content-between">
                                        <div>
                                            <strong class="user-name">@child.DisplayName</strong>
                                            @if (child.CanCashOut) { <span class="badge bg-success ms-2">Cash out ready!</span> }
                                        </div>
                                        <span class="@(child.Balance >= 0 ? "text-success" : "text-danger") fw-bold fs-5">$@child.Balance.ToString("F2")</span>
                                    </a>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Year Activity Heatmap -->
        <div class="row">
            <div class="col-12 mb-4">
                <YearActivityCard />
            </div>
        </div>
    </div>
}
else if ((_isParent || _isAdmin) && _parentData == null)
{
    @* Parent user but data failed to load *@
    <EmptyState Type="EmptyStateType.Error" 
                Title="Unable to Load Dashboard"
                Message="We couldn't load your parent dashboard data. Please try refreshing the page.">
        <ActionButton>
            <button class="btn btn-primary" @onclick="@(() => LoadDashboardAsync())">Try Again</button>
        </ActionButton>
    </EmptyState>
}
else if (_childData != null)
{
    <!-- Child Dashboard - Redesigned for 13-year-old UX -->
    <div class="child-dashboard">
        @if (_childData.NewAchievements.Count > 0)
        {
            <div class="achievement-celebration">
                @foreach (var achievement in _childData.NewAchievements)
                {
                    <div class="achievement-toast animate-bounce">
                        <span class="achievement-icon">@achievement.Icon</span>
                        <div class="achievement-toast-content">
                            <strong>🎉 Unlocked!</strong>
                            <span class="achievement-toast-name">@achievement.Name</span>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- TODAY HERO: Gamified Level-Up Theme -->
        <div class="today-hero gamified">
            @* Animated background particles *@
            <div class="hero-particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
            
            @* Level Badge *@
            <div class="level-badge-container">
                <div class="level-badge @GetLevelClass()">
                    <span class="level-icon">@GetLevelIcon()</span>
                    <span class="level-number">LVL @GetTodayLevel()</span>
                </div>
                <span class="level-title">@GetLevelTitle()</span>
            </div>
            
            @* XP Progress Bar *@
            <div class="xp-section">
                <div class="xp-header">
                    <span class="xp-label">TODAY'S PROGRESS</span>
                    <span class="xp-value">@_childData.TodayCompletedCount / @_childData.TodayTotalCount XP</span>
                </div>
                <div class="xp-bar-container">
                    <div class="xp-bar">
                        <div class="xp-fill @(GetProgressPercent() == 100 ? "complete" : "")" style="width: @GetProgressPercent()%">
                            <div class="xp-glow"></div>
                        </div>
                    </div>
                    @* Milestone markers *@
                    <div class="xp-milestones">
                        <div class="milestone @(GetProgressPercent() >= 25 ? "achieved" : "")" style="left: 25%">
                            <span class="milestone-icon">⚡</span>
                        </div>
                        <div class="milestone @(GetProgressPercent() >= 50 ? "achieved" : "")" style="left: 50%">
                            <span class="milestone-icon">🔥</span>
                        </div>
                        <div class="milestone @(GetProgressPercent() >= 75 ? "achieved" : "")" style="left: 75%">
                            <span class="milestone-icon">💎</span>
                        </div>
                        <div class="milestone @(GetProgressPercent() >= 100 ? "achieved" : "")" style="left: 100%">
                            <span class="milestone-icon">👑</span>
                        </div>
                    </div>
                </div>
                <div class="xp-status">
                    @if (_childData.TodayTotalCount > 0 && _childData.TodayCompletedCount == _childData.TodayTotalCount)
                    {
                        <span class="status-complete">🎉 QUEST COMPLETE!</span>
                    }
                    else if (_childData.TodayTotalCount > 0)
                    {
                        <span class="status-progress">@(_childData.TodayTotalCount - _childData.TodayCompletedCount) quests remaining</span>
                    }
                    else
                    {
                        <span class="status-rest">😎 Rest Day - No Quests</span>
                    }
                </div>
            </div>
            
            @* Stats Row - Enhanced with Goals & Achievements *@
            <div class="hero-widgets">
                @* Row 1: Balance and Streak *@
                <div class="widget-row primary">
                    <a href="/my-balance" class="hero-stat balance">
                        <span class="hero-stat-icon">💰</span>
                        <AnimatedCounter
                            Value="@_childData.Balance"
                            Prefix="$"
                            CssClass="hero-stat-value"
                            Duration="600" />
                        <span class="hero-stat-label">balance</span>
                    </a>
                    
                    @if (_childData.CurrentStreak > 0)
                    {
                        <div class="hero-stat streak">
                            <span class="hero-stat-icon">🔥</span>
                            <span class="hero-stat-value">@_childData.CurrentStreak</span>
                            <span class="hero-stat-label">day streak</span>
                        </div>
                    }
                    
                    @if (_childData.TodayEarnings > 0)
                    {
                        <div class="hero-stat earnings">
                            <span class="hero-stat-icon">✨</span>
                            <span class="hero-stat-value">+$@_childData.TodayEarnings.ToString("F2")</span>
                            <span class="hero-stat-label">today</span>
                        </div>
                    }
                </div>
                
                @* Row 2: Goal Progress *@
                @if (_childData.PrimaryGoal != null)
                {
                    <a href="/goals" class="widget-card goal-widget">
                        <div class="widget-header">
                            <span class="widget-icon">🎯</span>
                            <span class="widget-title">SAVING FOR</span>
                        </div>
                        <div class="goal-content">
                            <span class="goal-name">@_childData.PrimaryGoal.Name</span>
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" style="width: @_childData.PrimaryGoal.ProgressPercent%"></div>
                            </div>
                            <div class="goal-stats">
                                <span class="goal-current">$@_childData.Balance.ToString("F2")</span>
                                <span class="goal-separator">/</span>
                                <span class="goal-target">$@_childData.PrimaryGoal.TargetAmount.ToString("F2")</span>
                            </div>
                        </div>
                        @if (_childData.PrimaryGoal.CanComplete)
                        {
                            <div class="goal-ready-badge">🎉 Ready!</div>
                        }
                    </a>
                }
                else
                {
                    <a href="/goals" class="widget-card goal-widget empty">
                        <div class="widget-header">
                            <span class="widget-icon">🎯</span>
                            <span class="widget-title">GOALS</span>
                        </div>
                        <div class="goal-empty">
                            <span>Set a savings goal!</span>
                            <span class="goal-cta">Tap to create →</span>
                        </div>
                    </a>
                }
                
                @* Row 3: Achievements *@
                <div class="widget-row achievements">
                    @* Recent Achievement *@
                    @if (_childData.RecentAchievements.Count > 0)
                    {
                        var recent = _childData.RecentAchievements.First();
                        <a href="/achievements" class="widget-card achievement-widget recent">
                            <div class="widget-header">
                                <span class="widget-icon">🏆</span>
                                <span class="widget-title">LATEST</span>
                            </div>
                            <div class="achievement-content">
                                <span class="achievement-badge-icon @GetRarityClass(recent.Rarity)">@recent.Icon</span>
                                <span class="achievement-badge-name">@recent.Name</span>
                            </div>
                            <div class="achievement-points">+@recent.Points pts</div>
                        </a>
                    }
                    else
                    {
                        <a href="/achievements" class="widget-card achievement-widget recent empty">
                            <div class="widget-header">
                                <span class="widget-icon">🏆</span>
                                <span class="widget-title">ACHIEVEMENTS</span>
                            </div>
                            <div class="achievement-empty">
                                <span>Complete quests to unlock!</span>
                            </div>
                        </a>
                    }
                    
                    @* Achievement Progress *@
                    <a href="/achievements" class="widget-card achievement-widget progress">
                        <div class="achievement-score">
                            <span class="score-value">@_childData.AchievementsEarned</span>
                            <span class="score-separator">/</span>
                            <span class="score-total">@_childData.TotalAchievements</span>
                        </div>
                        <span class="achievement-label">BADGES</span>
                        <div class="achievement-mini-bar">
                            <div class="achievement-mini-fill" style="width: @GetAchievementPercent()%"></div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- NEXT UP: Primary action card (most prominent) -->
        @if (_childData.PendingChores.Count > 0)
        {
            var nextChore = _childData.PendingChores.First();
            var remainingChores = _childData.PendingChores.Skip(1).ToList();
            
            <div class="next-up-section">
                <div class="next-up-header">
                    <span class="next-up-badge">NEXT UP</span>
                </div>
                
                <div class="next-up-card">
                    <SwipeableChoreCard 
                        Chore="@nextChore"
                        OnComplete="HandleChoreComplete"
                        OnRequestHelp="HandleHelpRequest"
                        IsProcessing="@(_processingChoreId == nextChore.ChoreDefinitionId)" />
                </div>
                
                <div class="swipe-hint">
                    <div class="swipe-hint-item help">
                        <span class="swipe-hint-arrow">←</span>
                        <span class="swipe-hint-text">Help</span>
                    </div>
                    <span class="swipe-hint-divider">swipe</span>
                    <div class="swipe-hint-item done">
                        <span class="swipe-hint-text">Done</span>
                        <span class="swipe-hint-arrow">→</span>
                    </div>
                </div>
            </div>
            
            <!-- MORE TODAY: Secondary list of remaining chores -->
            @if (remainingChores.Count > 0)
            {
                <div class="more-today-section">
                    <div class="section-header-bar">
                        <span class="section-header-title">More Today</span>
                        <span class="section-header-count">@remainingChores.Count</span>
                    </div>
                    
                    <div class="chore-stack">
                        @foreach (var chore in remainingChores)
                        {
                            <SwipeableChoreCard 
                                Chore="@chore"
                                OnComplete="HandleChoreComplete"
                                OnRequestHelp="HandleHelpRequest"
                                IsProcessing="@(_processingChoreId == chore.ChoreDefinitionId)" />
                        }
                    </div>
                </div>
            }
        }
        else if (_childData.TodayTotalCount > 0)
        {
            <!-- All Done State -->
            <div class="celebration-banner">
                <div class="celebration-icon">⭐</div>
                <div class="celebration-text">
                    <strong>Amazing work!</strong>
                    <span>You finished all your chores today</span>
                </div>
            </div>
        }
        else
        {
            <!-- No Chores Today -->
            <div class="day-off-banner">
                <div class="day-off-icon">😎</div>
                <div class="day-off-text">
                    <strong>Day Off!</strong>
                    <span>No chores scheduled for today</span>
                </div>
            </div>
        }

        <!-- WEEKLY PROGRESS: Shows flexible chores progress -->
        @if (_childData.WeeklyProgress?.ChoreProgress.Count > 0)
        {
            <div class="weekly-section">
                <div class="section-header-bar">
                    <span class="section-header-title">This Week</span>
                    <span class="section-header-subtitle">@GetWeeklyCompletedCount() of @GetWeeklyTotalCount()</span>
                </div>
                <div class="weekly-grid">
                    @foreach (var progress in _childData.WeeklyProgress.ChoreProgress)
                    {
                        var progressPercent = progress.TargetCount > 0 
                            ? Math.Min(100, (progress.CompletedCount * 100 / progress.TargetCount)) 
                            : 0;
                        var isComplete = progress.CompletedCount >= progress.TargetCount;
                        
                        <div class="weekly-item @(isComplete ? "complete" : "")">
                            <span class="weekly-item-icon">@(progress.ChoreDefinition.Icon ?? "📋")</span>
                            <div class="weekly-item-info">
                                <span class="weekly-item-name">@progress.ChoreDefinition.Name</span>
                                <div class="weekly-item-progress">
                                    <div class="weekly-progress-bar">
                                        <div class="weekly-progress-fill" style="width: @progressPercent%"></div>
                                    </div>
                                    <span class="weekly-item-count">@progress.CompletedCount/@progress.TargetCount</span>
                                </div>
                            </div>
                            @if (isComplete)
                            {
                                <span class="weekly-item-check">✓</span>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <!-- COMPLETED: Collapsed section showing finished chores -->
        @if (_childData.CompletedChores.Count > 0)
        {
            <div class="completed-section">
                <button class="completed-toggle" @onclick="ToggleDoneSection">
                    <span class="completed-toggle-title">Completed</span>
                    <span class="completed-toggle-count">@_childData.CompletedChores.Count</span>
                    <span class="completed-toggle-icon bi @(_doneExpanded ? "bi-chevron-up" : "bi-chevron-down")"></span>
                </button>
                
                @if (_doneExpanded)
                {
                    <div class="completed-list">
                        @foreach (var chore in _childData.CompletedChores)
                        {
                            <div class="completed-item @(chore.IsApproved ? "approved" : "pending")">
                                <span class="completed-item-status">
                                    @if (chore.IsApproved)
                                    {
                                        <span class="bi bi-check-circle-fill"></span>
                                    }
                                    else
                                    {
                                        <span class="bi bi-hourglass-split"></span>
                                    }
                                </span>
                                <span class="completed-item-name">@chore.ChoreName</span>
                                @if (chore.EarnValue > 0)
                                {
                                    <span class="completed-item-value @(chore.IsApproved ? "earned" : "")">
                                        @(chore.IsApproved ? "+" : "")$@chore.EarnValue.ToString("F2")
                                    </span>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
}
else
{
    @* Fallback: Authenticated user but no data loaded *@
    <EmptyState Type="EmptyStateType.Error" 
                Title="Unable to Load Dashboard"
                Message="We couldn't load your dashboard data. Please try refreshing the page.">
        <ActionButton>
            <button class="btn btn-primary" @onclick="@(() => LoadDashboardAsync())">Try Again</button>
        </ActionButton>
    </EmptyState>
}

@code {
    private bool _isLoading = true;
    private bool _isAuthenticated;
    private bool _isParent;
    private bool _isAdmin;
    private bool _isAdminOnly;
    private string? _userId;
    private bool _showConfetti;
    private bool _hasTriggeredConfetti;
    private bool _initializationComplete;
    
    // Child dashboard state
    private bool _doneExpanded = false;
    private int? _processingChoreId;

    private ParentDashboardData? _parentData;
    private ChildDashboardData? _childData;

    private bool _isApproving;
    private int? _approvingId;
    
    private CancellationTokenSource? _achievementCts;

    // Gamified theme helper methods
    private int GetProgressPercent()
    {
        if (_childData == null || _childData.TodayTotalCount == 0) return 0;
        return (int)Math.Round((_childData.TodayCompletedCount * 100.0) / _childData.TodayTotalCount);
    }
    
    private int GetAchievementPercent()
    {
        if (_childData == null || _childData.TotalAchievements == 0) return 0;
        return (int)Math.Round((_childData.AchievementsEarned * 100.0) / _childData.TotalAchievements);
    }
    
    private static string GetRarityClass(AchievementRarity rarity)
    {
        return rarity switch
        {
            AchievementRarity.Legendary => "rarity-legendary",
            AchievementRarity.Epic => "rarity-epic",
            AchievementRarity.Rare => "rarity-rare",
            AchievementRarity.Uncommon => "rarity-uncommon",
            _ => "rarity-common"
        };
    }
    
    private int GetTodayLevel()
    {
        var percent = GetProgressPercent();
        return percent switch
        {
            100 => 5,
            >= 75 => 4,
            >= 50 => 3,
            >= 25 => 2,
            > 0 => 1,
            _ => 0
        };
    }
    
    private string GetLevelClass()
    {
        return GetTodayLevel() switch
        {
            5 => "level-legendary",
            4 => "level-epic",
            3 => "level-rare",
            2 => "level-uncommon",
            1 => "level-common",
            _ => "level-starter"
        };
    }
    
    private string GetLevelIcon()
    {
        return GetTodayLevel() switch
        {
            5 => "👑",
            4 => "💎",
            3 => "🔥",
            2 => "⚡",
            1 => "⭐",
            _ => "🌱"
        };
    }
    
    private string GetLevelTitle()
    {
        return GetTodayLevel() switch
        {
            5 => "LEGENDARY",
            4 => "EPIC",
            3 => "RARE",
            2 => "UNCOMMON",
            1 => "COMMON",
            _ => "STARTER"
        };
    }

    private int GetWeeklyCompletedCount()
    {
        if (_childData?.WeeklyProgress?.ChoreProgress == null) return 0;
        return _childData.WeeklyProgress.ChoreProgress.Sum(p => p.CompletedCount);
    }

    private int GetWeeklyTotalCount()
    {
        if (_childData?.WeeklyProgress?.ChoreProgress == null) return 0;
        return _childData.WeeklyProgress.ChoreProgress.Sum(p => p.TargetCount);
    }
    
    private static string GetTimeAgo(DateTime time)
    {
        var diff = DateTime.UtcNow - time;
        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        return $"{(int)diff.TotalDays}d ago";
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            _isAuthenticated = user.Identity?.IsAuthenticated == true;

            if (!_isAuthenticated)
            {
                Logger.LogInformation("User is not authenticated");
                _isLoading = false;
                _initializationComplete = true;
                return;
            }

            _userId = user.FindFirstValue(ClaimTypes.NameIdentifier);
            _isParent = user.IsInRole("Parent");
            _isAdmin = user.IsInRole("Admin");
            _isAdminOnly = user.IsInRole("Admin") && !user.IsInRole("Parent") && !user.IsInRole("Child");

            Logger.LogInformation("User authenticated: UserId={UserId}, IsParent={IsParent}, IsAdmin={IsAdmin}, IsAdminOnly={IsAdminOnly}", 
                _userId, _isParent, _isAdmin, _isAdminOnly);

            // Subscribe to AppStateService events for real-time updates via SignalR
            if (_isParent || _isAdmin)
            {
                AppState.OnParentDashboardChanged += OnParentDashboardStateChanged;
            }
            else
            {
                AppState.OnChildDashboardChanged += OnChildDashboardStateChanged;
            }

            await LoadDashboardAsync(forceRefresh: true);

            Logger.LogInformation("Dashboard loaded: ParentData={ParentData}, ChildData={ChildData}", 
                _parentData != null, _childData != null);

            if (_childData?.NewAchievements.Count > 0 && !string.IsNullOrEmpty(_userId))
            {
                ScheduleAchievementMarking(_userId);
            }
            
            if (_childData != null && 
                _childData.TodayTotalCount > 0 && 
                _childData.TodayCompletedCount == _childData.TodayTotalCount &&
                !_hasTriggeredConfetti)
            {
                _hasTriggeredConfetti = true;
                _ = Task.Delay(500).ContinueWith(_ => 
                {
                    InvokeAsync(() =>
                    {
                        _showConfetti = true;
                        StateHasChanged();
                    });
                });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize dashboard");
        }
        finally
        {
            _isLoading = false;
            _initializationComplete = true;
        }
    }

    private async void OnParentDashboardStateChanged()
    {
        // Refresh parent dashboard when SignalR notification triggers cache invalidation
        await InvokeAsync(async () =>
        {
            await LoadDashboardAsync(forceRefresh: true);
            StateHasChanged();
        });
    }

    private async void OnChildDashboardStateChanged()
    {
        // Refresh child dashboard when SignalR notification triggers cache invalidation
        await InvokeAsync(async () =>
        {
            await LoadDashboardAsync(forceRefresh: true);
            CheckAndTriggerConfetti();
            StateHasChanged();
        });
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initializationComplete && _isAuthenticated)
        {
            try
            {
                await LoadDashboardAsync();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to load dashboard in OnAfterRenderAsync");
            }
        }
    }
    
    private void CheckAndTriggerConfetti()
    {
        if (_childData != null && 
            _childData.TodayTotalCount > 0 && 
            _childData.TodayCompletedCount == _childData.TodayTotalCount &&
            !_hasTriggeredConfetti)
        {
            _hasTriggeredConfetti = true;
            _ = Task.Delay(500).ContinueWith(_ => 
            {
                InvokeAsync(() =>
                {
                    _showConfetti = true;
                    StateHasChanged();
                });
            });
        }
    }
    
    private void ScheduleAchievementMarking(string userId)
    {
        _achievementCts = new CancellationTokenSource();
        var token = _achievementCts.Token;
        
        _ = Task.Run(async () =>
        {
            try
            {
                await Task.Delay(5000, token);
                if (!token.IsCancellationRequested)
                {
                    await AchievementService.MarkAchievementsAsSeenAsync(userId);
                }
            }
            catch (TaskCanceledException)
            {
            }
        }, token);
    }

    private async Task LoadDashboardAsync(bool forceRefresh = false)
    {
        try
        {
            if (_isParent || _isAdmin)
            {
                _parentData = await AppState.GetParentDashboardAsync(forceRefresh);
            }
            else if (!string.IsNullOrEmpty(_userId))
            {
                _childData = await AppState.GetChildDashboardAsync(_userId, forceRefresh);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load dashboard");
            ToastService.ShowError("Error", $"Failed to load dashboard: {ex.Message}");
        }
    }

    private void ToggleDoneSection()
    {
        _doneExpanded = !_doneExpanded;
    }
    
    private async Task HandleChoreComplete(TrackerChoreItem chore)
    {
        if (string.IsNullOrEmpty(_userId) || _childData == null) return;
        if (_processingChoreId.HasValue) return;
        
        _processingChoreId = chore.ChoreDefinitionId;
        StateHasChanged();
        
        try
        {
            var today = DateProvider.Today;
            var result = await DashboardService.ToggleChoreFromDashboardAsync(
                chore.ChoreDefinitionId,
                today,
                _userId);

            if (result.Success && result.Data != null)
            {
                if (result.Data.IsApproved)
                {
                    // Only show amount if it's greater than $0
                    var message = chore.EarnValue > 0 ? $"+${chore.EarnValue:F2}" : null;
                    ToastService.ShowSuccess("Done!", message);
                }
                else if (result.Data.IsCompleted)
                {
                    ToastService.ShowInfo("Marked!", "Waiting for approval");
                }
                
                AppState.InvalidateChildDashboard(_userId);
                await LoadDashboardAsync(forceRefresh: true);
                
                if (!_hasTriggeredConfetti)
                {
                    CheckAndTriggerConfetti();
                }
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to complete chore");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", ex.Message);
        }
        finally
        {
            _processingChoreId = null;
        }
    }
    
    private async Task HandleHelpRequest(TrackerChoreItem chore)
    {
        if (string.IsNullOrEmpty(_userId) || _childData == null) return;
        if (_processingChoreId.HasValue) return;
        
        _processingChoreId = chore.ChoreDefinitionId;
        StateHasChanged();
        
        try
        {
            var today = DateProvider.Today;
            var result = await TrackerService.RequestHelpAsync(
                chore.ChoreDefinitionId,
                today,
                _userId,
                "Need help with this");

            if (result.Success)
            {
                ToastService.ShowInfo("Help Requested", "Your parents have been notified");
                AppState.InvalidateChildDashboard(_userId);
                await LoadDashboardAsync(forceRefresh: true);
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to request help");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", ex.Message);
        }
        finally
        {
            _processingChoreId = null;
        }
    }

    private async Task QuickApprove(int choreLogId)
    {
        if (string.IsNullOrEmpty(_userId)) return;

        _isApproving = true;
        _approvingId = choreLogId;
        StateHasChanged(); // Show spinner immediately

        try
        {
            var result = await DashboardService.QuickApproveAsync(choreLogId, _userId);
            
            if (result.Success)
            {
                ToastService.ShowSuccess("Blessed!", "Labor has been blessed and wages processed.");
                
                // Invalidate caches and reload fresh data
                AppState.InvalidateParentDashboard();
                AppState.InvalidateChildDashboard();
                
                // Reload dashboard with fresh data
                await LoadDashboardAsync(forceRefresh: true);
                
                // Force re-render with updated _parentData
                StateHasChanged();
            }
            else
            {
                ToastService.ShowError("Error", result.ErrorMessage ?? "Failed to bless labor.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "QuickApprove exception: ChoreLogId={ChoreLogId}", choreLogId);
            ToastService.ShowError("Error", ex.Message);
        }
        finally
        {
            _isApproving = false;
            _approvingId = null;
            StateHasChanged(); // Reset button state
        }
    }

    public void Dispose()
    {
        _achievementCts?.Cancel();
        _achievementCts?.Dispose();
        
        // Unsubscribe from state change events
        if (_isParent || _isAdmin)
        {
            AppState.OnParentDashboardChanged -= OnParentDashboardStateChanged;
        }
        else
        {
            AppState.OnChildDashboardChanged -= OnChildDashboardStateChanged;
        }
    }
}
