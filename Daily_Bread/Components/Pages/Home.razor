@page "/"
@rendermode InteractiveServer

@using System.Security.Claims
@using Daily_Bread.Data.Models
@using Daily_Bread.Services

@inject IDashboardService DashboardService
@inject IAchievementService AchievementService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Daily Bread - Home</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (_isLoading)
        {
            <div class="d-flex justify-content-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (_isAdminOnly)
        {
            <div class="text-center py-5">
                <span class="bi bi-people-fill display-1 text-muted"></span>
                <h2 class="mt-3">Admin Account</h2>
                <p class="text-muted">This account is for user management only.</p>
                <a href="/admin/users" class="btn btn-primary btn-lg">
                    <span class="bi bi-people-fill me-2"></span>Go to User Management
                </a>
            </div>
        }
        else if (_isParent && _parentData != null)
        {
            <!-- Parent Dashboard -->
            <div class="dashboard-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>Welcome back!</h1>
                    <span class="text-muted">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</span>
                </div>

                @if (!string.IsNullOrEmpty(_successMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @_successMessage
                        <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @_errorMessage
                        <button type="button" class="btn-close" @onclick="() => _errorMessage = null"></button>
                    </div>
                }

                <div class="row mb-4 g-3">
                    <div class="col-md-3 col-6">
                        <div class="summary-card h-100">
                            <span class="summary-value text-warning">@_parentData.PendingApprovals.Count</span>
                            <span class="summary-label">Pending Approvals</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="summary-card h-100">
                            <span class="summary-value text-info">@_parentData.TodayCompletedCount</span>
                            <span class="summary-label">Completed Today</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="summary-card h-100">
                            <span class="summary-value text-success">@_parentData.TodayApprovedCount</span>
                            <span class="summary-label">Approved Today</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="summary-card h-100">
                            <span class="summary-value">@_parentData.TodayPendingCount</span>
                            <span class="summary-label">Still Pending</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><span class="bi bi-check2-circle me-2"></span>Pending Approvals</h5>
                                @if (_parentData.PendingApprovals.Count > 0)
                                {
                                    <span class="badge bg-warning text-dark">@_parentData.PendingApprovals.Count</span>
                                }
                            </div>
                            <div class="card-body">
                                @if (_parentData.PendingApprovals.Count == 0)
                                {
                                    <div class="text-center py-4 text-muted">
                                        <span class="bi bi-check-circle display-4"></span>
                                        <p class="mt-2 mb-0">All caught up!</p>
                                    </div>
                                }
                                else
                                {
                                    <div class="list-group list-group-flush">
                                        @foreach (var item in _parentData.PendingApprovals.Take(5))
                                        {
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>@item.ChoreName</strong><br />
                                                    <small>@item.ChildName • @item.Date.ToString("MMM d")</small>
                                                </div>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="text-success fw-bold">$@item.Value.ToString("F2")</span>
                                                    <button class="btn btn-success btn-sm" @onclick="() => QuickApprove(item.ChoreLogId)" disabled="@_isApproving">
                                                        @if (_approvingId == item.ChoreLogId) { <span class="spinner-border spinner-border-sm"></span> } else { <span class="bi bi-check-lg"></span> }
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header"><h5 class="mb-0"><span class="bi bi-wallet2 me-2"></span>Balances</h5></div>
                            <div class="card-body">
                                @if (_parentData.ChildrenBalances.Count == 0)
                                {
                                    <div class="text-center py-4 text-muted">
                                        <p class="mb-0">No children set up yet.</p>
                                    </div>
                                }
                                else
                                {
                                    <div class="list-group list-group-flush">
                                        @foreach (var child in _parentData.ChildrenBalances)
                                        {
                                            <a href="/ledger/@child.ProfileId" class="list-group-item list-group-item-action d-flex justify-content-between">
                                                <div>
                                                    <strong>@child.DisplayName</strong>
                                                    @if (child.CanCashOut) { <span class="badge bg-success ms-2">Cash out ready!</span> }
                                                </div>
                                                <span class="@(child.Balance >= 0 ? "text-success" : "text-danger") fw-bold fs-5">$@child.Balance.ToString("F2")</span>
                                            </a>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (_childData != null)
        {
            <!-- Child Dashboard -->
            <div class="child-dashboard">
                @if (_childData.NewAchievements.Count > 0)
                {
                    <div class="achievement-celebration">
                        @foreach (var achievement in _childData.NewAchievements)
                        {
                            <div class="achievement-toast animate-bounce">
                                <span class="achievement-icon">@achievement.Icon</span>
                                <div>
                                    <strong>Achievement Unlocked!</strong><br />
                                    <span>@achievement.Name</span>
                                </div>
                            </div>
                        }
                    </div>
                }

                <div class="text-center mb-4">
                    <h1 class="display-5">Hey, @_childData.DisplayName! <span class="wave">👋</span></h1>
                    <p class="text-muted mb-2">@DateTime.Now.ToString("dddd, MMMM d")</p>
                    
                    @if (_childData.CurrentStreak > 0)
                    {
                        <div class="streak-display">
                            <span class="streak-fire @(_childData.CurrentStreak >= 7 ? "animate-pulse" : "")">
                                <span class="bi bi-fire"></span>
                            </span>
                            <span class="streak-count">@_childData.CurrentStreak day streak!</span>
                            @if (_childData.BestStreak > _childData.CurrentStreak)
                            {
                                <small class="text-white-50 d-block">Best: @_childData.BestStreak days</small>
                            }
                        </div>
                    }
                </div>

                <div class="row mb-4 g-3">
                    <div class="col-md-6">
                        <div class="card balance-card h-100">
                            <div class="card-body text-center">
                                <p class="text-muted mb-1"><span class="bi bi-wallet2"></span> Your Balance</p>
                                <h1 class="display-4 fw-bold text-success mb-2">$@_childData.Balance.ToString("F2")</h1>
                                @if (_childData.CanCashOut)
                                {
                                    <a href="/my-balance" class="btn btn-success">
                                        <span class="bi bi-cash-stack"></span> Cash Out Ready!
                                    </a>
                                }
                                else
                                {
                                    <div class="progress mb-2">
                                        @{ var cashOutProgress = _childData.CashOutThreshold > 0 ? Math.Min(100, (_childData.Balance / _childData.CashOutThreshold) * 100) : 0; }
                                        <div class="progress-bar bg-success" style="width: @cashOutProgress.ToString("F0")%;"></div>
                                    </div>
                                    <small class="text-muted">$@((_childData.CashOutThreshold - _childData.Balance).ToString("F2")) to cash out</small>
                                }
                                <div class="mt-2">
                                    <small class="text-muted">Lifetime: $@_childData.TotalLifetimeEarnings.ToString("F2")</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        @if (_childData.PrimaryGoal != null)
                        {
                            <div class="card savings-goal-card h-100">
                                <div class="card-body text-center">
                                    <p class="text-muted mb-1"><span class="bi bi-bullseye"></span> Saving For</p>
                                    <h4 class="fw-bold">@_childData.PrimaryGoal.Name</h4>
                                    @if (!string.IsNullOrEmpty(_childData.PrimaryGoal.ImageUrl))
                                    {
                                        <img src="@_childData.PrimaryGoal.ImageUrl" alt="@_childData.PrimaryGoal.Name" class="goal-image my-2" />
                                    }
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-info progress-bar-striped" style="width: @_childData.PrimaryGoal.ProgressPercent%;
                                            transition: width 0.6s ease;">
                                            @_childData.PrimaryGoal.ProgressPercent%
                                        </div>
                                    </div>
                                    <p class="mb-0">
                                        <span class="text-success fw-bold">$@_childData.Balance.ToString("F2")</span>
                                        <span class="text-muted"> / $@_childData.PrimaryGoal.TargetAmount.ToString("F2")</span>
                                    </p>
                                    @if (_childData.PrimaryGoal.CanComplete)
                                    {
                                        <span class="badge bg-success mt-2"><span class="bi bi-check-circle"></span> You can afford this!</span>
                                    }
                                    else
                                    {
                                        <small class="text-muted">$@_childData.PrimaryGoal.AmountRemaining.ToString("F2") to go!</small>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="card h-100">
                                <div class="card-body text-center d-flex flex-column justify-content-center">
                                    <span class="bi bi-bullseye display-4 text-info"></span>
                                    <p class="mb-2">Set a savings goal!</p>
                                    <a href="/goals" class="btn btn-outline-primary btn-sm">Create Goal</a>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="card mb-4 weekly-stats-card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <p class="text-muted mb-1 small">This Week</p>
                                <h3 class="text-success mb-0">$@_childData.WeeklyStats.ThisWeekEarnings.ToString("F2")</h3>
                                <small class="text-muted">@_childData.WeeklyStats.ThisWeekChoresCompleted chores</small>
                            </div>
                            <div class="col-6">
                                <p class="text-muted mb-1 small">vs Last Week</p>
                                <h3 class="@(_childData.WeeklyStats.IsImprovement ? "text-success" : "text-danger") mb-0">
                                    @(_childData.WeeklyStats.EarningsChange >= 0 ? "+" : "")$@_childData.WeeklyStats.EarningsChange.ToString("F2")
                                </h3>
                                <small class="@(_childData.WeeklyStats.IsImprovement ? "text-success" : "text-danger")">
                                    @if (_childData.WeeklyStats.EarningsChangePercent != 0)
                                    {
                                        var pct = Math.Abs(_childData.WeeklyStats.EarningsChangePercent);
                                        <text>@(_childData.WeeklyStats.IsImprovement ? "↑" : "↓") @(pct)%</text>
                                    }
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><span class="bi bi-list-check"></span> Today's Chores</h5>
                        @if (_childData.TodayTotalCount > 0)
                        {
                            <span class="badge @(_childData.TodayCompletedCount == _childData.TodayTotalCount ? "bg-success" : "bg-warning text-dark")">
                                @_childData.TodayCompletedCount / @_childData.TodayTotalCount done
                            </span>
                        }
                    </div>
                    <div class="card-body p-2">
                        @if (_childData.TodayChores.Count == 0)
                        {
                            <div class="text-center py-4">
                                <span class="bi bi-emoji-sunglasses display-4 text-warning"></span>
                                <h4 class="mt-2">Day Off!</h4>
                                <p class="text-muted">No chores scheduled for today. Enjoy!</p>
                            </div>
                        }
                        else
                        {
                            <div class="chore-checklist">
                                @foreach (var chore in _childData.TodayChores)
                                {
                                    <a href="/tracker" class="chore-item @GetChoreItemClass(chore)">
                                        <div class="chore-checkbox">
                                            @if (chore.IsApproved)
                                            {
                                                <span class="check-icon approved bi bi-check-lg"></span>
                                            }
                                            else if (chore.IsCompleted)
                                            {
                                                <span class="check-icon pending bi bi-hourglass-split"></span>
                                            }
                                            else if (chore.IsMissed)
                                            {
                                                <span class="check-icon missed bi bi-x-lg"></span>
                                            }
                                            else
                                            {
                                                <span class="check-icon empty"></span>
                                            }
                                        </div>
                                        <div class="chore-details">
                                            <span class="chore-name">@chore.ChoreName</span>
                                            @if (chore.IsCompleted && !chore.IsApproved)
                                            {
                                                <small class="text-info">Waiting for approval...</small>
                                            }
                                        </div>
                                        <div class="chore-value">$@chore.Value.ToString("F2")</div>
                                    </a>
                                }
                            </div>

                            @if (_childData.TodayPendingCount > 0)
                            {
                                <div class="text-center mt-3">
                                    <a href="/tracker" class="btn btn-primary btn-lg pulse-button">
                                        <span class="bi bi-check2-square"></span> Do Your Chores! ($@_childData.TodayPotentialEarnings.ToString("F2") possible)
                                    </a>
                                </div>
                            }
                            else if (_childData.TodayCompletedCount == _childData.TodayTotalCount && _childData.TodayTotalCount > 0)
                            {
                                <div class="text-center mt-3 all-done-celebration">
                                    <span class="bi bi-star-fill display-4 text-warning"></span>
                                    <h4 class="text-success">All Done Today!</h4>
                                </div>
                            }
                        }
                    </div>
                </div>

                @if (_childData.RecentAchievements.Count > 0)
                {
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><span class="bi bi-trophy"></span> Achievements</h5>
                            <span class="badge bg-primary">@_childData.AchievementsEarned / @_childData.TotalAchievements</span>
                        </div>
                        <div class="card-body">
                            <div class="achievements-grid">
                                @foreach (var achievement in _childData.RecentAchievements)
                                {
                                    <div class="achievement-badge @(achievement.IsNew ? "new" : "")">
                                        <span class="badge-icon">@achievement.Icon</span>
                                        <span class="badge-name">@achievement.Name</span>
                                    </div>
                                }
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">@_childData.TotalAchievementPoints total points</small>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="text-center py-5">
            <h1 class="display-4 mb-3"><span class="bi bi-house-heart-fill"></span> Daily Bread</h1>
            <p class="lead text-muted mb-4">A family chore tracker that helps kids earn their daily bread.</p>
            <hr class="my-4" />
            <p class="mb-4">Track chores, earn rewards, and learn the value of hard work!</p>
            <a href="/Account/Login" class="btn btn-primary btn-lg">
                <span class="bi bi-box-arrow-in-right me-2"></span>Login to Get Started
            </a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool _isLoading = true;
    private bool _isParent;
    private bool _isAdmin;
    private bool _isAdminOnly;
    private string? _userId;
    private string? _successMessage;
    private string? _errorMessage;

    private ParentDashboardData? _parentData;
    private ChildDashboardData? _childData;

    private bool _isApproving;
    private int? _approvingId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _userId = user.FindFirstValue(ClaimTypes.NameIdentifier);
            _isParent = user.IsInRole("Parent");
            _isAdmin = user.IsInRole("Admin");
            _isAdminOnly = user.IsInRole("Admin") && !user.IsInRole("Parent");

            await LoadDashboardAsync();

            // Mark achievements as seen after displaying
            if (_childData?.NewAchievements.Count > 0 && !string.IsNullOrEmpty(_userId))
            {
                _ = Task.Run(async () =>
                {
                    await Task.Delay(5000); // Wait 5 seconds before marking as seen
                    await AchievementService.MarkAchievementsAsSeenAsync(_userId);
                });
            }
        }

        _isLoading = false;
    }

    private async Task LoadDashboardAsync()
    {
        try
        {
            if (_isParent || _isAdmin)
            {
                _parentData = await DashboardService.GetParentDashboardAsync();
            }
            else if (!string.IsNullOrEmpty(_userId))
            {
                _childData = await DashboardService.GetChildDashboardAsync(_userId);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading dashboard: {ex.Message}";
        }
    }

    private async Task QuickApprove(int choreLogId)
    {
        if (string.IsNullOrEmpty(_userId)) return;

        _isApproving = true;
        _approvingId = choreLogId;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            var result = await DashboardService.QuickApproveAsync(choreLogId, _userId);
            if (result.Success)
            {
                _successMessage = "Chore approved!";
                await LoadDashboardAsync();
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isApproving = false;
            _approvingId = null;
        }
    }

    private static string GetChoreItemClass(TrackerChoreItem chore)
    {
        if (chore.IsApproved) return "approved";
        if (chore.IsCompleted) return "completed";
        if (chore.IsMissed) return "missed";
        return "";
    }
}
