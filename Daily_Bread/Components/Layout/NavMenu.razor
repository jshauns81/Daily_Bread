@using Daily_Bread.Services
@using Daily_Bread.Components.Shared.Navigation
@implements IDisposable
@inject INavigationService NavigationService
@inject IAppStateService AppState
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="nav-header">
    <a class="nav-brand" href="">
        <img src="images/bread-icon.png" alt="" class="nav-brand-icon" />
        <span class="nav-brand-text">Daily Bread</span>
    </a>
</div>

<nav class="nav-menu" role="navigation">
    <AuthorizeView>
        <Authorized>
            @{ var lastSection = (string?)null; }
            @foreach (var item in _navItems)
            {
                @if (!string.IsNullOrEmpty(item.Section) && item.Section != lastSection)
                {
                    lastSection = item.Section;
                    <div class="nav-section-divider"></div>
                    <div class="nav-section-label">@item.Section</div>
                }
                
                <NavLink class="nav-link" href="@item.Route.TrimStart('/')" Match="@GetNavLinkMatch(item.Route)" @onclick="HandleNavigation">
                    <span class="bi @item.Icon" aria-hidden="true"></span>
                    <span class="nav-link-text">@item.Label</span>
                    @if (HasPendingBadge(item))
                    {
                        <span class="nav-badge">@_pendingCount</span>
                    }
                </NavLink>
            }
        </Authorized>
    </AuthorizeView>
</nav>

@if (_isStandalone)
{
    <div class="nav-footer">
        <a href="/kid" class="kid-mode-link" @onclick="HandleNavigation">
            <span class="bi bi-phone" aria-hidden="true"></span>
            <span>Quick PIN Login</span>
        </a>
    </div>
}

@code {
    [Parameter]
    public EventCallback OnNavigate { get; set; }

    private IReadOnlyList<NavItem> _navItems = [];
    private int _pendingCount;
    private bool _isParent;
    private bool _isChild;
    private bool _isAdmin;
    private bool _isStandalone;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isParent = user.IsInRole("Parent");
        _isChild = user.IsInRole("Child");
        _isAdmin = user.IsInRole("Admin");
        
        // Get navigation items from centralized service
        _navItems = NavigationService.GetDesktopNavItems(_isParent, _isChild, _isAdmin);

        // For parents, get pending count from cached data (no DB query)
        // The count will update when OnParentDashboardChanged fires
        if (_isParent)
        {
            RefreshPendingCountFromCache();
            
            // Subscribe to parent dashboard changes to refresh the badge
            AppState.OnParentDashboardChanged += OnParentDashboardChanged;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _isStandalone = await JS.InvokeAsync<bool>("dailyBread.isStandalone");
                StateHasChanged();
            }
            catch
            {
                // JS interop not available (e.g., prerendering), default to false
                _isStandalone = false;
            }
            
            // For parents, if cache doesn't have data yet, load it proactively
            // This ensures the badge shows even when navigating directly to non-home pages
            if (_isParent && _pendingCount == 0)
            {
                try
                {
                    var data = await AppState.GetParentDashboardAsync(forceRefresh: false);
                    if (data != null)
                    {
                        _pendingCount = data.PendingApprovals.Count;
                        StateHasChanged();
                    }
                }
                catch
                {
                    // Silent fail - not critical if badge doesn't show initially
                }
            }
        }
    }

    /// <summary>
    /// Gets the pending count from AppStateService's cached data.
    /// Does NOT trigger a database query - uses data already loaded by Home page.
    /// </summary>
    private void RefreshPendingCountFromCache()
    {
        _pendingCount = AppState.CachedPendingApprovalsCount;
    }
    
    private void OnParentDashboardChanged()
    {
        // When parent dashboard changes, the cache will have fresh data
        // Just read the count from cache (no DB query)
        RefreshPendingCountFromCache();
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleNavigation()
    {
        if (OnNavigate.HasDelegate)
        {
            await OnNavigate.InvokeAsync();
        }
    }
    
    /// <summary>
    /// Determines the NavLinkMatch for a given route.
    /// Home ("/") uses All to match exactly, others use Prefix.
    /// </summary>
    private static NavLinkMatch GetNavLinkMatch(string route)
    {
        return route == "/" ? NavLinkMatch.All : NavLinkMatch.Prefix;
    }
    
    /// <summary>
    /// Checks if a nav item should show the pending approvals badge.
    /// Only shows on Book of Deeds for parents with pending items.
    /// </summary>
    private bool HasPendingBadge(NavItem item)
    {
        return _isParent && _pendingCount > 0 && item.Route == "/tracker";
    }
    
    public void Dispose()
    {
        // Unsubscribe from events to prevent memory leaks
        if (_isParent)
        {
            AppState.OnParentDashboardChanged -= OnParentDashboardChanged;
        }
    }
}

