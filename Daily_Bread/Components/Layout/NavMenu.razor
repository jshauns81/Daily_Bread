@using Daily_Bread.Services
@using Daily_Bread.Components.Shared.Navigation
@inject INavigationService NavigationService
@inject IDashboardService DashboardService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

<div class="nav-header">
    <a class="nav-brand" href="">
        <img src="images/bread-icon.png" alt="" class="nav-brand-icon" />
        <span class="nav-brand-text">Daily Bread</span>
    </a>
</div>

<nav class="nav-menu" role="navigation">
    <AuthorizeView>
        <Authorized>
            @{
                string? currentSection = null;
            }
            @foreach (var item in _navItems)
            {
                @* Render section label if it changes *@
                @if (item.Section != currentSection && !string.IsNullOrEmpty(item.Section))
                {
                    currentSection = item.Section;
                    <div class="nav-section-label">@item.Section</div>
                }
                
                <NavLink class="nav-link" href="@item.Route.TrimStart('/')" Match="@GetNavLinkMatch(item.Route)" @onclick="HandleNavigation">
                    <span class="bi @item.Icon" aria-hidden="true"></span>
                    <span class="nav-link-text">@item.Label</span>
                </NavLink>
            }
            
            @* Pending approvals alert - shown for parents when there are pending items *@
            @if (_isParent && _pendingCount > 0)
            {
                <NavLink class="nav-link nav-link-alert" href="" Match="NavLinkMatch.All" @onclick="HandleNavigation">
                    <span class="bi bi-exclamation-circle-fill" aria-hidden="true"></span>
                    <span class="nav-link-text">Blessings</span>
                    <span class="nav-badge">@_pendingCount</span>
                </NavLink>
            }
        </Authorized>
    </AuthorizeView>
</nav>

@if (_isStandalone)
{
    <div class="nav-footer">
        <a href="/kid" class="kid-mode-link" @onclick="HandleNavigation">
            <span class="bi bi-phone" aria-hidden="true"></span>
            <span>Quick PIN Login</span>
        </a>
    </div>
}

@code {
    [Parameter]
    public EventCallback OnNavigate { get; set; }

    private IReadOnlyList<NavItem> _navItems = [];
    private int _pendingCount;
    private bool _isParent;
    private bool _isChild;
    private bool _isAdmin;
    private bool _isStandalone;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isParent = user.IsInRole("Parent");
        _isChild = user.IsInRole("Child");
        _isAdmin = user.IsInRole("Admin");
        
        // Get navigation items from centralized service
        _navItems = NavigationService.GetDesktopNavItems(_isParent, _isChild, _isAdmin);

        // Load pending count for parents
        if (_isParent)
        {
            try
            {
                _pendingCount = await DashboardService.GetPendingApprovalsCountAsync();
            }
            catch
            {
                _pendingCount = 0;
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _isStandalone = await JS.InvokeAsync<bool>("dailyBread.isStandalone");
                StateHasChanged();
            }
            catch
            {
                // JS interop not available (e.g., prerendering), default to false
                _isStandalone = false;
            }
        }
    }

    private async Task HandleNavigation()
    {
        if (OnNavigate.HasDelegate)
        {
            await OnNavigate.InvokeAsync();
        }
    }
    
    /// <summary>
    /// Determines the NavLinkMatch for a given route.
    /// Home ("/") uses All to match exactly, others use Prefix.
    /// </summary>
    private static NavLinkMatch GetNavLinkMatch(string route)
    {
        return route == "/" ? NavLinkMatch.All : NavLinkMatch.Prefix;
    }
}

