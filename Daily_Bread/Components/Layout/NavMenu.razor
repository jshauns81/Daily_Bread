@using Daily_Bread.Services
@inject IDashboardService DashboardService
@inject AuthenticationStateProvider AuthStateProvider

<div class="nav-header">
    <a class="nav-brand" href="">
        <img src="images/bread-icon.png" alt="" class="nav-brand-icon" />
        <span class="nav-brand-text">Daily Bread</span>
    </a>
</div>

<nav class="nav-menu" role="navigation">
    @if (!_isAdminOnly)
    {
        <NavLink class="nav-link" href="" Match="NavLinkMatch.All" @onclick="HandleNavigation">
            <span class="bi bi-house-door-fill" aria-hidden="true"></span>
            <span class="nav-link-text">Home</span>
        </NavLink>
    }

    <AuthorizeView>
        <Authorized>
            @if (!_isAdminOnly)
            {
                <NavLink class="nav-link" href="tracker" @onclick="HandleNavigation">
                    <span class="bi bi-check2-square" aria-hidden="true"></span>
                    <span class="nav-link-text">Tracker</span>
                </NavLink>
                
                <NavLink class="nav-link" href="calendar" @onclick="HandleNavigation">
                    <span class="bi bi-calendar3" aria-hidden="true"></span>
                    <span class="nav-link-text">Calendar</span>
                </NavLink>
                
                @if (!_isParentOnly)
                {
                    <NavLink class="nav-link" href="my-balance" @onclick="HandleNavigation">
                        <span class="bi bi-wallet2" aria-hidden="true"></span>
                        <span class="nav-link-text">My Balance</span>
                    </NavLink>
                    
                    <NavLink class="nav-link" href="goals" @onclick="HandleNavigation">
                        <span class="bi bi-bullseye" aria-hidden="true"></span>
                        <span class="nav-link-text">Goals</span>
                    </NavLink>
                }
            }
        </Authorized>
    </AuthorizeView>

    <AuthorizeView Roles="Parent">
        <Authorized>
            <div class="nav-section-label">Management</div>
            
            <NavLink class="nav-link" href="chore-planner" @onclick="HandleNavigation">
                <span class="bi bi-calendar-check" aria-hidden="true"></span>
                <span class="nav-link-text">Chore Planner</span>
            </NavLink>
            
            <NavLink class="nav-link" href="ledger" @onclick="HandleNavigation">
                <span class="bi bi-journal-text" aria-hidden="true"></span>
                <span class="nav-link-text">Ledger</span>
            </NavLink>
            
            <NavLink class="nav-link" href="settings" @onclick="HandleNavigation">
                <span class="bi bi-gear-fill" aria-hidden="true"></span>
                <span class="nav-link-text">Settings</span>
            </NavLink>
            
            @if (_pendingCount > 0)
            {
                <NavLink class="nav-link nav-link-alert" href="/" @onclick="HandleNavigation">
                    <span class="bi bi-exclamation-circle-fill" aria-hidden="true"></span>
                    <span class="nav-link-text">Approvals</span>
                    <span class="nav-badge">@_pendingCount</span>
                </NavLink>
            }
        </Authorized>
    </AuthorizeView>

    <AuthorizeView Roles="Admin">
        <Authorized>
            <div class="nav-section-label">Admin</div>
            
            <NavLink class="nav-link" href="admin/users" @onclick="HandleNavigation">
                <span class="bi bi-people-fill" aria-hidden="true"></span>
                <span class="nav-link-text">Users</span>
            </NavLink>
        </Authorized>
    </AuthorizeView>
</nav>

<div class="nav-footer">
    <a href="/kid" class="kid-mode-link" @onclick="HandleNavigation">
        <span class="bi bi-phone" aria-hidden="true"></span>
        <span>Quick PIN Login</span>
    </a>
</div>

@code {
    [Parameter]
    public EventCallback OnNavigate { get; set; }

    private int _pendingCount;
    private bool _isAdminOnly;
    private bool _isParentOnly;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isAdminOnly = user.IsInRole("Admin") && !user.IsInRole("Parent") && !user.IsInRole("Child");
        _isParentOnly = user.IsInRole("Parent") && !user.IsInRole("Child");

        if (user.IsInRole("Parent"))
        {
            try
            {
                _pendingCount = await DashboardService.GetPendingApprovalsCountAsync();
            }
            catch
            {
                _pendingCount = 0;
            }
        }
    }

    private async Task HandleNavigation()
    {
        if (OnNavigate.HasDelegate)
        {
            await OnNavigate.InvokeAsync();
        }
    }
}

