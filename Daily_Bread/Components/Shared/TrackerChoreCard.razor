@namespace Daily_Bread.Components.Shared
@using Daily_Bread.Data.Models
@using Daily_Bread.Helpers
@using Daily_Bread.Services

<div class="tracker-card @GetCardClass()">
    @* Status Indicator - aligned with desktop design *@
    <div class="card-indicator">
        <button class="status-button @ChoreDisplayHelper.GetCheckboxClass(Item.Status, Item.IsCompleted)"
                disabled="@IsDisabled"
                @onclick="OnToggleClicked"
                title="@GetTooltip()">
            <span class="bi @ChoreDisplayHelper.GetStatusIcon(Item.Status)"></span>
        </button>
    </div>
    
    @* Card Content *@
    <div class="card-content">
        <div class="chore-info">
            <span class="chore-name">
                @Item.ChoreName
            </span>
            <div class="chore-meta">
                @if (ShowAssignee && !string.IsNullOrEmpty(Item.AssignedUserName))
                {
                    <span class="user-name">@Item.AssignedUserName</span>
                    <span class="meta-separator">•</span>
                }
                <span class="status-badge @ChoreDisplayHelper.GetStatusBadgeClass(Item.Status)">
                    @ChoreDisplayHelper.GetStatusBadgeText(Item.Status)
                </span>
            </div>
            @* Help reason displayed inline *@
            @if (Item.IsHelp && !string.IsNullOrEmpty(Item.HelpReason))
            {
                <span class="help-reason">"@Item.HelpReason"</span>
            }
        </div>
    </div>
    
    @* Value and Actions *@
    <div class="card-right">
        @if (Item.Value > 0)
        {
            <span class="value-amount @GetValueClass()">
                @(Item.IsApproved ? "+" : "")$@Item.Value.ToString("F2")
            </span>
        }
        
        @if (ShowActions)
        {
            <div class="card-actions">
                @switch (Item.Status)
                {
                    case ChoreStatus.Completed:
                        <button class="action-btn action-approve" @onclick="OnApproveClicked" title="Approve">
                            <span class="bi bi-check2-circle"></span>
                        </button>
                        break;
                        
                    case ChoreStatus.Help:
                        <button class="action-btn action-respond" @onclick="OnRespondToHelpClicked" title="Respond">
                            <span class="bi bi-chat-heart"></span>
                        </button>
                        break;
                        
                    case ChoreStatus.Pending:
                        <button class="action-link" @onclick="OnSkipClicked" title="Excuse">
                            Excuse
                        </button>
                        break;
                        
                    case ChoreStatus.Approved:
                    case ChoreStatus.Missed:
                    case ChoreStatus.Skipped:
                        <button class="action-link" @onclick="OnResetClicked" title="Restore">
                            @(Item.IsApproved ? "Undo" : "Restore")
                        </button>
                        break;
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public required TrackerChoreItem Item { get; set; }

    [Parameter]
    public bool IsDisabled { get; set; }

    [Parameter]
    public bool ShowAssignee { get; set; }

    [Parameter]
    public bool ShowActions { get; set; }

    [Parameter]
    public EventCallback<TrackerChoreItem> OnToggle { get; set; }

    [Parameter]
    public EventCallback<TrackerChoreItem> OnApprove { get; set; }

    [Parameter]
    public EventCallback<TrackerChoreItem> OnSkip { get; set; }
    
    [Parameter]
    public EventCallback<TrackerChoreItem> OnReset { get; set; }
    
    [Parameter]
    public EventCallback<TrackerChoreItem> OnRespondToHelp { get; set; }

    private string GetCardClass() => Item.Status switch
    {
        ChoreStatus.Help => "card-help",
        ChoreStatus.Completed => "card-awaiting",
        ChoreStatus.Approved => "card-approved",
        ChoreStatus.Missed => "card-missed",
        ChoreStatus.Skipped => "card-excused",
        _ => "card-pending"
    };

    private string GetValueClass() => Item.Status switch
    {
        ChoreStatus.Approved => "earned",
        ChoreStatus.Missed => "penalty",
        _ => ""
    };

    private string GetTooltip() => Item.Status switch
    {
        ChoreStatus.Approved => "Approved ✓✓",
        ChoreStatus.Completed => "Awaiting review",
        ChoreStatus.Help => "Help requested",
        ChoreStatus.Missed => "Not completed",
        ChoreStatus.Skipped => "Excused",
        _ => "Mark as done"
    };

    private async Task OnToggleClicked() => await OnToggle.InvokeAsync(Item);
    private async Task OnApproveClicked() => await OnApprove.InvokeAsync(Item);
    private async Task OnSkipClicked() => await OnSkip.InvokeAsync(Item);
    private async Task OnResetClicked() => await OnReset.InvokeAsync(Item);
    private async Task OnRespondToHelpClicked() => await OnRespondToHelp.InvokeAsync(Item);
}
