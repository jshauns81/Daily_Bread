@namespace Daily_Bread.Components.Shared

<div class="password-input-wrapper">
    <div class="input-group">
        <input type="@(_showPassword ? "text" : "password")" 
               id="@InputId"
               name="@Name"
               class="form-control @CssClass" 
               value="@Value"
               @oninput="OnInput"
               @onchange="OnChange"
               placeholder="@Placeholder"
               autocomplete="@Autocomplete"
               autocapitalize="off"
               autocorrect="off"
               spellcheck="false"
               aria-required="@Required.ToString().ToLower()"
               disabled="@Disabled" />
        <button type="button" 
                class="btn btn-outline-secondary password-toggle" 
                @onmousedown="HandleMouseDown"
                @onmouseup="HandleMouseUp"
                @onmouseleave="HandleMouseLeave"
                @ontouchstart="HandleTouchStart"
                @ontouchend="HandleTouchEnd"
                @ontouchcancel="HandleTouchCancel"
                @onclick:preventDefault
                tabindex="-1"
                aria-label="@(_showPassword ? "Hide password" : "Show password")"
                title="@(_showPassword ? "Hide password" : "Show password")">
            <span class="bi @(_showPassword ? "bi-eye-slash" : "bi-eye")"></span>
        </button>
    </div>
    @if (!string.IsNullOrEmpty(HelpText))
    {
        <small class="text-muted">@HelpText</small>
    }
</div>

@code {
    [Parameter]
    public string Value { get; set; } = "";

    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    [Parameter]
    public string Placeholder { get; set; } = "Enter password";

    [Parameter]
    public string Autocomplete { get; set; } = "current-password";

    [Parameter]
    public bool Required { get; set; } = true;

    [Parameter]
    public bool Disabled { get; set; } = false;

    [Parameter]
    public string CssClass { get; set; } = "";

    [Parameter]
    public string HelpText { get; set; } = "";

    [Parameter]
    public string Name { get; set; } = "";

    [Parameter]
    public string InputId { get; set; } = "";

    private bool _showPassword = false;
    private bool _isHolding = false;
    private System.Threading.Timer? _holdTimer;
    private long _pressStartTime = 0;

    // Mouse events for desktop - supporting both toggle and press-and-hold
    private void HandleMouseDown(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        _pressStartTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
        
        // Start a timer to detect if this is a press-and-hold (>300ms)
        _holdTimer?.Dispose();
        _holdTimer = new System.Threading.Timer(_ =>
        {
            // This is a press-and-hold - temporarily show password
            InvokeAsync(() =>
            {
                _isHolding = true;
                _showPassword = true;
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }
    
    private void HandleMouseUp(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        var pressDuration = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - _pressStartTime;
        
        _holdTimer?.Dispose();
        _holdTimer = null;
        
        if (_isHolding)
        {
            // Was a hold - revert to hidden
            _showPassword = false;
            _isHolding = false;
        }
        else if (pressDuration < 300)
        {
            // Quick click - toggle permanently
            _showPassword = !_showPassword;
        }
        
        StateHasChanged();
    }
    
    private void HandleMouseLeave(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        _holdTimer?.Dispose();
        _holdTimer = null;
        
        if (_isHolding)
        {
            // Mouse left while holding - revert to hidden
            _showPassword = false;
            _isHolding = false;
            StateHasChanged();
        }
    }
    
    // Touch events for mobile
    private void HandleTouchStart(Microsoft.AspNetCore.Components.Web.TouchEventArgs e)
    {
        _pressStartTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
        
        // Start a timer to detect if this is a press-and-hold
        _holdTimer?.Dispose();
        _holdTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                _isHolding = true;
                _showPassword = true;
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }
    
    private void HandleTouchEnd(Microsoft.AspNetCore.Components.Web.TouchEventArgs e)
    {
        var pressDuration = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - _pressStartTime;
        
        _holdTimer?.Dispose();
        _holdTimer = null;
        
        if (_isHolding)
        {
            // Was a hold - revert to hidden
            _showPassword = false;
            _isHolding = false;
        }
        else if (pressDuration < 300)
        {
            // Quick tap - toggle permanently
            _showPassword = !_showPassword;
        }
        
        StateHasChanged();
    }
    
    private void HandleTouchCancel(Microsoft.AspNetCore.Components.Web.TouchEventArgs e)
    {
        _holdTimer?.Dispose();
        _holdTimer = null;
        
        if (_isHolding)
        {
            // Touch cancelled - revert to hidden
            _showPassword = false;
            _isHolding = false;
            StateHasChanged();
        }
    }

    private async Task OnInput(ChangeEventArgs e)
    {
        Value = e.Value?.ToString() ?? "";
        await ValueChanged.InvokeAsync(Value);
    }

    private async Task OnChange(ChangeEventArgs e)
    {
        Value = e.Value?.ToString() ?? "";
        await ValueChanged.InvokeAsync(Value);
    }
    
    public void Dispose()
    {
        _holdTimer?.Dispose();
    }
}
