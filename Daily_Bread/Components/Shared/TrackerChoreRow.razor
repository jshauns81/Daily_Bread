@namespace Daily_Bread.Components.Shared
@using Daily_Bread.Data.Models
@using Daily_Bread.Helpers
@using Daily_Bread.Services

<tr class="chore-row @GetRowClass()">
    @* Status Indicator - Visual state communication *@
    <td class="status-cell">
        <button class="status-indicator @GetIndicatorClass()"
                disabled="@IsDisabled"
                @onclick="OnToggleClicked"
                title="@GetTooltip()">
            <span class="bi @ChoreDisplayHelper.GetStatusIcon(Item.Status)"></span>
        </button>
    </td>
    
    @* Chore Details - Name, description, context *@
    <td class="chore-cell">
        <div class="chore-content">
            <span class="chore-name">
                @Item.ChoreName
            </span>
            @if (!string.IsNullOrEmpty(Item.Description))
            {
                <span class="chore-description">@Item.Description</span>
            }
            @* Help reason displayed inline for context *@
            @if (Item.IsHelp && !string.IsNullOrEmpty(Item.HelpReason))
            {
                <span class="help-reason">"@Item.HelpReason"</span>
            }
        </div>
    </td>
    
    @* Assignee (Parent view only) *@
    @if (ShowAssignee)
    {
        <td class="assignee-cell">
            <span class="assignee user-name">@(Item.AssignedUserName ?? "—")</span>
        </td>
    }

    @* Status Badge - Clear visual indicator *@
    <td class="status-badge-cell">
        <span class="status-badge @ChoreDisplayHelper.GetStatusBadgeClass(Item.Status)">
            @ChoreDisplayHelper.GetStatusBadgeText(Item.Status)
        </span>
    </td>
    
    @* Value - Subtle unless it matters *@
    <td class="value-cell">
        @if (Item.Value > 0)
        {
            <span class="value @GetValueClass()">
                @(Item.IsApproved ? "+" : "")$@Item.Value.ToString("F2")
            </span>
        }
        else
        {
            <span class="value muted">—</span>
        }
    </td>
    
    @* Actions - Primary buttons for main actions, text links for undo/restore *@
    @if (ShowActions)
    {
        <td class="action-cell">
            @switch (Item.Status)
            {
                case ChoreStatus.Completed:
                    @* Awaiting blessing - primary action is to approve *@
                    <div class="action-group">
                        <button class="action-btn action-approve" @onclick="OnApproveClicked" title="Approve this labor">
                            <span class="bi bi-check2-circle"></span> Approve
                        </button>
                        <button class="action-btn action-reject" @onclick="OnMissClicked" title="Reject - mark as not done">
                            <span class="bi bi-x-lg"></span>
                        </button>
                    </div>
                    break;
                    
                case ChoreStatus.Help:
                    @* Help request - primary action to respond *@
                    <button class="action-btn action-respond" @onclick="OnRespondToHelpClicked" title="Respond to help request">
                        <span class="bi bi-chat-heart"></span> Respond
                    </button>
                    break;
                    
                case ChoreStatus.Pending:
                    @* Pending - subtle actions *@
                    <div class="action-group action-group-subtle">
                        <button class="action-link" @onclick="OnSkipClicked" title="Excuse for today">
                            Excuse
                        </button>
                    </div>
                    break;
                    
                case ChoreStatus.Approved:
                    @* Approved - only undo as text link *@
                    <button class="action-link" @onclick="OnResetClicked" title="Undo approval">
                        Undo
                    </button>
                    break;
                    
                case ChoreStatus.Missed:
                case ChoreStatus.Skipped:
                    @* Past states - restore as text link *@
                    <button class="action-link" @onclick="OnResetClicked" title="Restore to pending">
                        Restore
                    </button>
                    break;
            }
        </td>
    }
</tr>

@code {
    [Parameter, EditorRequired]
    public required TrackerChoreItem Item { get; set; }

    [Parameter]
    public bool IsDisabled { get; set; }

    [Parameter]
    public bool ShowAssignee { get; set; }

    [Parameter]
    public bool ShowActions { get; set; }

    [Parameter]
    public EventCallback<TrackerChoreItem> OnToggle { get; set; }

    [Parameter]
    public EventCallback<TrackerChoreItem> OnApprove { get; set; }

    [Parameter]
    public EventCallback<TrackerChoreItem> OnMiss { get; set; }

    [Parameter]
    public EventCallback<TrackerChoreItem> OnSkip { get; set; }

    [Parameter]
    public EventCallback<TrackerChoreItem> OnReset { get; set; }
    
    [Parameter]
    public EventCallback<TrackerChoreItem> OnRespondToHelp { get; set; }

    private string GetRowClass() => Item.Status switch
    {
        ChoreStatus.Help => "row-help",
        ChoreStatus.Completed => "row-awaiting",
        ChoreStatus.Approved => "row-approved",
        ChoreStatus.Missed => "row-missed",
        ChoreStatus.Skipped => "row-excused",
        _ => "row-pending"
    };

    private string GetIndicatorClass() => Item.Status switch
    {
        ChoreStatus.Approved => "indicator-done",
        ChoreStatus.Completed => "indicator-awaiting",
        ChoreStatus.Help => "indicator-help",
        ChoreStatus.Missed => "indicator-missed",
        ChoreStatus.Skipped => "indicator-skipped",
        _ => "indicator-pending"
    };

    private string GetValueClass() => Item.Status switch
    {
        ChoreStatus.Approved => "earned",
        ChoreStatus.Missed => "penalty",
        _ => ""
    };

    private string GetTooltip() => Item.Status switch
    {
        ChoreStatus.Approved => "Approved ✓✓",
        ChoreStatus.Completed => "Awaiting review",
        ChoreStatus.Help => "Help requested",
        ChoreStatus.Missed => "Not completed",
        ChoreStatus.Skipped => "Excused",
        _ => "Mark as done"
    };

    private async Task OnToggleClicked() => await OnToggle.InvokeAsync(Item);
    private async Task OnApproveClicked() => await OnApprove.InvokeAsync(Item);
    private async Task OnMissClicked() => await OnMiss.InvokeAsync(Item);
    private async Task OnSkipClicked() => await OnSkip.InvokeAsync(Item);
    private async Task OnResetClicked() => await OnReset.InvokeAsync(Item);
    private async Task OnRespondToHelpClicked() => await OnRespondToHelp.InvokeAsync(Item);
}
