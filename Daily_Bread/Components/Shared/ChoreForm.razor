@using Daily_Bread.Data.Models
@using Daily_Bread.Services
@using System.ComponentModel.DataAnnotations

<div class="chore-form">
    <EditForm Model="FormModel" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        <!-- GROUP 1: Identity -->
        <div class="form-section identity-section">
            <div class="icon-picker">
                <EmojiPicker @bind-Value="FormModel.Icon" />
            </div>
            <div class="name-field">
                <InputText @bind-Value="FormModel.Name" class="ds-input ds-input--name" placeholder="What's the chore?" />
                <ValidationMessage For="() => FormModel.Name" class="validation-msg" />
            </div>
        </div>

        <!-- GROUP 2: Type Selector - Luminous segmented control -->
        <div class="form-section type-section">
            <div class="seg2 seg2--money">
                <button type="button" 
                        class="seg2__btn seg2__btn--earns @(FormModel.ChoreType == ChoreTypeOption.Earning ? "seg2__btn--active" : "")"
                        @onclick="() => SetChoreType(ChoreTypeOption.Earning)">
                    <span class="seg2__label">Earns</span>
                    @if (FormModel.ChoreType == ChoreTypeOption.Earning)
                    {
                        <span class="seg2__amount">
                            <span class="seg2__currency">$</span>
                            <InputNumber @bind-Value="FormModel.EarnValue" class="seg2__input" step="0.25" min="0" @onclick:stopPropagation="true" />
                        </span>
                    }
                    <span class="seg2__bar"></span>
                </button>
                
                <button type="button" 
                        class="seg2__btn seg2__btn--expected @(FormModel.ChoreType == ChoreTypeOption.Expectation ? "seg2__btn--active" : "")"
                        @onclick="() => SetChoreType(ChoreTypeOption.Expectation)">
                    <span class="seg2__label">Expected</span>
                    <span class="seg2__bar"></span>
                </button>
            </div>
        </div>

        <!-- Assigned To (only if multiple users) -->
        @if (Users.Count > 1)
        {
            <div class="form-section assign-section">
                <label class="field-row">
                    <span class="field-label">For</span>
                    <InputSelect @bind-Value="FormModel.AssignedUserId" class="ds-select">
                        <option value="">Anyone</option>
                        @foreach (var user in Users)
                        {
                            <option value="@user.Id">@user.UserName</option>
                        }
                    </InputSelect>
                </label>
            </div>
        }

        <!-- GROUP 3: Schedule -->
        <div class="form-section schedule-section">
            <span class="section-label">Schedule rule</span>
            <div class="seg2 seg2--schedule">
                <button type="button"
                        class="seg2__btn seg2__btn--fixed @(FormModel.ScheduleType == ChoreScheduleType.SpecificDays ? "seg2__btn--active" : "")"
                        @onclick="() => SetScheduleType(ChoreScheduleType.SpecificDays)">
                    <span class="seg2__label">Fixed days</span>
                    <span class="seg2__bar"></span>
                </button>
                <button type="button"
                        class="seg2__btn seg2__btn--weekly @(FormModel.ScheduleType == ChoreScheduleType.WeeklyFrequency ? "seg2__btn--active" : "")"
                        @onclick="() => SetScheduleType(ChoreScheduleType.WeeklyFrequency)">
                    <span class="seg2__label">Weekly goal</span>
                    <span class="seg2__bar"></span>
                </button>
            </div>

            <!-- EITHER days OR frequency, not both -->
            @if (FormModel.ScheduleType == ChoreScheduleType.SpecificDays)
            {
                <!-- Fixed Days: show day picker -->
                <div class="days-row">
                    @foreach (var day in DayOptions)
                    {
                        <button type="button" 
                                class="day-chip @(IsDaySelected(day.Value) ? "day-chip--selected" : "")"
                                @onclick="() => ToggleDay(day.Value)">
                            @day.Label
                        </button>
                    }
                </div>
            }
            else
            {
                <!-- Weekly Goal: show frequency with inline bonus toggle -->
                <div class="frequency-row">
                    <span class="frequency-row__text">up to</span>
                    <InputNumber @bind-Value="FormModel.WeeklyTargetCount" class="frequency-row__input" min="1" max="7" />
                    <span class="frequency-row__text">× weekly</span>
                    
                    @if (FormModel.ChoreType == ChoreTypeOption.Earning)
                    {
                        <label class="bonus-toggle">
                            <InputCheckbox @bind-Value="FormModel.IsRepeatable" />
                            <span>Bonus</span>
                        </label>
                    }
                </div>
            }
        </div>

        <!-- Options (collapsed) - reduced visual weight -->
        <details class="options-section">
            <summary class="options-summary">
                <span class="options-icon">⚙</span>
                <span>Options</span>
            </summary>
            <div class="options-content">
                @if (FormModel.ChoreType == ChoreTypeOption.Earning)
                {
                    <label class="option-check">
                        <InputCheckbox @bind-Value="FormModel.AutoApprove" />
                        <span>Auto-approve completions</span>
                    </label>
                }
                <label class="option-check">
                    <InputCheckbox @bind-Value="FormModel.IsActive" />
                    <span>Active</span>
                </label>
                <div class="date-row">
                    <label class="date-field">
                        <span>Start</span>
                        <InputDate @bind-Value="FormModel.StartDate" class="ds-input ds-input--date" />
                    </label>
                    <label class="date-field">
                        <span>End</span>
                        <InputDate @bind-Value="FormModel.EndDate" class="ds-input ds-input--date" />
                    </label>
                </div>
                <InputTextArea @bind-Value="FormModel.Description" class="ds-input ds-input--textarea" rows="2" placeholder="Notes (optional)" />
            </div>
        </details>

        <!-- Actions -->
        <div class="form-actions">
            <button type="button" class="btn-cancel" @onclick="HandleCancel">Cancel</button>
            <button type="submit" class="btn-submit" disabled="@IsSubmitting">
                @if (IsSubmitting) { <span class="spinner"></span> }
                @(IsEditing ? "Save" : "Create")
            </button>
        </div>
    </EditForm>
</div>

@code {
    private enum ChoreTypeOption { Earning, Expectation }

    [Parameter] public ChoreDefinitionDto? Chore { get; set; }
    [Parameter] public List<UserSelectItem> Users { get; set; } = [];
    [Parameter] public EventCallback<ChoreDefinitionDto> OnSubmit { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private ChoreFormModel FormModel { get; set; } = new();
    private bool IsEditing => Chore?.Id > 0;
    private bool IsSubmitting { get; set; }

    private static readonly List<(DaysOfWeek Value, string Label)> DayOptions =
    [
        (DaysOfWeek.Sunday, "S"),
        (DaysOfWeek.Monday, "M"),
        (DaysOfWeek.Tuesday, "T"),
        (DaysOfWeek.Wednesday, "W"),
        (DaysOfWeek.Thursday, "T"),
        (DaysOfWeek.Friday, "F"),
        (DaysOfWeek.Saturday, "S")
    ];

    protected override void OnParametersSet()
    {
        if (Chore != null)
        {
            FormModel = new ChoreFormModel
            {
                Id = Chore.Id,
                Name = Chore.Name,
                Description = Chore.Description,
                Icon = Chore.Icon,
                AssignedUserId = Chore.AssignedUserId,
                EarnValue = Chore.EarnValue,
                PenaltyValue = Chore.PenaltyValue,
                ScheduleType = Chore.ScheduleType,
                ActiveDays = Chore.ActiveDays,
                WeeklyTargetCount = Chore.WeeklyTargetCount,
                IsRepeatable = Chore.IsRepeatable,
                StartDate = Chore.StartDate,
                EndDate = Chore.EndDate,
                IsActive = Chore.IsActive,
                AutoApprove = Chore.AutoApprove,
                SortOrder = Chore.SortOrder,
                ChoreType = Chore.EarnValue > 0 ? ChoreTypeOption.Earning : ChoreTypeOption.Expectation
            };
        }
        else
        {
            FormModel = new ChoreFormModel
            {
                ChoreType = ChoreTypeOption.Earning,
                ScheduleType = ChoreScheduleType.SpecificDays,
                ActiveDays = DaysOfWeek.All,
                WeeklyTargetCount = 1,
                IsRepeatable = false,
                IsActive = true,
                AutoApprove = true,
                EarnValue = 1.00m,
                PenaltyValue = 0
            };
        }
        
        if (Users.Count == 1 && string.IsNullOrEmpty(FormModel.AssignedUserId))
            FormModel.AssignedUserId = Users[0].Id;
    }

    private void SetChoreType(ChoreTypeOption type)
    {
        FormModel.ChoreType = type;
        if (type == ChoreTypeOption.Earning)
        {
            if (FormModel.EarnValue <= 0) FormModel.EarnValue = 1.00m;
        }
        else
        {
            FormModel.EarnValue = 0;
            FormModel.AutoApprove = true;
            FormModel.IsRepeatable = false;
        }
    }

    private void SetScheduleType(ChoreScheduleType type)
    {
        FormModel.ScheduleType = type;
        if (type == ChoreScheduleType.WeeklyFrequency && FormModel.ActiveDays == DaysOfWeek.None)
            FormModel.ActiveDays = DaysOfWeek.All;
        if (type == ChoreScheduleType.SpecificDays)
            FormModel.IsRepeatable = false;
    }

    private bool IsDaySelected(DaysOfWeek day) => FormModel.ActiveDays.HasFlag(day);

    private void ToggleDay(DaysOfWeek day)
    {
        FormModel.ActiveDays = FormModel.ActiveDays.HasFlag(day) 
            ? FormModel.ActiveDays & ~day 
            : FormModel.ActiveDays | day;
    }

    private async Task HandleSubmit()
    {
        IsSubmitting = true;
        try
        {
            var dto = new ChoreDefinitionDto
            {
                Id = FormModel.Id,
                Name = FormModel.Name,
                Description = FormModel.Description,
                Icon = FormModel.Icon,
                AssignedUserId = string.IsNullOrEmpty(FormModel.AssignedUserId) ? null : FormModel.AssignedUserId,
                EarnValue = FormModel.ChoreType == ChoreTypeOption.Earning ? FormModel.EarnValue : 0,
                PenaltyValue = FormModel.PenaltyValue,
                ScheduleType = FormModel.ScheduleType,
                ActiveDays = FormModel.ActiveDays,
                WeeklyTargetCount = FormModel.WeeklyTargetCount,
                IsRepeatable = FormModel.ScheduleType == ChoreScheduleType.WeeklyFrequency && FormModel.ChoreType == ChoreTypeOption.Earning 
                    ? FormModel.IsRepeatable : false,
                StartDate = FormModel.StartDate,
                EndDate = FormModel.EndDate,
                IsActive = FormModel.IsActive,
                AutoApprove = FormModel.ChoreType == ChoreTypeOption.Expectation ? true : FormModel.AutoApprove,
                SortOrder = FormModel.SortOrder
            };
            await OnSubmit.InvokeAsync(dto);
        }
        finally { IsSubmitting = false; }
    }

    private async Task HandleCancel() => await OnCancel.InvokeAsync();

    private class ChoreFormModel
    {
        public int Id { get; set; }
        public ChoreTypeOption ChoreType { get; set; } = ChoreTypeOption.Earning;
        [Required(ErrorMessage = "Required")]
        [StringLength(100)]
        public string Name { get; set; } = string.Empty;
        [StringLength(500)]
        public string? Description { get; set; }
        public string? Icon { get; set; }
        public string? AssignedUserId { get; set; }
        [Range(0, 10000)]
        public decimal EarnValue { get; set; }
        [Range(0, 10000)]
        public decimal PenaltyValue { get; set; }
        public ChoreScheduleType ScheduleType { get; set; } = ChoreScheduleType.SpecificDays;
        public DaysOfWeek ActiveDays { get; set; } = DaysOfWeek.All;
        [Range(1, 7)]
        public int WeeklyTargetCount { get; set; } = 1;
        public bool IsRepeatable { get; set; }
        public DateOnly? StartDate { get; set; }
        public DateOnly? EndDate { get; set; }
        public bool IsActive { get; set; } = true;
        public bool AutoApprove { get; set; } = true;
        public int SortOrder { get; set; }
    }
}
