@using Daily_Bread.Data.Models
@using Daily_Bread.Services
@using System.ComponentModel.DataAnnotations

<div class="chore-form">
    <EditForm Model="FormModel" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <label for="name" class="form-label">Chore Name <span class="text-danger">*</span></label>
                    <InputText id="name" @bind-Value="FormModel.Name" class="form-control" placeholder="e.g., Make Bed" />
                    <ValidationMessage For="() => FormModel.Name" class="text-danger" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="value" class="form-label">Value ($) <span class="text-danger">*</span></label>
                    <InputNumber id="value" @bind-Value="FormModel.Value" class="form-control" step="0.25" min="0" />
                    <ValidationMessage For="() => FormModel.Value" class="text-danger" />
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <InputTextArea id="description" @bind-Value="FormModel.Description" class="form-control" rows="2" placeholder="Optional details about the chore..." />
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="assignedUser" class="form-label">Assigned To</label>
                    <InputSelect id="assignedUser" @bind-Value="FormModel.AssignedUserId" class="form-select">
                        <option value="">-- Unassigned --</option>
                        @foreach (var user in Users)
                        {
                            <option value="@user.Id">@user.UserName (@user.Role)</option>
                        }
                    </InputSelect>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="sortOrder" class="form-label">Sort Order</label>
                    <InputNumber id="sortOrder" @bind-Value="FormModel.SortOrder" class="form-control" />
                    <small class="text-muted">Lower numbers appear first</small>
                </div>
            </div>
        </div>

        <!-- Schedule Type Selection -->
        <div class="card mb-3 @(FormModel.ScheduleType == ChoreScheduleType.WeeklyFrequency ? "border-info" : "")">
            <div class="card-header">
                <strong>Scheduling</strong>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="scheduleSpecificDays" name="scheduleType"
                               checked="@(FormModel.ScheduleType == ChoreScheduleType.SpecificDays)"
                               @onchange="() => SetScheduleType(ChoreScheduleType.SpecificDays)" />
                        <label class="form-check-label" for="scheduleSpecificDays">
                            <strong>Specific Days</strong>
                            <small class="d-block text-muted">Chore appears on selected days each week</small>
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="scheduleWeeklyFrequency" name="scheduleType"
                               checked="@(FormModel.ScheduleType == ChoreScheduleType.WeeklyFrequency)"
                               @onchange="() => SetScheduleType(ChoreScheduleType.WeeklyFrequency)" />
                        <label class="form-check-label" for="scheduleWeeklyFrequency">
                            <strong>Weekly Frequency</strong>
                            <small class="d-block text-muted">Complete X times per week, any days (e.g., "Walk the Dog 3x per week")</small>
                        </label>
                    </div>
                </div>

                @if (FormModel.ScheduleType == ChoreScheduleType.WeeklyFrequency)
                {
                    <div class="alert alert-info mb-3">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <label for="weeklyTarget" class="form-label mb-0"><strong>Times per week:</strong></label>
                            </div>
                            <div class="col-auto">
                                <InputNumber id="weeklyTarget" @bind-Value="FormModel.WeeklyTargetCount" class="form-control" style="width: 80px;" min="1" max="7" />
                            </div>
                            <div class="col">
                                <small class="text-muted">Chore must be completed @FormModel.WeeklyTargetCount time(s) each week</small>
                            </div>
                        </div>
                    </div>
                }

                <div class="mb-3">
                    <label class="form-label">
                        @if (FormModel.ScheduleType == ChoreScheduleType.SpecificDays)
                        {
                            <span>Active Days <small class="text-muted">(chore appears on these days)</small></span>
                        }
                        else
                        {
                            <span>Available Days <small class="text-muted">(chore can be done on these days)</small></span>
                        }
                    </label>
                    <div class="btn-group d-flex flex-wrap" role="group">
                        @foreach (var day in DayOptions)
                        {
                            <input type="checkbox" 
                                   class="btn-check" 
                                   id="day-@day.Value" 
                                   checked="@IsDaySelected(day.Value)"
                                   @onchange="() => ToggleDay(day.Value)" />
                            <label class="btn btn-outline-primary" for="day-@day.Value">@day.Label</label>
                        }
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" @onclick="SelectAllDays">All</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" @onclick="SelectWeekdays">Weekdays</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" @onclick="SelectWeekends">Weekends</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ClearDays">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="startDate" class="form-label">Start Date (optional)</label>
                    <InputDate id="startDate" @bind-Value="FormModel.StartDate" class="form-control" />
                    <small class="text-muted">Leave empty for no start restriction</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="endDate" class="form-label">End Date (optional)</label>
                    <InputDate id="endDate" @bind-Value="FormModel.EndDate" class="form-control" />
                    <small class="text-muted">Leave empty for no end restriction</small>
                </div>
            </div>
        </div>

        <!-- Approval Settings Card -->
        <div class="card mb-3 @(FormModel.AutoApprove ? "border-success" : "")">
            <div class="card-body">
                <div class="form-check form-switch">
                    <InputCheckbox id="autoApprove" @bind-Value="FormModel.AutoApprove" class="form-check-input" />
                    <label class="form-check-label fw-bold" for="autoApprove">
                        <span class="@(FormModel.AutoApprove ? "text-success" : "")">
                            @(FormModel.AutoApprove ? "Auto-Approve Enabled" : "Requires Parent Approval")
                        </span>
                    </label>
                </div>
                <div class="mt-2">
                    @if (FormModel.AutoApprove)
                    {
                        <small class="text-success">
                            <strong>Auto-approve:</strong> When the child marks this chore as done, it will be 
                            automatically approved and credited to their balance. Best for simple, trust-based tasks 
                            like <em>Make Bed</em> or <em>Brush Teeth</em>.
                        </small>
                    }
                    else
                    {
                        <small class="text-muted">
                            <strong>Manual approval:</strong> A parent must review and approve this chore before 
                            it's credited. Best for tasks that need inspection like <em>Mow the Yard</em> or 
                            <em>Clean Room</em>.
                        </small>
                    }
                </div>
            </div>
        </div>

        <div class="mb-3">
            <div class="form-check">
                <InputCheckbox id="isActive" @bind-Value="FormModel.IsActive" class="form-check-input" />
                <label class="form-check-label" for="isActive">
                    Active (appears in daily tracker)
                </label>
            </div>
        </div>

        <hr />

        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" @onclick="HandleCancel">
                Cancel
            </button>
            <button type="submit" class="btn btn-primary" disabled="@IsSubmitting">
                @if (IsSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                }
                @(IsEditing ? "Save Changes" : "Create Chore")
            </button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter]
    public ChoreDefinitionDto? Chore { get; set; }

    [Parameter]
    public List<UserSelectItem> Users { get; set; } = [];

    [Parameter]
    public EventCallback<ChoreDefinitionDto> OnSubmit { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private ChoreFormModel FormModel { get; set; } = new();
    private bool IsEditing => Chore?.Id > 0;
    private bool IsSubmitting { get; set; }

    private static readonly List<(DaysOfWeek Value, string Label)> DayOptions =
    [
        (DaysOfWeek.Sunday, "Sun"),
        (DaysOfWeek.Monday, "Mon"),
        (DaysOfWeek.Tuesday, "Tue"),
        (DaysOfWeek.Wednesday, "Wed"),
        (DaysOfWeek.Thursday, "Thu"),
        (DaysOfWeek.Friday, "Fri"),
        (DaysOfWeek.Saturday, "Sat")
    ];

    protected override void OnParametersSet()
    {
        if (Chore != null)
        {
            FormModel = new ChoreFormModel
            {
                Id = Chore.Id,
                Name = Chore.Name,
                Description = Chore.Description,
                AssignedUserId = Chore.AssignedUserId,
                Value = Chore.Value,
                ScheduleType = Chore.ScheduleType,
                ActiveDays = Chore.ActiveDays,
                WeeklyTargetCount = Chore.WeeklyTargetCount,
                StartDate = Chore.StartDate,
                EndDate = Chore.EndDate,
                IsActive = Chore.IsActive,
                AutoApprove = Chore.AutoApprove,
                SortOrder = Chore.SortOrder
            };
        }
        else
        {
            FormModel = new ChoreFormModel
            {
                ScheduleType = ChoreScheduleType.SpecificDays,
                ActiveDays = DaysOfWeek.All,
                WeeklyTargetCount = 1,
                IsActive = true,
                AutoApprove = false,
                Value = 1.00m
            };
        }
    }

    private void SetScheduleType(ChoreScheduleType scheduleType)
    {
        FormModel.ScheduleType = scheduleType;
        
        // When switching to WeeklyFrequency, default to All days if none selected
        if (scheduleType == ChoreScheduleType.WeeklyFrequency && FormModel.ActiveDays == DaysOfWeek.None)
        {
            FormModel.ActiveDays = DaysOfWeek.All;
        }
    }

    private bool IsDaySelected(DaysOfWeek day) => FormModel.ActiveDays.HasFlag(day);

    private void ToggleDay(DaysOfWeek day)
    {
        if (FormModel.ActiveDays.HasFlag(day))
        {
            FormModel.ActiveDays &= ~day;
        }
        else
        {
            FormModel.ActiveDays |= day;
        }
    }

    private void SelectAllDays() => FormModel.ActiveDays = DaysOfWeek.All;
    private void SelectWeekdays() => FormModel.ActiveDays = DaysOfWeek.Weekdays;
    private void SelectWeekends() => FormModel.ActiveDays = DaysOfWeek.Weekends;
    private void ClearDays() => FormModel.ActiveDays = DaysOfWeek.None;

    private async Task HandleSubmit()
    {
        IsSubmitting = true;
        try
        {
            var dto = new ChoreDefinitionDto
            {
                Id = FormModel.Id,
                Name = FormModel.Name,
                Description = FormModel.Description,
                AssignedUserId = string.IsNullOrEmpty(FormModel.AssignedUserId) ? null : FormModel.AssignedUserId,
                Value = FormModel.Value,
                ScheduleType = FormModel.ScheduleType,
                ActiveDays = FormModel.ActiveDays,
                WeeklyTargetCount = FormModel.WeeklyTargetCount,
                StartDate = FormModel.StartDate,
                EndDate = FormModel.EndDate,
                IsActive = FormModel.IsActive,
                AutoApprove = FormModel.AutoApprove,
                SortOrder = FormModel.SortOrder
            };

            await OnSubmit.InvokeAsync(dto);
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }

    private class ChoreFormModel
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "Chore name is required")]
        [StringLength(100, ErrorMessage = "Name cannot exceed 100 characters")]
        public string Name { get; set; } = string.Empty;

        [StringLength(500, ErrorMessage = "Description cannot exceed 500 characters")]
        public string? Description { get; set; }

        public string? AssignedUserId { get; set; }

        [Range(0, 1000, ErrorMessage = "Value must be between $0 and $1000")]
        public decimal Value { get; set; }

        public ChoreScheduleType ScheduleType { get; set; } = ChoreScheduleType.SpecificDays;

        public DaysOfWeek ActiveDays { get; set; } = DaysOfWeek.All;

        [Range(1, 7, ErrorMessage = "Weekly target must be between 1 and 7")]
        public int WeeklyTargetCount { get; set; } = 1;

        public DateOnly? StartDate { get; set; }

        public DateOnly? EndDate { get; set; }

        public bool IsActive { get; set; } = true;

        public bool AutoApprove { get; set; } = false;

        public int SortOrder { get; set; }
    }
}
