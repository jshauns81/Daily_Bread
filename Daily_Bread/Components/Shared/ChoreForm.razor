@using Daily_Bread.Data.Models
@using Daily_Bread.Services
@using System.ComponentModel.DataAnnotations

<div class="chore-form">
    <EditForm Model="FormModel" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        <!-- GROUP 1: Identity -->
        <div class="form-group identity-group">
            <div class="icon-picker">
                <EmojiPicker @bind-Value="FormModel.Icon" />
            </div>
            <div class="name-input">
                <InputText @bind-Value="FormModel.Name" class="form-control" placeholder="What's the chore?" />
                <ValidationMessage For="() => FormModel.Name" class="validation-msg" />
            </div>
        </div>

        <!-- GROUP 2: Type & Value -->
        <div class="form-group type-group">
            <div class="type-switch">
                <button type="button" 
                        class="type-option @(FormModel.ChoreType == ChoreTypeOption.Earning ? "selected earns" : "")"
                        @onclick="() => SetChoreType(ChoreTypeOption.Earning)">
                    <span class="type-label">Earns</span>
                    @if (FormModel.ChoreType == ChoreTypeOption.Earning)
                    {
                        <span class="amount-inline">
                            <span class="currency">$</span>
                            <InputNumber @bind-Value="FormModel.EarnValue" class="amount-input" step="0.25" min="0" @onclick:stopPropagation="true" />
                        </span>
                    }
                </button>
                <button type="button" 
                        class="type-option @(FormModel.ChoreType == ChoreTypeOption.Expectation ? "selected expected" : "")"
                        @onclick="() => SetChoreType(ChoreTypeOption.Expectation)">
                    <span class="type-label">Expected</span>
                </button>
            </div>
        </div>

        <!-- Assigned To (only if multiple users) -->
        @if (Users.Count > 1)
        {
            <div class="form-group assign-group">
                <span class="field-label">For</span>
                <InputSelect @bind-Value="FormModel.AssignedUserId" class="form-select">
                    <option value="">Anyone</option>
                    @foreach (var user in Users)
                    {
                        <option value="@user.Id">@user.UserName</option>
                    }
                </InputSelect>
            </div>
        }

        <!-- GROUP 3: Schedule -->
        <div class="form-group schedule-group">
            <!-- Days row -->
            <div class="days-row">
                @foreach (var day in DayOptions)
                {
                    <button type="button" 
                            class="day-chip @(IsDaySelected(day.Value) ? "selected" : "")"
                            @onclick="() => ToggleDay(day.Value)">
                        @day.Label
                    </button>
                }
            </div>
            
            <!-- Frequency indicator -->
            <div class="frequency-row">
                <button type="button" 
                        class="freq-option @(FormModel.ScheduleType == ChoreScheduleType.SpecificDays ? "active" : "")"
                        @onclick="() => SetScheduleType(ChoreScheduleType.SpecificDays)">
                    these days
                </button>
                <span class="freq-divider">or</span>
                <button type="button" 
                        class="freq-option has-input @(FormModel.ScheduleType == ChoreScheduleType.WeeklyFrequency ? "active" : "")"
                        @onclick="() => SetScheduleType(ChoreScheduleType.WeeklyFrequency)">
                    <InputNumber @bind-Value="FormModel.WeeklyTargetCount" class="freq-input" min="1" max="7" @onclick:stopPropagation="true" />
                    <span>× weekly</span>
                </button>
            </div>

            @if (FormModel.ScheduleType == ChoreScheduleType.WeeklyFrequency && FormModel.ChoreType == ChoreTypeOption.Earning)
            {
                <label class="bonus-check">
                    <InputCheckbox @bind-Value="FormModel.IsRepeatable" />
                    <span>Extra completions earn bonus</span>
                </label>
            }
        </div>

        <!-- Options (collapsed) -->
        <details class="options-group">
            <summary>
                <span class="summary-icon">⚙</span>
                <span>Options</span>
            </summary>
            <div class="options-content">
                @if (FormModel.ChoreType == ChoreTypeOption.Earning)
                {
                    <label class="option-check">
                        <InputCheckbox @bind-Value="FormModel.AutoApprove" />
                        <span>Auto-approve completions</span>
                    </label>
                }
                <label class="option-check">
                    <InputCheckbox @bind-Value="FormModel.IsActive" />
                    <span>Active</span>
                </label>
                <div class="date-row">
                    <label class="date-field">
                        <span>Start</span>
                        <InputDate @bind-Value="FormModel.StartDate" class="form-control" />
                    </label>
                    <label class="date-field">
                        <span>End</span>
                        <InputDate @bind-Value="FormModel.EndDate" class="form-control" />
                    </label>
                </div>
                <InputTextArea @bind-Value="FormModel.Description" class="form-control notes-input" rows="2" placeholder="Notes (optional)" />
            </div>
        </details>

        <!-- Actions -->
        <div class="form-actions">
            <button type="button" class="btn-cancel" @onclick="HandleCancel">Cancel</button>
            <button type="submit" class="btn-submit" disabled="@IsSubmitting">
                @if (IsSubmitting) { <span class="spinner"></span> }
                @(IsEditing ? "Save" : "Create")
            </button>
        </div>
    </EditForm>
</div>

@code {
    private enum ChoreTypeOption { Earning, Expectation }

    [Parameter] public ChoreDefinitionDto? Chore { get; set; }
    [Parameter] public List<UserSelectItem> Users { get; set; } = [];
    [Parameter] public EventCallback<ChoreDefinitionDto> OnSubmit { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private ChoreFormModel FormModel { get; set; } = new();
    private bool IsEditing => Chore?.Id > 0;
    private bool IsSubmitting { get; set; }

    private static readonly List<(DaysOfWeek Value, string Label)> DayOptions =
    [
        (DaysOfWeek.Sunday, "S"),
        (DaysOfWeek.Monday, "M"),
        (DaysOfWeek.Tuesday, "T"),
        (DaysOfWeek.Wednesday, "W"),
        (DaysOfWeek.Thursday, "T"),
        (DaysOfWeek.Friday, "F"),
        (DaysOfWeek.Saturday, "S")
    ];

    protected override void OnParametersSet()
    {
        if (Chore != null)
        {
            FormModel = new ChoreFormModel
            {
                Id = Chore.Id,
                Name = Chore.Name,
                Description = Chore.Description,
                Icon = Chore.Icon,
                AssignedUserId = Chore.AssignedUserId,
                EarnValue = Chore.EarnValue,
                PenaltyValue = Chore.PenaltyValue,
                ScheduleType = Chore.ScheduleType,
                ActiveDays = Chore.ActiveDays,
                WeeklyTargetCount = Chore.WeeklyTargetCount,
                IsRepeatable = Chore.IsRepeatable,
                StartDate = Chore.StartDate,
                EndDate = Chore.EndDate,
                IsActive = Chore.IsActive,
                AutoApprove = Chore.AutoApprove,
                SortOrder = Chore.SortOrder,
                ChoreType = Chore.EarnValue > 0 ? ChoreTypeOption.Earning : ChoreTypeOption.Expectation
            };
        }
        else
        {
            FormModel = new ChoreFormModel
            {
                ChoreType = ChoreTypeOption.Earning,
                ScheduleType = ChoreScheduleType.SpecificDays,
                ActiveDays = DaysOfWeek.All,
                WeeklyTargetCount = 1,
                IsRepeatable = false,
                IsActive = true,
                AutoApprove = true,
                EarnValue = 1.00m,
                PenaltyValue = 0
            };
        }
        
        if (Users.Count == 1 && string.IsNullOrEmpty(FormModel.AssignedUserId))
            FormModel.AssignedUserId = Users[0].Id;
    }

    private void SetChoreType(ChoreTypeOption type)
    {
        FormModel.ChoreType = type;
        if (type == ChoreTypeOption.Earning)
        {
            if (FormModel.EarnValue <= 0) FormModel.EarnValue = 1.00m;
        }
        else
        {
            FormModel.EarnValue = 0;
            FormModel.AutoApprove = true;
            FormModel.IsRepeatable = false;
        }
    }

    private void SetScheduleType(ChoreScheduleType type)
    {
        FormModel.ScheduleType = type;
        if (type == ChoreScheduleType.WeeklyFrequency && FormModel.ActiveDays == DaysOfWeek.None)
            FormModel.ActiveDays = DaysOfWeek.All;
        if (type == ChoreScheduleType.SpecificDays)
            FormModel.IsRepeatable = false;
    }

    private bool IsDaySelected(DaysOfWeek day) => FormModel.ActiveDays.HasFlag(day);

    private void ToggleDay(DaysOfWeek day)
    {
        FormModel.ActiveDays = FormModel.ActiveDays.HasFlag(day) 
            ? FormModel.ActiveDays & ~day 
            : FormModel.ActiveDays | day;
    }

    private async Task HandleSubmit()
    {
        IsSubmitting = true;
        try
        {
            var dto = new ChoreDefinitionDto
            {
                Id = FormModel.Id,
                Name = FormModel.Name,
                Description = FormModel.Description,
                Icon = FormModel.Icon,
                AssignedUserId = string.IsNullOrEmpty(FormModel.AssignedUserId) ? null : FormModel.AssignedUserId,
                EarnValue = FormModel.ChoreType == ChoreTypeOption.Earning ? FormModel.EarnValue : 0,
                PenaltyValue = FormModel.PenaltyValue,
                ScheduleType = FormModel.ScheduleType,
                ActiveDays = FormModel.ActiveDays,
                WeeklyTargetCount = FormModel.WeeklyTargetCount,
                IsRepeatable = FormModel.ScheduleType == ChoreScheduleType.WeeklyFrequency && FormModel.ChoreType == ChoreTypeOption.Earning 
                    ? FormModel.IsRepeatable : false,
                StartDate = FormModel.StartDate,
                EndDate = FormModel.EndDate,
                IsActive = FormModel.IsActive,
                AutoApprove = FormModel.ChoreType == ChoreTypeOption.Expectation ? true : FormModel.AutoApprove,
                SortOrder = FormModel.SortOrder
            };
            await OnSubmit.InvokeAsync(dto);
        }
        finally { IsSubmitting = false; }
    }

    private async Task HandleCancel() => await OnCancel.InvokeAsync();

    private class ChoreFormModel
    {
        public int Id { get; set; }
        public ChoreTypeOption ChoreType { get; set; } = ChoreTypeOption.Earning;
        [Required(ErrorMessage = "Required")]
        [StringLength(100)]
        public string Name { get; set; } = string.Empty;
        [StringLength(500)]
        public string? Description { get; set; }
        public string? Icon { get; set; }
        public string? AssignedUserId { get; set; }
        [Range(0, 10000)]
        public decimal EarnValue { get; set; }
        [Range(0, 10000)]
        public decimal PenaltyValue { get; set; }
        public ChoreScheduleType ScheduleType { get; set; } = ChoreScheduleType.SpecificDays;
        public DaysOfWeek ActiveDays { get; set; } = DaysOfWeek.All;
        [Range(1, 7)]
        public int WeeklyTargetCount { get; set; } = 1;
        public bool IsRepeatable { get; set; }
        public DateOnly? StartDate { get; set; }
        public DateOnly? EndDate { get; set; }
        public bool IsActive { get; set; } = true;
        public bool AutoApprove { get; set; } = true;
        public int SortOrder { get; set; }
    }
}
