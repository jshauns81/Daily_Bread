@inject IJSRuntime JS

<div class="emoji-picker-wrapper">
    <button type="button" 
            class="btn @(string.IsNullOrEmpty(Value) ? "btn-outline-secondary" : "btn-outline-primary") emoji-trigger"
            @onclick="TogglePicker"
            @onclick:stopPropagation="true">
        @if (!string.IsNullOrEmpty(Value))
        {
            <span class="selected-emoji">@Value</span>
        }
        else
        {
            <span class="bi bi-emoji-smile"></span>
            <span class="ms-1">Pick Icon</span>
        }
    </button>
    
    @if (_showPicker)
    {
        <div class="emoji-picker-dropdown" @onclick:stopPropagation="true">
            <div class="emoji-picker-header">
                <span>Choose an icon</span>
                <button type="button" class="btn-close btn-close-white btn-sm" @onclick="ClosePicker"></button>
            </div>
            
            <!-- Quick picks for common chores -->
            <div class="emoji-quick-picks">
                <span class="quick-picks-label">Quick picks:</span>
                <div class="quick-picks-grid">
                    @foreach (var emoji in QuickPickEmojis)
                    {
                        <button type="button" 
                                class="emoji-btn @(Value == emoji ? "selected" : "")" 
                                @onclick="() => SelectEmoji(emoji)"
                                title="@GetEmojiName(emoji)">
                            @emoji
                        </button>
                    }
                </div>
            </div>
            
            <!-- Category sections -->
            @foreach (var category in EmojiCategories)
            {
                <div class="emoji-category">
                    <span class="category-label">@category.Key</span>
                    <div class="emoji-grid">
                        @foreach (var emoji in category.Value)
                        {
                            <button type="button" 
                                    class="emoji-btn @(Value == emoji ? "selected" : "")" 
                                    @onclick="() => SelectEmoji(emoji)">
                                @emoji
                            </button>
                        }
                    </div>
                </div>
            }
            
            @if (!string.IsNullOrEmpty(Value))
            {
                <div class="emoji-picker-footer">
                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="ClearEmoji">
                        <span class="bi bi-x-lg me-1"></span>Clear
                    </button>
                </div>
            }
        </div>
    }
</div>

@if (_showPicker)
{
    <div class="emoji-picker-backdrop" @onclick="ClosePicker"></div>
}

@code {
    [Parameter]
    public string? Value { get; set; }
    
    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }
    
    private bool _showPicker;
    
    // Quick picks - using EmojiConstants for reliable rendering
    private static readonly string[] QuickPickEmojis =
    [
        EmojiConstants.Bed,
        EmojiConstants.Tooth,
        EmojiConstants.Dog,
        EmojiConstants.Plate,
        EmojiConstants.Broom,
        EmojiConstants.Trash,
        EmojiConstants.Books,
        EmojiConstants.Backpack,
        EmojiConstants.TShirt,
        EmojiConstants.Shower,
        EmojiConstants.Seedling,
        EmojiConstants.CatFace,
        EmojiConstants.Cooking,
        EmojiConstants.Soap,
        EmojiConstants.Memo,
        EmojiConstants.Sparkles
    ];
    
    // Categorized emojis using EmojiConstants
    private static readonly Dictionary<string, string[]> EmojiCategories = new()
    {
        ["Cleaning"] = [
            EmojiConstants.Broom,
            EmojiConstants.Soap,
            EmojiConstants.Shower,
            EmojiConstants.Bathtub,
            EmojiConstants.TShirt,
            EmojiConstants.Gloves,
            EmojiConstants.Sparkles,
            EmojiConstants.Lotion,
            EmojiConstants.Toilet,
            EmojiConstants.Droplet,
            EmojiConstants.Sponge,
            EmojiConstants.Trash
        ],
        ["Home"] = [
            EmojiConstants.Bed,
            EmojiConstants.Couch,
            EmojiConstants.Door,
            EmojiConstants.LightBulb,
            EmojiConstants.Key,
            EmojiConstants.Package,
            EmojiConstants.Seedling,
            EmojiConstants.House,
            EmojiConstants.HouseGarden,
            EmojiConstants.Chair,
            EmojiConstants.Television,
            EmojiConstants.ShoppingCart
        ],
        ["Kitchen"] = [
            EmojiConstants.Plate,
            EmojiConstants.Cooking,
            EmojiConstants.Pan,
            EmojiConstants.ForkKnife,
            EmojiConstants.Spoon,
            EmojiConstants.Knife,
            EmojiConstants.Coffee,
            EmojiConstants.Ice,
            EmojiConstants.Trash,
            EmojiConstants.Recycle,
            EmojiConstants.Bowl,
            EmojiConstants.Pot
        ],
        ["Pets"] = [
            EmojiConstants.Dog,
            EmojiConstants.Cat,
            EmojiConstants.CatFace,
            EmojiConstants.DogFace,
            EmojiConstants.PawPrints,
            EmojiConstants.Bone,
            EmojiConstants.Fish,
            EmojiConstants.TropicalFish,
            EmojiConstants.Turtle,
            EmojiConstants.Hamster,
            EmojiConstants.Rabbit,
            EmojiConstants.Parrot
        ],
        ["School"] = [
            EmojiConstants.Books,
            EmojiConstants.OpenBook,
            EmojiConstants.Pencil,
            EmojiConstants.Memo,
            EmojiConstants.Backpack,
            EmojiConstants.Notebook,
            EmojiConstants.Pen,
            EmojiConstants.Ruler,
            EmojiConstants.Microscope,
            EmojiConstants.Art,
            EmojiConstants.Music,
            EmojiConstants.Laptop
        ],
        ["Outdoor"] = [
            EmojiConstants.Seedling,
            EmojiConstants.Sunflower,
            EmojiConstants.Tree,
            EmojiConstants.FallenLeaf,
            EmojiConstants.Leaf,
            EmojiConstants.Car,
            EmojiConstants.Bicycle,
            EmojiConstants.Soccer,
            EmojiConstants.Basketball,
            EmojiConstants.Tennis,
            EmojiConstants.Running,
            EmojiConstants.Walking
        ],
        ["Health"] = [
            EmojiConstants.Tooth,
            EmojiConstants.Pill,
            EmojiConstants.Bandage,
            EmojiConstants.Sleeping,
            EmojiConstants.PersonInBed,
            EmojiConstants.Muscle,
            EmojiConstants.Weightlifter,
            EmojiConstants.Droplet,
            EmojiConstants.Apple,
            EmojiConstants.Lotion,
            EmojiConstants.Tap,
            EmojiConstants.Yoga
        ],
        ["Fun"] = [
            EmojiConstants.VideoGame,
            EmojiConstants.Television,
            EmojiConstants.Movie,
            EmojiConstants.Dice,
            EmojiConstants.Puzzle,
            EmojiConstants.Art,
            EmojiConstants.Theater,
            EmojiConstants.Circus,
            EmojiConstants.Star,
            EmojiConstants.GlowingStar,
            EmojiConstants.Party,
            EmojiConstants.Balloon
        ]
    };
    
    // Emoji names for tooltips
    private static readonly Dictionary<string, string> EmojiNames = new()
    {
        [EmojiConstants.Bed] = "Bed - Make bed",
        [EmojiConstants.Tooth] = "Tooth - Brush teeth",
        [EmojiConstants.Dog] = "Dog - Walk dog",
        [EmojiConstants.Plate] = "Dishes - Set table",
        [EmojiConstants.Broom] = "Broom - Sweep",
        [EmojiConstants.Trash] = "Trash - Take out trash",
        [EmojiConstants.Books] = "Books - Reading/Homework",
        [EmojiConstants.Backpack] = "Backpack - Pack bag",
        [EmojiConstants.TShirt] = "Shirt - Laundry",
        [EmojiConstants.Shower] = "Shower - Take shower",
        [EmojiConstants.Seedling] = "Plant - Water plants",
        [EmojiConstants.CatFace] = "Cat - Feed cat",
        [EmojiConstants.Cooking] = "Cooking - Help cook",
        [EmojiConstants.Soap] = "Soap - Wash dishes",
        [EmojiConstants.Memo] = "Notes - Homework",
        [EmojiConstants.Sparkles] = "Sparkle - Clean room"
    };
    
    private void TogglePicker()
    {
        _showPicker = !_showPicker;
    }
    
    private void ClosePicker()
    {
        _showPicker = false;
    }
    
    private async Task SelectEmoji(string emoji)
    {
        Value = emoji;
        await ValueChanged.InvokeAsync(emoji);
        _showPicker = false;
    }
    
    private async Task ClearEmoji()
    {
        Value = null;
        await ValueChanged.InvokeAsync(null);
        _showPicker = false;
    }
    
    private static string GetEmojiName(string emoji)
    {
        return EmojiNames.TryGetValue(emoji, out var name) ? name : emoji;
    }
}
