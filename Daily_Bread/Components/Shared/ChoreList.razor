@using Daily_Bread.Data.Models

<div class="chore-list">
    @if (Chores == null || Chores.Count == 0)
    {
        <div class="alert alert-info">
            <p class="mb-0">No chores defined yet. Click <strong>Add Chore</strong> to create your first chore.</p>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        @if (EnableReorder)
                        {
                            <th class="drag-handle-header" style="width: 40px;"></th>
                        }
                        <th>Name</th>
                        <th>Assigned To</th>
                        <th>Value</th>
                        <th>Schedule</th>
                        <th>Status</th>
                        <th style="width: 200px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var chore in Chores)
                    {
                        var isBeingDragged = _draggedChore?.Id == chore.Id;
                        var isDropTarget = _dropTargetChore?.Id == chore.Id && !isBeingDragged;
                        
                        <tr class="@GetRowClass(chore, isBeingDragged, isDropTarget)"
                            draggable="@(EnableReorder ? "true" : "false")"
                            @ondragstart="() => HandleDragStart(chore)"
                            @ondragend="HandleDragEnd"
                            @ondragover="() => HandleDragOver(chore)"
                            @ondragover:preventDefault="@EnableReorder"
                            @ondrop="() => HandleDrop(chore)"
                            @ondrop:preventDefault="@EnableReorder">
                            @if (EnableReorder)
                            {
                                <td class="drag-handle-cell">
                                    <span class="drag-handle" title="Drag to reorder">
                                        <span class="bi bi-grip-vertical"></span>
                                    </span>
                                </td>
                            }
                            <td>
                                <strong class="chore-name">@chore.Name</strong>
                                @if (chore.AutoApprove)
                                {
                                    <span class="badge bg-info ms-2" title="Auto-approved when completed">Auto</span>
                                }
                                @if (chore.ScheduleType == ChoreScheduleType.WeeklyFrequency)
                                {
                                    <span class="badge bg-primary ms-1" title="Complete @chore.WeeklyTargetCount times per week">@(chore.WeeklyTargetCount)x/wk</span>
                                }
                                @if (!string.IsNullOrEmpty(chore.Description))
                                {
                                    <br />
                                    <small>@chore.Description</small>
                                }
                            </td>
                            <td>
                                @if (chore.AssignedUser != null)
                                {
                                    <span class="user-name">@chore.AssignedUser.UserName</span>
                                }
                                else
                                {
                                    <span class="text-muted">Unassigned</span>
                                }
                            </td>
                            <td>
                                <span class="value-badge">$@chore.EarnValue.ToString("F2")</span>
                            </td>
                            <td>
                                <small>@FormatSchedule(chore)</small>
                            </td>
                            <td>
                                @if (chore.IsActive)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn action-btn outline-edit" 
                                            @onclick="() => OnEdit.InvokeAsync(chore)"
                                            title="Edit">
                                        Edit
                                    </button>
                                    <button class="btn action-btn @(chore.IsActive ? "pause" : "approve")"
                                            @onclick="() => OnToggleActive.InvokeAsync(chore)"
                                            title="@(chore.IsActive ? "Deactivate" : "Activate")">
                                        @(chore.IsActive ? "Pause" : "Start")
                                    </button>
                                    <button class="btn action-btn delete"
                                            @onclick="() => OnDelete.InvokeAsync(chore)"
                                            title="Delete">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    [Parameter]
    public List<ChoreDefinition> Chores { get; set; } = [];

    [Parameter]
    public EventCallback<ChoreDefinition> OnEdit { get; set; }

    [Parameter]
    public EventCallback<ChoreDefinition> OnDelete { get; set; }

    [Parameter]
    public EventCallback<ChoreDefinition> OnToggleActive { get; set; }

    /// <summary>
    /// Enable drag-and-drop reordering. When true, shows drag handles.
    /// </summary>
    [Parameter]
    public bool EnableReorder { get; set; } = true;

    /// <summary>
    /// Called when chores are reordered via drag-and-drop.
    /// Returns list of (ChoreId, NewSortOrder) tuples.
    /// </summary>
    [Parameter]
    public EventCallback<List<(int ChoreId, int SortOrder)>> OnReorder { get; set; }

    private ChoreDefinition? _draggedChore;
    private ChoreDefinition? _dropTargetChore;

    private string GetRowClass(ChoreDefinition chore, bool isBeingDragged, bool isDropTarget)
    {
        var classes = new List<string>();
        
        if (!chore.IsActive)
            classes.Add("table-secondary");
        
        if (isBeingDragged)
            classes.Add("dragging");
        
        if (isDropTarget)
            classes.Add("drop-target");
        
        return string.Join(" ", classes);
    }

    private void HandleDragStart(ChoreDefinition chore)
    {
        if (!EnableReorder) return;
        _draggedChore = chore;
    }

    private void HandleDragEnd()
    {
        _draggedChore = null;
        _dropTargetChore = null;
    }

    private void HandleDragOver(ChoreDefinition chore)
    {
        if (!EnableReorder || _draggedChore == null || _draggedChore.Id == chore.Id) return;
        _dropTargetChore = chore;
    }

    private async Task HandleDrop(ChoreDefinition targetChore)
    {
        if (!EnableReorder || _draggedChore == null || _draggedChore.Id == targetChore.Id)
        {
            HandleDragEnd();
            return;
        }

        // Calculate new sort orders
        var updates = CalculateNewSortOrders(_draggedChore, targetChore);
        
        HandleDragEnd();
        
        if (updates.Count > 0)
        {
            await OnReorder.InvokeAsync(updates);
        }
    }

    private List<(int ChoreId, int SortOrder)> CalculateNewSortOrders(ChoreDefinition draggedChore, ChoreDefinition targetChore)
    {
        var updates = new List<(int ChoreId, int SortOrder)>();
        
        var choreList = Chores.ToList();
        var draggedIndex = choreList.FindIndex(c => c.Id == draggedChore.Id);
        var targetIndex = choreList.FindIndex(c => c.Id == targetChore.Id);
        
        if (draggedIndex == -1 || targetIndex == -1 || draggedIndex == targetIndex)
            return updates;

        // Remove from old position and insert at new position
        choreList.RemoveAt(draggedIndex);
        choreList.Insert(targetIndex, draggedChore);

        // Assign new sort orders (multiply by 10 to leave gaps for future insertions)
        for (int i = 0; i < choreList.Count; i++)
        {
            var newSortOrder = (i + 1) * 10;
            if (choreList[i].SortOrder != newSortOrder)
            {
                updates.Add((choreList[i].Id, newSortOrder));
            }
        }

        return updates;
    }

    private string FormatSchedule(ChoreDefinition chore)
    {
        string scheduleText;
        
        if (chore.ScheduleType == ChoreScheduleType.WeeklyFrequency)
        {
            var daysText = chore.ActiveDays == DaysOfWeek.All 
                ? "any day" 
                : $"on {FormatDays(chore.ActiveDays)}";
            scheduleText = $"{chore.WeeklyTargetCount}x/week, {daysText}";
        }
        else
        {
            scheduleText = FormatDays(chore.ActiveDays);
        }
        
        var dateRange = FormatDateRange(chore.StartDate, chore.EndDate);
        if (!string.IsNullOrEmpty(dateRange))
        {
            return $"{scheduleText} ({dateRange})";
        }
        return scheduleText;
    }

    private string FormatDays(DaysOfWeek days)
    {
        if (days == DaysOfWeek.All) return "Every day";
        if (days == DaysOfWeek.Weekdays) return "Weekdays";
        if (days == DaysOfWeek.Weekends) return "Weekends";
        if (days == DaysOfWeek.None) return "Never";

        var dayNames = new List<string>();
        if (days.HasFlag(DaysOfWeek.Sunday)) dayNames.Add("Sun");
        if (days.HasFlag(DaysOfWeek.Monday)) dayNames.Add("Mon");
        if (days.HasFlag(DaysOfWeek.Tuesday)) dayNames.Add("Tue");
        if (days.HasFlag(DaysOfWeek.Wednesday)) dayNames.Add("Wed");
        if (days.HasFlag(DaysOfWeek.Thursday)) dayNames.Add("Thu");
        if (days.HasFlag(DaysOfWeek.Friday)) dayNames.Add("Fri");
        if (days.HasFlag(DaysOfWeek.Saturday)) dayNames.Add("Sat");

        return string.Join(", ", dayNames);
    }

    private string? FormatDateRange(DateOnly? start, DateOnly? end)
    {
        if (start.HasValue && end.HasValue)
        {
            return $"{start.Value:MMM d} - {end.Value:MMM d}";
        }
        if (start.HasValue)
        {
            return $"From {start.Value:MMM d}";
        }
        if (end.HasValue)
        {
            return $"Until {end.Value:MMM d}";
        }
        return null;
    }
}
